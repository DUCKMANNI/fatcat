<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{shopping/layout}">
<head>
<meta charset="UTF-8">
<title>주문확인</title>
</head>
<body>
	<div layout:fragment="shopContent" class="container my-3">

		<!-- 주문 확인 + 결제 폼 -->
		<form th:action="@{/orders/confirm}" method="post"
			th:object="${orderForm}">

			<!-- 주문 상품 목록 -->
			<div class="card mb-4">
				<div class="card-body">
					<h5 class="card-title">주문 상품</h5>
					<table class="table align-middle">
						<thead>
							<tr>
								<th>상품</th>
								<th class="text-center">수량</th>
								<th class="text-end">금액</th>
							</tr>
						</thead>
						<tbody>
							<tr th:each="item : ${orderDTO.items}">
								<td>
									<div class="d-flex align-items-center">
										<img th:src="${item.imageUrl}" class="me-3"
											style="width: 60px;"> <span
											th:text="${item.productName}"></span>
									</div>
								</td>
								<td class="text-center" th:text="${item.quantity}"></td>
								<td class="text-end fw-bold"
									th:text="${#numbers.formatInteger(item.price, 3, 'COMMA')} + '원'"></td>
							</tr>
						</tbody>
					</table>
				</div>
			</div>

			<!-- 주문자 정보 -->
			<div class="card mb-4">
				<div class="card-body">
					<h5 class="card-title">구매자 정보</h5>
					<p>
						이름: <span th:text="${orderDTO.userName}"></span>
					</p>
					<p>
						이메일: <span th:text="${orderDTO.userEmail}"></span>
					</p>
					<p>
						연락처: <span th:text="${orderDTO.userPhone}"></span>
					</p>
					<input type="hidden" th:field="*{latitude}"> <input
						type="hidden" th:field="*{longitude}"> <input
						type="hidden" th:field="*{cartSeq}">
				</div>
			</div>

			<!-- 배송 정보 -->
			<div class="card mb-4">
				<div class="card-body">
					<h5 class="card-title">받는 사람 정보</h5>

					<div class="mb-3">
						<div class="form-check  ps-0">
							<input type="checkbox" id="sameAsBuyer"
								onchange="toggleReceiverInfo(this)"> <label
								class="form-check-label" for="sameAsBuyer"> 구매자 정보 동일 </label>
						</div>
					</div>

					<div class="mb-2">
						<label class="form-label">수령인</label> <input type="text"
							class="form-control" id="receiverName" th:field="*{receiverName}"
							placeholder="이름 입력">
					</div>

					<div class="mb-2">
						<label class="form-label">휴대폰</label> <input type="text"
							class="form-control" id="receiverPhone"
							th:field="*{receiverPhone}" placeholder="010-0000-0000">
					</div>

					<div class="mb-2 row">
						<div class="col-6">
							<label class="form-label">우편번호</label> 
							<input type="text" class="form-control" id="receiverZipcode" name="receiverZipcode"
								th:field="*{receiverZipcode}" placeholder="우편번호">
						</div>
						<div class="col-6 d-flex align-items-end">
							<button type="button" onclick="execDaumPostcode()" class="btn btn-outline-brown w-100">우편번호 찾기</button>
						</div>
						
						<input type="hidden" id="latitude" name="latitude">
		      			<input type="hidden" id="longitude" name="longitude">
					</div>

					<div class="mb-2">
						<label class="form-label">주소</label> <input type="text"
							class="form-control" id="receiverAddress"
							th:field="*{receiverAddress}" placeholder="기본 주소">
					</div>

					<div class="mb-2">
						<label class="form-label">상세주소</label> <input type="text"
							class="form-control" id="receiverDetail"
							th:field="*{receiverDetail}" placeholder="상세 주소">
					</div>

					<div class="mb-2">
						<label class="form-label">배송 요청사항</label> <input type="text"
							class="form-control" th:field="*{orderRequest}"
							placeholder="예) 부재시 경비실에 맡겨주세요.">
					</div>
				</div>
			</div>

			<!-- 쿠폰 / 할인 -->
			<div class="card mb-4">
				<div class="card-body">
					<h5 class="card-title">쿠폰 / 할인</h5>
					<select class="form-select">
						<option value="">사용할 쿠폰 선택</option>
						<option th:each="coupon : ${userCoupons}" th:value="${coupon.id}"
							th:text="${coupon.name + ' - ' + coupon.discount + '원'}">
						</option>
					</select>
				</div>
			</div>

			<!-- 결제 정보 -->
			<div class="card mb-4">
				<div class="card-body">
					<h5 class="card-title">결제 정보</h5>
					<p>
						상품금액: <span th:text="${#numbers.formatInteger(cartSummary.totalPrice, 3, 'COMMA')} + '원'"></span>
					</p>
					<p>
						할인금액: <span th:text="${cartSummary.discount == 0 ? '0원' : #numbers.formatInteger(cartSummary.discount, 3, 'COMMA') + '원'}"></span>
					</p>
					<p>
						배송비: <span th:text="${cartSummary.deliveryFee == 0 ? '0원' : #numbers.formatInteger(cartSummary.deliveryFee, 3, 'COMMA') + '원'}"></span>
					</p>
					<hr>
					<p class="fw-bold fs-5">
						총 결제금액: <span class="text-danger"
							th:text="${#numbers.formatInteger(cartSummary.finalPrice, 3, 'COMMA')} + '원'"></span>
					</p>
				</div>
			</div>

			<!-- 결제 버튼 -->
			<div class="text-center">
				<button type="submit" class="btn btn-danger btn-lg px-5" style="border-radius:999px;">결제하기</button>
			</div>

		</form>
	</div>

	<th:block layout:fragment="script">
	<script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
	<!-- 카카오 지도 API (좌표 변환용) -->
	<script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=94d1c331dbd40471d2fb9d113ba5d78b&libraries=services"></script>
	<script th:inline="javascript">
/*<![CDATA[*/
const buyerInfo = {
    name: /*[[${orderDTO.userName}]]*/ '',
    phone: /*[[${orderDTO.userPhone}]]*/ '',
    zipcode: /*[[${orderDTO.orderZipcode}]]*/ '',
    address1: /*[[${orderDTO.orderAddress1}]]*/ '',
    address2: /*[[${orderDTO.orderAddress2}]]*/ '',
    latitude : /*[[${orderDTO.latitude}]]*/ '',
    longitude : /*[[${orderDTO.longitude}]]*/ ''
};

function toggleReceiverInfo(checkbox) {
  if (checkbox.checked) {
    document.getElementById("receiverName").value = buyerInfo.name;
    document.getElementById("receiverPhone").value = buyerInfo.phone;
    document.getElementById("receiverZipcode").value = buyerInfo.zipcode;
    document.getElementById("receiverAddress").value = buyerInfo.address1;
    document.getElementById("receiverDetail").value = buyerInfo.address2;

    document.querySelectorAll("#receiverName, #receiverPhone, #receiverZipcode, #receiverAddress, #receiverDetail")
      .forEach(el => el.readOnly = true);
  } else {
    document.querySelectorAll("#receiverName, #receiverPhone, #receiverZipcode, #receiverAddress, #receiverDetail")
      .forEach(el => {
        el.value = '';
        el.readOnly = false;
      });
  }
}

function execDaumPostcode() {
	console.log("execDaumPostcode 실행됨 ✅");
	  new daum.Postcode({

	    oncomplete: function(data) {
	    	
	    	console.log("oncomplete 실행됨 ✅", data);
	      // ✅ 기본주소 & 우편번호 채우기
	      document.getElementById('receiverAddress').value = data.roadAddress;
	      document.getElementById('receiverZipcode').value = data.zonecode;
	      
	      console.log("도로명주소:", data.roadAddress);

	      try {
	        // ✅ 좌표 변환 (에러 나도 팝업은 닫히게)
	        var geocoder = new kakao.maps.services.Geocoder();
	        geocoder.addressSearch(data.roadAddress, function(result, status) {
	        	console.log("status:", status, "result:", result);
	          if (status === kakao.maps.services.Status.OK) {
	        	  console.log("변환 성공:", result[0]);
	            document.getElementById('latitude').value = result[0].y;
	            document.getElementById('longitude').value = result[0].x;
	          }
	        });
	      } catch (e) {
	        console.error("Geocoder 에러:", e);
	      }
	    } 
	  }).open(); // 👉 팝업으로 열기
	}
/*]]>*/
</script>
</th:block>


</body>
</html>
