<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="utf-8">
<title>1:1 채팅</title>
<style>
body {
	font-family: Arial, sans-serif;
	margin: 0;
	padding: 0;
	display: flex;
	flex-direction: column;
	height: 100vh;
}

#chat-container {
	flex-grow: 1;
	display: flex;
	flex-direction: column;
	border: 1px solid #ddd;
	margin: 10px;
	border-radius: 8px;
	overflow: hidden;
}

#message-area {
	flex-grow: 1;
	padding: 10px;
	overflow-y: auto;
	background-color: #f7f7f7;
}

.message {
	margin-bottom: 10px;
	padding: 8px 12px;
	border-radius: 18px;
	max-width: 80%;
}

.sent {
	background-color: #dcf8c6;
	align-self: flex-end;
	float: right;
	clear: both;
}

.received {
	background-color: #fff;
	align-self: flex-start;
	float: left;
	clear: both;
}

#input-area {
	display: flex;
	padding: 10px;
	border-top: 1px solid #ddd;
}

#message-input {
	flex-grow: 1;
	padding: 8px;
	border-radius: 20px;
	border: 1px solid #ccc;
	outline: none;
}

#send-button {
	margin-left: 10px;
	padding: 8px 16px;
	border: none;
	background-color: #CD853F;
	color: white;
	border-radius: 20px;
	cursor: pointer;
}
</style>
<script
	src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script
	src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
</head>
<body>
	<div id="chat-container">
		<div id="message-area"></div>
		<div id="input-area">
			<input type="text" id="message-input" placeholder="메시지를 입력하세요...">
			<button id="send-button">전송</button>
		</div>
	</div>

	<script th:inline="javascript">
    const chatRoomId = /*[[${chatRoomId}]]*/ 0; /* [[..]] 이거 사용하면 thymeleaf랑 자바스크립트 코드 동시 사용 가능 /0은 문법상 못알아들어서 저렇게 처리하면 가능하다고 하네여.. */
    const senderId = /*[[${senderId}]]*/ 0;
    const receiverId = /*[[${receiverId}]]*/ 0;
    
    let stompClient = null;
    const messageArea = document.getElementById('message-area');
    const messageInput = document.getElementById('message-input');
    const sendButton = document.getElementById('send-button');

    window.onload = function() {
        fetch(`/api/chat/history?roomId=${chatRoomId}`)
            .then(response => response.json())
            .then(messages => {
                messages.forEach(msg => displayMessage(msg));
            })
            .catch(error => console.error('Error fetching chat history:', error));

        connectWebSocket();
    };

    function connectWebSocket() {
        const socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);
        stompClient.connect({}, onConnected, onError);
    }

    function onConnected() {
        stompClient.subscribe('/user/' + senderId + '/private', onMessageReceived);
        stompClient.subscribe('/user/' + receiverId + '/private', onMessageReceived);
    }

    function onError(error) {
        console.error('WebSocket connection error:', error);
    }

    function sendMessage() {
        const content = messageInput.value.trim();
        if (content && stompClient) {
            const chatMessageDto = {
                chatRoomId: chatRoomId,
                senderId: senderId,
                receiverId: receiverId,
                content: content
            };

            // 1. 메시지를 웹소켓으로 전송
            stompClient.send('/app/private-chat', {}, JSON.stringify(chatMessageDto));

            // 2. 전송과 동시에 내 화면에 메시지를 즉시 표시
            displayMessage(chatMessageDto);

            // 3. 입력창 비우기
            messageInput.value = '';
        }
    }

    function onMessageReceived(payload) {
        const message = JSON.parse(payload.body);
        
     
        //    받는 메시지(received)만 화면에 표시
        if (message.senderId !== senderId) {
            displayMessage(message);
        }
    }

    function displayMessage(message) {
        const messageElement = document.createElement('div');
        messageElement.classList.add('message');
        
        if (message.senderId === senderId) {
            messageElement.classList.add('sent');
        } else {
            messageElement.classList.add('received');
        }
        
        messageElement.innerHTML = `<p>${message.content}</p>`;
        messageArea.appendChild(messageElement);
        messageArea.scrollTop = messageArea.scrollHeight;
    }

    sendButton.addEventListener('click', sendMessage);
    messageInput.addEventListener('keydown', (event) => {
        if (event.key === 'Enter') {
            sendMessage();
        }
    });
</script>
</body>
</html>