<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="utf-8">
<title>ìµœì¢… ìˆ˜ì •ë³¸: 1:1 ì±„íŒ… + CareSession + ë¦¬ë·° + UI ê°œì„  (ë‚ ì§œ êµ¬ë¶„ì„  í¬í•¨)</title>
<style>
.profile-image {
	margin-top: 5px; /* ë‹‰ë„¤ì„ê³¼ì˜ ê°„ê²© ì¡°ì ˆ (ì„ íƒ ì‚¬í•­) */
	width: 40px; /* í¬ê¸° ì¡°ì ˆ */
	height: 40px; /* í¬ê¸° ì¡°ì ˆ */
	border-radius: 50%; /* ì›í˜• */
	margin-right: 8px; /* ë©”ì‹œì§€ ë²„ë¸”ê³¼ì˜ ê°„ê²© */
	align-self: flex-start; /* ë©”ì‹œì§€ rowì˜ ì‹œì‘ì ì— ì •ë ¬ */
	flex-shrink: 0;
	object-fit: cover; /* ì´ë¯¸ì§€ê°€ ì˜ë¦¬ì§€ ì•Šê³  ê½‰ ì°¨ê²Œ */
	border: 1px solid #eee; /* í…Œë‘ë¦¬ (ì„ íƒ ì‚¬í•­) */
	cursor: pointer;
}

/* ë‹‰ë„¤ì„ê³¼ ì´ë¯¸ì§€ê°€ ì •ë ¬ë˜ë„ë¡ ë°›ì€ ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ ì¡°ì • (ì„ íƒ ì‚¬í•­) */
.message-row.received {
    /* ê¸°ì¡´: justify-content: flex-start; */
	align-items: flex-start; /* ë‹‰ë„¤ì„ê³¼ ì´ë¯¸ì§€ë¥¼ ë§¨ ìœ„ì— ì •ë ¬ */
}



.sent .message.tail::after {
    content: '';
    position: absolute;
    bottom: 0; /* ë©”ì‹œì§€ ë°•ìŠ¤ í•˜ë‹¨ì— ìœ„ì¹˜ */
    right: -7px; /* ë©”ì‹œì§€ ë°•ìŠ¤ ë°”ê¹¥ìª½ ì˜¤ë¥¸ìª½ìœ¼ë¡œ ë¹¼ëƒ…ë‹ˆë‹¤. */
    width: 0;
    height: 0;
    z-index: 1;
    
    /* ê¼¬ë¦¬ ì‚¼ê°í˜• ëª¨ì–‘ ë§Œë“¤ê¸° */
    border: 9px solid transparent; /* ê¼¬ë¦¬ í¬ê¸° ì¡°ì ˆ */
    border-radius : 2px;
    border-left-color: #ebdecd; /* ê¼¬ë¦¬ê°€ ë©”ì‹œì§€ ë°°ê²½ìƒ‰ê³¼ ë™ì¼í•˜ê²Œ ë³´ì…ë‹ˆë‹¤. */
    border-bottom-color: #ebdecd;
    
      
    /* ê¼¬ë¦¬ë¥¼ ë‘¥ê¸€ê³  íœ˜ì–´ì§€ê²Œ ë§Œë“œëŠ” í•µì‹¬ ì†ì„± */
    border-bottom-right-radius: 30px; /* ê¼¬ë¦¬ì˜ ëì„ ë‘¥ê¸€ê²Œ */
    border-bottom-left-radius: 80%; /* ê¼¬ë¦¬ì˜ ëª¸í†µ ë¶€ë¶„ì„ ê³¡ì„ ìœ¼ë¡œ ë§Œë“¦ */
    
    /* ê¼¬ë¦¬ê°€ ë¾°ì¡±í•œ ì‚¼ê°í˜•ì´ ì•„ë‹Œ ë‘¥ê·¼ ëª¨ì–‘ì²˜ëŸ¼ ë³´ì´ë„ë¡ íšŒì „ */
    transform: rotate(6deg); /* ì›í•˜ëŠ” ë§Œí¼ íšŒì „í•˜ì—¬ íœ˜ì–´ì§ ì •ë„ ì¡°ì • */
    
   
}


/* ---------------------------------------------------------------------------------- */
/* 2. ë°›ì€ ë©”ì‹œì§€ (ì™¼ìª½ ì•„ë˜ ê¼¬ë¦¬) */
/* ---------------------------------------------------------------------------------- */
.received .message.tail::after {
    content: '';
    position: absolute;
    bottom: 0; /* ë©”ì‹œì§€ ë°•ìŠ¤ í•˜ë‹¨ì— ìœ„ì¹˜ */
    left: -10px; /* ë©”ì‹œì§€ ë°•ìŠ¤ ë°”ê¹¥ìª½ ì˜¤ë¥¸ìª½ìœ¼ë¡œ ë¹¼ëƒ…ë‹ˆë‹¤. */
    width: 0;
    height: 0;
    z-index: 1;
    
    /* ê¼¬ë¦¬ ì‚¼ê°í˜• ëª¨ì–‘ ë§Œë“¤ê¸° */
    border: 9px solid transparent; /* ê¼¬ë¦¬ í¬ê¸° ì¡°ì ˆ */
    border-radius : 2px;
    border-left-color: #ffffff; /* ê¼¬ë¦¬ê°€ ë©”ì‹œì§€ ë°°ê²½ìƒ‰ê³¼ ë™ì¼í•˜ê²Œ ë³´ì…ë‹ˆë‹¤. */
    border-bottom-color: #ffffff;
    
      
    /* ê¼¬ë¦¬ë¥¼ ë‘¥ê¸€ê³  íœ˜ì–´ì§€ê²Œ ë§Œë“œëŠ” í•µì‹¬ ì†ì„± */
    border-bottom-right-radius: 30px; /* ê¼¬ë¦¬ì˜ ëì„ ë‘¥ê¸€ê²Œ */
    border-bottom-left-radius: 80%; /* ê¼¬ë¦¬ì˜ ëª¸í†µ ë¶€ë¶„ì„ ê³¡ì„ ìœ¼ë¡œ ë§Œë“¦ */
    
    /* ê¼¬ë¦¬ê°€ ë¾°ì¡±í•œ ì‚¼ê°í˜•ì´ ì•„ë‹Œ ë‘¥ê·¼ ëª¨ì–‘ì²˜ëŸ¼ ë³´ì´ë„ë¡ íšŒì „ */
    transform:rotateY(186deg); /* ì›í•˜ëŠ” ë§Œí¼ íšŒì „í•˜ì—¬ íœ˜ì–´ì§ ì •ë„ ì¡°ì • */
    
}
/* ---------------------------------------------------------------------------------- */
/* 1. ê¸°ë³¸ ì±„íŒ… UI ìŠ¤íƒ€ì¼ */
/* ---------------------------------------------------------------------------------- */

@font-face {
	font-family: 'Juache';
	src:
		url('https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_one@1.0/BMJUA.woff')
		format('woff');
	font-weight: normal;
	font-display: swap;
}


body {
	
	font-family: 'Juache', sans-serif; 
	font-size:16px;
	margin: 0;
	padding: 0;
	display: flex;
	flex-direction: column;
	height: 100vh;
}

#user-select {
	display: flex;
	justify-content: center;
	gap: 15px;
	padding: 10px;
	border-bottom: 1px solid #ddd;
	background: #fafafa;
}

/* ê¸°ë³¸ ì…ë ¥ í•„ë“œ ìŠ¤íƒ€ì¼ ë° í°íŠ¸ ì ìš© */
select, input, textarea {
	font-family: 'Juache', sans-serif;
	font-size:16px;
	padding: 5px 10px;
	border-radius: 6px;
	border: 1px solid #ccc;
}

/* ---------------------------------------------------------------------------------- */
/* í”Œë ˆì´ìŠ¤í™€ë” í°íŠ¸ ì ìš© */
/* ---------------------------------------------------------------------------------- */
#message-input::placeholder,
#session-note::placeholder,
input::placeholder,
textarea::placeholder {
    font-family: 'Juache', sans-serif !important;
}

::-webkit-input-placeholder { /* Chrome, Safari */
    font-family: 'Juache', sans-serif !important;
}
:-moz-placeholder { /* Firefox 18- */
    font-family: 'Juache', sans-serif !important;
}
::-moz-placeholder { /* Firefox 19+ */
    font-family: 'Juache', sans-serif !important;
}
:-ms-input-placeholder { /* IE */
    font-family: 'Juache', sans-serif !important;
}
/* ---------------------------------------------------------------------------------- */


#chat-container {
	flex-grow: 1;
	display: flex;
	flex-direction: column;
	border: 1px solid #ddd;
	margin: 10px;
	border-radius: 8px;
	overflow: hidden;
	position: relative;
}

#message-area {
	flex-grow: 1;
	padding: 10px;
	overflow-y: auto;
	background: #f7f7f7;
	display: flex;
	flex-direction: column;
	
}

/* âœ¨ ë‚ ì§œ êµ¬ë¶„ì„  ìŠ¤íƒ€ì¼ âœ¨ */
.date-separator {
    text-align: center;
    margin: 15px 0; /* ìœ„ì•„ë˜ ê°„ê²© */
}

.date-separator span {
    font-size: 16px;
    color: #888;
    background: #e9e9e9; /* ì—°í•œ íšŒìƒ‰ ë°°ê²½ */
    padding: 4px 10px;
    border-radius: 12px; /* ë‘¥ê·¼ ëª¨ì–‘ */
    font-weight: 500;
    font-family: 'Juache', sans-serif;
    display: inline-block; /* ë°°ê²½ì´ í…ìŠ¤íŠ¸ í¬ê¸°ë§Œí¼ë§Œ ì±„ì›Œì§€ë„ë¡ */
}
/* âœ¨ ë‚ ì§œ êµ¬ë¶„ì„  ìŠ¤íƒ€ì¼ ë âœ¨ */


.message-row {
	display: flex;
	margin-bottom: 10px;
	align-items: flex-end;
}

.message-row.sent {
	justify-content: flex-end;
}

.message-row.received {
	justify-content: flex-start;
}

.profile-placeholder {
	margin-top: 15px;
	width: 50px;
	height: 50px;
	border-radius: 50%;
	background-color: #ccc;
	margin-right: 10px;
	align-self: flex-start;
	flex-shrink: 0;
	cursor: pointer;
	
}

.message-content-wrapper {
	display: flex;
	flex-direction: column;
	max-width: 70%;
}

.message-row.sent .message-content-wrapper {
	align-items: flex-end;
}

.message-row.received .message-content-wrapper {
	align-items: flex-start;
}

.user-nickname {
	font-size: 15px;
	color: #555;
	margin-bottom: 4px;
	cursor: pointer;
}

.message-row.sent .user-nickname {
	display: none;
}

.sent .message {
	background: #ebdecd;
	
}
.message {
	padding: 8px 12px;
	border-radius: 18px;
	max-width: 100%;
	word-wrap: break-word;
	position: relative;
}



.received .message {
	background: #fff;
}

.message-time {
	font-size: 13px;
	color: #555;
	margin-top: 2px;
	align-self: flex-end;
	white-space: nowrap;
}

.message-row.received .message-time {
	align-self: flex-start;
}

.care-request {
	padding: 0;
}

.care-request-card {
	border-radius:20px;
	background-color:#fff3b0;
    font-size: 16px;
    line-height: 1.4;
    padding : 15px 10px;
}

.card-header {
    display: flex;
    align-items: center;
    padding-bottom: 8px;
    margin-bottom: 10px;
    border-bottom: 1px solid #eeeeee; /* êµ¬ë¶„ì„  */
}

.header-icon {
    font-size: 1.2em;
    margin-right: 6px;
}

.header-title {
    font-weight: 700;
    font-size: 1.1em;
    color: #333333;
}

.detail-row {
    display: flex;
    margin-bottom: 6px; /* ì¤„ ê°„ê²© */
    align-items: flex-start;
}

.detail-icon {
    color: #888; /* ì•„ì´ì½˜ ìƒ‰ìƒ */
    margin-right: 8px;
    padding-top: 2px;
}

.label {
    font-weight: 600;
    color: #555;
    display: inline-block;
    min-width: 40px; /* ë¼ë²¨ ë„ˆë¹„ ê³ ì •ìœ¼ë¡œ ì •ë ¬ ë§ì¶¤ */
}

/* -----------------------------------
   3. Footer ë° ìƒíƒœ/ë²„íŠ¼ ìŠ¤íƒ€ì¼
   ----------------------------------- */
.card-footer {
    display: flex;
    justify-content: space-between; /* ìƒíƒœ í‘œì‹œì™€ ë²„íŠ¼ì„ ì–‘ ëìœ¼ë¡œ ë¶„ë¦¬ */
    align-items: center;
    margin-top: 10px;
    padding-top: 10px;
    border-top: 1px solid #555;
    
}

/* ìƒíƒœ í‘œì‹œ ë±ƒì§€ ìŠ¤íƒ€ì¼ */
.care-status {
    display: inline-block;
    padding: 3px 8px;
    border-radius: 12px; /* ë‘¥ê·¼ ë±ƒì§€ ëª¨ì–‘ */
    font-weight: 600 !important;
    font-size: 18px !important;
    white-space: nowrap;
}

/* í™•ì • ìƒíƒœ */
.care-status[style*="green"] { 
   /*  background-color: #e6f7e6; */
    color: #38761d !important; 
}

/* ì·¨ì†Œ ìƒíƒœ */
.care-status[style*="red"] { 
    /* background-color: #fceceb; */
    color: #cc0000 !important;
}

/* ë²„íŠ¼ ìŠ¤íƒ€ì¼ (í™•ì • ë²„íŠ¼) */
.confirm-btn {
    background-color: #4c8cff; /* ê¹”ë”í•œ íŒŒë€ìƒ‰ */
    color: white;
    border: none;
    padding: 6px 12px;
    border-radius: 999px;
    cursor: pointer;
    font-weight: 600;
    font-size: 0.9em;
    transition: background-color 0.2s;
}

.confirm-btn:hover {
    background-color: #3a75e0;
}

.care-confirmed {
	background: #8FBC8F;
	padding: 6px 10px;
	border-radius: 12px;
	margin-top: 4px;
}

.btn-darkbrown {
	font-size : 16px;
	font-family: 'Juache', sans-serif;
	padding: 6px 16px;
	border-radius: 999px;
	border: none;  
    color: white; 
    background-color: #9a7f5a;
    transition: all 0.3s ease;
    cursor : pointer;
}

.btn-darkbrown:hover {
    background-color: #524538;
	color: #fff;  
	border: none;  
}

#input-area {
	display: flex;
	padding: 10px;
	border-top: 1px solid #ddd;
	gap: 10px;
}

#message-input {
	flex-grow: 1;
	padding: 8px;
	border-radius: 20px;
	border: 1px solid #ccc;
	outline: none;
}

/* ë²„íŠ¼ì—ë„ í°íŠ¸, ì»¤ì„œ í¬ì¸í„° ì ìš© */
 #send-button{
 	font-family: 'Juache', sans-serif;
	background-color: #D2B48C;
	color: #fff;
	border-radius: 20px;
	padding: 6px 16px;
	border: none;
	font-weight: 500;
    cursor: pointer; /* ì»¤ì„œ í¬ì¸í„° ì¶”ê°€ */
} 


#send-button:hover{
	background-color: #a38b6a; /* hover ì‹œ ì¡°ê¸ˆ ì§„í•˜ê²Œ */
	color: #fff;
} 

/* ---------------------------------------------------------------------------------- */
/* 2. ëŒë´„ ìš”ì²­ í¼ (CARE FORM) ìŠ¤íƒ€ì¼: ë””ìì¸ ê°œì„  ë° ë¼ìš´ë“œ ê°’ ì ìš© */
/* ---------------------------------------------------------------------------------- */

#care-form {
    display: none; /* ê¸°ë³¸ì€ ìˆ¨ê¹€ */
    padding: 18px; 
    border: 1px solid #e0e0e0; 
    border-radius: 12px; 
    margin: 10px; 
    background-color: #f7f9fb; /* ë°°ê²½ ë°•ìŠ¤ */
    flex-wrap: wrap; 
    gap: 10px; 
    flex-direction: row; 
    font-size: 16px; 
    line-height: 1.4;
    border-top: 1px solid #ddd; 
}

/* JSë¡œ .active í´ë˜ìŠ¤ê°€ ë¶™ìœ¼ë©´ í¼ì´ ë³´ì…ë‹ˆë‹¤. */
#care-form.active {
    display: flex;
}

/* ê°œë³„ ì…ë ¥ ê·¸ë£¹ ìŠ¤íƒ€ì¼ */
.care-form-group {
    flex: 1 1 calc(50% - 5px); 
    display: flex;
    flex-direction: column; 
}

/* ë©”ëª¨, ë²„íŠ¼ ë“± ì „ì²´ ë„ˆë¹„ ìš”ì†Œ */
.care-form-group.full-width {
    flex: 1 1 100%; 
}

/* ë¼ë²¨ ìŠ¤íƒ€ì¼ */
#care-form label {
    font-weight: bold;
    color: #555;
    margin-bottom: 3px;
}


/* ì…ë ¥ í•„ë“œ (input, textarea) ê³µí†µ ìŠ¤íƒ€ì¼ - ë¼ìš´ë“œ ê°’ ì ìš© */
#care-form input[type="datetime-local"],
#care-form textarea {
    padding: 10px; 
    border: 1px solid #ccc;
    border-radius: 6px; 
    box-sizing: border-box; 
    margin-top: 4px; 
    width: 100%; 
    font-size: 16px;
    background-color: white; 
}

/* ë©”ëª¨ì¥ ì¤„ ìˆ˜ ì„¤ì • */
#care-form textarea {
    resize: vertical; 
}

/* ì˜ˆì•½ ì „ì†¡ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
#confirm-care {
	font-family: 'Juache', sans-serif;
	font-size :20px;
    width: 100%; 
    padding: 10px; 
    border: none;
    border-radius: 20px; 
    font-weight: bold;
    cursor: pointer; /* ì»¤ì„œ í¬ì¸í„° ìœ ì§€ */
    background-color: #D2B48C;
    color: #fff;
    transition: background-color 0.3s;
}

#confirm-care:hover {
	background-color: #a38b6a;
}

/* ë²„íŠ¼ ì»¨í…Œì´ë„ˆ ì •ë ¬ */
.button-container {
    display: flex;
    justify-content: flex-start;
}

/* ---------------------------------------------------------------------------------- */
/* 3. ë¦¬ë·° íŒì—… ìŠ¤íƒ€ì¼ */
/* ---------------------------------------------------------------------------------- */
#review-popup {
	position: absolute;
	top: 0;
	right: 0;
	width: 350px;
	height: 100%;
	background: white;
	box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1);
	z-index: 100;
	transform: translateX(100%);
	transition: transform 0.3s ease-in-out;
	display: flex;
	flex-direction: column;
	padding: 15px;
	box-sizing: border-box;
	border-left: 1px solid #ddd;
	overflow-y: auto;
}

#review-popup.show {
	transform: translateX(0);
}

.popup-header {
	display: flex;
	justify-content: space-between;
	align-items: center;
	margin-bottom: 15px;
}

.popup-header button {
	background: none;
	border: none;
	font-size: 20px;
	cursor: pointer;
}

#review-rating-summary {
	text-align: center;
	padding: 10px 0;
	border-bottom: 1px solid #eee;
	margin-bottom: 15px;
}

#review-rating-summary h3 {
	margin: 0;
	font-size: 1.5em;
}

#review-rating-summary p {
	margin: 5px 0 0;
	color: #666;
}

.star-rating {
	color: black;
	font-size: 1.2em;
}

/* [ìˆ˜ì •] ë¦¬ë·° ë“±ë¡ í¼ ìŠ¤íƒ€ì¼ - ë°°ê²½ ë°•ìŠ¤ ì¶”ê°€ */
#review-form-area {
    padding: 15px; 
    margin-bottom: 20px; 
    background-color: #f7f9fb; /* ì—°í•œ íšŒìƒ‰ ë°°ê²½ */
    border-radius: 12px; /* ë‘¥ê·¼ ëª¨ì„œë¦¬ */
    border-top: none; /* ê¸°ì¡´ border-top ì œê±° */
}

#review-form-area h4 {
	font-family: 'Juache', sans-serif;
	font-size:20px;
	margin-top: 0;
	margin-bottom: 15px; /* ì œëª© ì•„ë˜ ê°„ê²© ì¶”ê°€ */
}

#review-form-area textarea {
	/* [ìˆ˜ì •] ì…ë ¥ í•„ë“œ ë¼ìš´ë“œ ê°’ ì ìš© */
	border-radius: 6px; 
	width: 100%;
	margin-bottom: 10px;
	box-sizing: border-box;
	font-family: 'Juache', sans-serif; /* ëª…ì‹œì ìœ¼ë¡œ í°íŠ¸ ì ìš© */
}

.rating-input {
	margin-bottom: 10px;
}

.rating-input span {
	font-size: 1.5em;
	cursor: pointer;
	color: #ccc;
}

.rating-input span.active {
	color: gold;
}

#submit-review-btn {
	width: 100%;
	padding: 10px; /* ë²„íŠ¼ ë†’ì´ ì¦ê°€ */
	background: #D2B48C; 
	color: white;
	border: none;
	border-radius: 20px; 
	cursor: pointer; /* ì»¤ì„œ í¬ì¸í„° ì¶”ê°€ */
	font-weight: 500;
	font-family: 'Juache', sans-serif; 
	transition: background-color 0.3s;
}

#submit-review-btn:hover {
	background: #a38b6a;
}

/* ë¦¬ë·° ëª©ë¡ ìŠ¤íƒ€ì¼ */
#review-list {
	font-size:20px;
	flex-grow: 1;
	overflow-y: auto;
	padding-right: 5px;
}

.review-item {
	/* ë¦¬ë·° ë‚´ìš©ì—ë„ í°íŠ¸ ì ìš© */
	font-family: 'Juache', sans-serif;
	font-size:18px;
	padding: 10px 0;
	border-bottom: 1px dotted #ddd;
	position: relative;
}
/* ë¦¬ë·° ë‚´ìš© ë˜í¼ëŠ” í•­ìƒ í‘œì‹œ (ë‚´ìš© ìœ ì§€ ìš”ì²­ì— ë”°ë¼) */
.review-content-wrapper {
	display: block;
}

.review-item:last-child {
	border-bottom: none;
}

.review-header {
	display: flex;
	justify-content: space-between;
	color: #444;
	margin-bottom: 5px;
}

.review-body {
	font-size: 0.95em;
	color: #333;
	word-break: break-all;
}

.review-date {
	font-size: 0.8em;
	color: #999;
	margin-top: 5px;
	display: flex;
	justify-content: space-between;
	align-items: center;
}

/* 
.review-actions button {
	font-size: 0.75em;
	padding: 3px 6px;
	margin-left: 5px;
	border: 1px solid #ccc;
	border-radius: 999px;
	cursor: pointer; 
	background: #fff;
	font-family: 'Juache', sans-serif;
}
 
*/

/* .review-actions button.edit {
	color: #007bff;
	border-color: #007bff;
}

.review-actions button.delete {
	color: #dc3545;
	border-color: #dc3545;
} */

/* ---------------------------------------------------------------------------------- */
/* 4. ì¸ë¼ì¸ ë¦¬ë·° ìˆ˜ì • í¼ ìŠ¤íƒ€ì¼ (ì´ë¯¸ì§€ ë ˆì´ì•„ì›ƒì— ë§ê²Œ ì¡°ì •) */
/* ---------------------------------------------------------------------------------- */
.edit-inline-form {
	padding: 10px 0 0 0;
	margin-top: 0px;
	margin-bottom: 5px;
	width: 100%;
	box-sizing: border-box;
	display: none; /* ê¸°ë³¸ì ìœ¼ë¡œ ìˆ¨ê¹€ ì²˜ë¦¬ */
	font-family: 'Juache', sans-serif;
}
/* ìˆ˜ì • í¼ ë‚´ë¶€ì˜ ê²½ê³„ì„  ìŠ¤íƒ€ì¼ */
.edit-inline-form>div {
	margin-top: 10px;
	padding-top: 10px;
	border-top: 1px dashed #ccc;
}

.edit-inline-form h4 {
	margin: 5px 0 5px 0;
	font-size: 0.9em;
}

.edit-review-textarea {
	/* [ìˆ˜ì •] ì…ë ¥ í•„ë“œ ë¼ìš´ë“œ ê°’ ì ìš© */
	border-radius: 6px; 
	width: 100%;
	box-sizing: border-box;
	margin-bottom: 10px;
	border: 1px solid #ccc; /* í…Œë‘ë¦¬ ì¶”ê°€ */
	padding: 5px;
	font-family: 'Juache', sans-serif;
}

.edit-inline-rating {
	margin-bottom: 5px;
}

.edit-inline-rating span {
	font-size: 1.5em;
	cursor: pointer;
	color: #ccc;
}

.edit-inline-rating span.active {
	color: gold;
}

.edit-actions button {
	font-size: 0.8em !important;
	padding: 5px 10px !important;
	font-family: 'Juache', sans-serif !important;
    cursor: pointer !important; /* ì»¤ì„œ í¬ì¸í„° ì¶”ê°€ */
}

.edit-actions button.save {
	/* [ìˆ˜ì •] ìƒ‰ìƒ í†µì¼ */
	background: #D2B48C; 
	color: white;
	border: none;
	border-radius: 4px;
}
.edit-actions button.save:hover {
	background: #a38b6a;
}


.edit-actions button.cancel {
	background: #dc3545;
	color: white;
	border: none;
	border-radius: 4px;
	margin-left: 5px;
}


.btn-outline-danger {
	font-family: 'Juache', sans-serif;
	font-size : 14px;
    border-radius:999px;
    background-color: transparent;
    color: #dc3545;
    border: 2px solid #dc3545;
    transition: all 0.3s ease;
    padding: 6px 8px;
     cursor: pointer;
} 

.btn-outline-danger:hover {
	
    color: white; 
    background-color: #dc3545; 
    border-color: #dc3545;
}


.btn-outline-brown {
	font-family: 'Juache', sans-serif;
	font-size : 14px;
	border: 2px solid #8B4513;
	border-radius:999px;
    color: #8B4513; /* ê¸€ììƒ‰: ìƒˆë“¤ ë¸Œë¼ìš´ */
    border-color: #8B4513; /* í…Œë‘ë¦¬ìƒ‰ */
    background-color: transparent; /* ë°°ê²½ íˆ¬ëª… */
    cursor: pointer;
    padding: 6px 8px;
    transition: all 0.3s ease; /* ë¶€ë“œëŸ¬ìš´ ì „í™˜ íš¨ê³¼ */
}

.btn-outline-brown:hover {
    color: white;
    background-color: #8B4513;
    
}

</style>

<script
	src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script
	src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
</head>
<body>


	<div id="chat-container">
		<div id="message-area"></div>
		<div id="input-area">
			<input type="text" id="message-input" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”...">
			<button id="send-button" class="btn btn-fatcat" style="font-size:16px;" >ì „ì†¡</button>
			<button id="care-toggle" class="btn btn-darkbrown" style="font-size:16px;">ëŒë´„ ì˜ˆì•½</button>
		</div>
        
		<div id="care-form">
			<div class="care-form-group">
				<label for="start-date">ì‹œì‘ì¼:</label>
				<input type="datetime-local" id="start-date">
			</div>
			<div class="care-form-group">
				<label for="end-date">ì¢…ë£Œì¼:</label>
				<input type="datetime-local" id="end-date">
			</div>
			
			<div class="care-form-group" style="display: none;">
				<input type="hidden" id="session-status" name="sessionStatus" value="REQUESTED">
			</div>
			
			<div class="care-form-group full-width">
				<label for="session-note">ë©”ëª¨:</label>
				<textarea id="session-note" rows="3" placeholder="ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”"></textarea>
			</div>
			<div class="care-form-group full-width button-container">
				<button id="confirm-care" class="btn btn-fatcat">ì˜ˆì•½ ì „ì†¡</button>
			</div>
		</div>
		<div id="review-popup">
			<div class="popup-header">
				<h2 id="review-target-name"></h2>
				<button onclick="closeReviewPopup()">Ã—</button>
			</div>

			<div id="review-rating-summary">
				<h3 id="avg-rating"></h3>
				<p id="total-reviews"></p>
			</div>

			<div id="review-form-area">
				<h4>ë¦¬ë·° ë“±ë¡</h4>
				<div class="rating-input" id="new-rating">
					<span data-rating="1">â˜…</span> <span data-rating="2">â˜…</span> <span
						data-rating="3">â˜…</span> <span data-rating="4">â˜…</span> <span
						data-rating="5">â˜…</span>
				</div>
				<textarea id="new-review-text" rows="3" placeholder="ë¦¬ë·° ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”."></textarea>
				<button id="submit-review-btn" style="font-size : 16px;">ë¦¬ë·° ì‘ì„±</button>
			</div>
			<hr style="width:100%;height:1px;border:none;background-color:#cccccc;">
			<h4 style="font-size : 20px;">ë“±ë¡ëœ ë¦¬ë·°</h4>
			<div id="review-list"></div>
		</div>
	</div>
<script>
let senderId = null;
let receiverId = null;
let chatRoomId = null;
let stompClient = null;
let targetUserSeqForReview = null; 
let currentRating = 0; 

let userNames = {}; 

// âœ¨ ë‚ ì§œ êµ¬ë¶„ì„  ë¡œì§ì„ ìœ„í•œ ì „ì—­ ë³€ìˆ˜ ì¶”ê°€ âœ¨
let lastDisplayedDate = null; 

const messageArea = document.getElementById('message-area');
const messageInput = document.getElementById('message-input');
const sendButton = document.getElementById('send-button');
const careToggle = document.getElementById('care-toggle');
const careForm = document.getElementById('care-form');
const startDateInput = document.getElementById('start-date');
const endDateInput = document.getElementById('end-date');
const confirmCare = document.getElementById('confirm-care');


//--------------------------------------------------------
//ì‚¬ìš©ì ë‹‰ë„¤ì„ ì¡°íšŒ ë¡œì§ ì¶”ê°€
//--------------------------------------------------------
async function fetchUserNames(userSeq) {
 try {
     // â­ ì„œë²„ì˜ ì‚¬ìš©ì ë‹‰ë„¤ì„ ì¡°íšŒ API ê²½ë¡œë¡œ ë³€ê²½í•´ì•¼ í•©ë‹ˆë‹¤.
     // ì˜ˆë¥¼ ë“¤ì–´, '/api/users/{userSeq}/nickname'ê³¼ ê°™ì€ ê²½ë¡œë¥¼ ê°€ì •í•©ë‹ˆë‹¤.
     const res = await fetch(`/api/users/${userSeq}/userName`);
     if (res.ok) {
         const data = await res.json();
         // ì„œë²„ ì‘ë‹µ êµ¬ì¡°ì— ë”°ë¼ 'data.nickname' ë˜ëŠ” 'data.userName' ë“±ìœ¼ë¡œ ìˆ˜ì •í•˜ì„¸ìš”.
         return data.userName; 
     } else {
         console.error(`Error fetching userName for user ${userSeq}:`, res.status);
         return `User ${userSeq}`; // ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ê°’
     }
 } catch (error) {
     console.error(`Network error fetching userName for user ${userSeq}:`, error);
     return `User ${userSeq}`;
 }
}


// --------------------------------------------------------
// ì´ˆê¸°í™” ë° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
// --------------------------------------------------------

window.onload = function() {
  
    // ğŸ’¡ [ìˆ˜ì •] URLì—ì„œ senderSeqì™€ receiverSeqë¥¼ ê°€ì ¸ì™€ ID ì„¤ì •
    const urlParams = new URLSearchParams(window.location.search);
    // URLì— íŒŒë¼ë¯¸í„°ê°€ ì—†ìœ¼ë©´ ì„ì‹œë¡œ 1ê³¼ 11ì„ ê¸°ë³¸ê°’ìœ¼ë¡œ ì‚¬ìš©í•˜ê±°ë‚˜, null ì²˜ë¦¬í•©ë‹ˆë‹¤.
    senderId = parseInt(urlParams.get('senderSeq')) || null; 
    receiverId = parseInt(urlParams.get('receiverSeq')) || null;

    // ğŸ’¡ [ìˆ˜ì •] userNames ì´ˆê¸°í™” (ì±„íŒ… í‘œì‹œë¥¼ ìœ„í•´ í•„ìš”)
    userNames[senderId] = 'ë‚˜'; 
    userNames[receiverId] = 'ìƒëŒ€ë°©'; 
    

    // ID ìœ íš¨ì„± ê²€ì‚¬ ë° ì±„íŒ… ì´ˆê¸°í™”
    if (senderId && receiverId && senderId !== receiverId) {
        // UIì— í‘œì‹œ (ì´ì „ ë‹¨ê³„ì—ì„œ ì¶”ê°€ëœ #sender-info, #receiver-infoê°€ ìˆë‹¤ë©´)
        const senderInfo = document.getElementById('sender-info');
        const receiverInfo = document.getElementById('receiver-info');
        if (senderInfo) senderInfo.textContent = userNames[senderId];
        if (receiverInfo) receiverInfo.textContent = userNames[receiverId];

        initChatRoom(); // IDê°€ ì„¤ì •ë˜ë©´ ë°”ë¡œ ì±„íŒ…ë°© ì´ˆê¸°í™” ì‹œì‘
    } else if (senderId === receiverId && senderId !== null) {
        alert("ìê¸° ìì‹ ê³¼ëŠ” ì±„íŒ…ì„ í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    } else {
        // URL íŒŒë¼ë¯¸í„°ê°€ ëˆ„ë½ëœ ê²½ìš°
        // alert("ì±„íŒ…ì— í•„ìš”í•œ ì‚¬ìš©ì IDê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. (URL: senderSeq, receiverSeq í™•ì¸ í•„ìš”)");
        console.warn("ì±„íŒ… IDê°€ URLì— ì—†ì–´ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´ ì„ì‹œ IDë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.");
    }


    sendButton.addEventListener('click', sendMessage);
    messageInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') sendMessage();
    });

    // ëŒë´„ ì˜ˆì•½ í† ê¸€ ë¡œì§
    careToggle.addEventListener('click', () => {
    	 
    	        careForm.classList.toggle('active');
    	        
    	        if (careForm.classList.contains('active')) {
    	            careToggle.textContent = 'ì˜ˆì•½ ì·¨ì†Œ';
    	        } else {
    	            careToggle.textContent = 'ëŒë´„ ì˜ˆì•½';
    	        }
    });

    confirmCare.addEventListener('click', sendCareRequest);

    document.querySelectorAll('#new-rating span').forEach(star => {
        star.addEventListener('click', () => {
            currentRating = parseInt(star.dataset.rating);
            updateStarRating(currentRating, document.getElementById('new-rating'));
        });
    });

    document.getElementById('submit-review-btn').addEventListener('click', submitReview);
};
// --------------------------------------------------------
// ì±„íŒ… ë° ëŒë´„ ìš”ì²­ ë¡œì§ 
// --------------------------------------------------------

function sendCareRequest() {
    const start = startDateInput.value;
    const end = endDateInput.value;
    if (!start || !end) return console.error("ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”."); 
    
    const startIsoFormat = start.replace(' ', 'T');
    const endIsoFormat = end.replace(' ', 'T');
    
    // ì´ˆ(':00')ë¥¼ ì¶”ê°€í•˜ì—¬ ë°±ì—”ë“œ í¬ë§·(yyyy-MM-dd'T'HH:mm:ss)ì„ ì™„ì„±í•©ë‹ˆë‹¤.
    const startWithSeconds = startIsoFormat + ':00';
    const endWithSeconds = endIsoFormat + ':00';
    
    const chatMessage = {
        chatRoomId: chatRoomId,
        senderId: senderId,
        receiverId: receiverId,
        type: "CARE_REQUEST",
        startDate: startWithSeconds,
        endDate: endWithSeconds,
        status: 'REQUESTED',
        note: document.getElementById('session-note').value,
        content: `ëŒë´„ ìš”ì²­: ${start} ~ ${end}`
    };

    stompClient.send("/app/private-chat", {}, JSON.stringify(chatMessage));

    // í´ë˜ìŠ¤ í† ê¸€ì„ ì‚¬ìš©í•˜ë„ë¡ ë³€ê²½ (í¼ì„ ë‹«ìŒ)
    careForm.classList.remove('active');
    careToggle.textContent = 'ëŒë´„ ì˜ˆì•½';
    
    startDateInput.value = '';
    endDateInput.value = '';
    document.getElementById('session-note').value = '';
}

function confirmCareRequest(sessionId, senderIdFromMsg) {
    const chatMessage = {
        chatRoomId: chatRoomId,
        senderId: senderId,
        receiverId: senderIdFromMsg,
        type: "CARE_CONFIRM",
        sessionId: sessionId,
        content: `âœ… ëŒë´„ ì˜ˆì•½ì´ í™•ì •ë˜ì—ˆìŠµë‹ˆë‹¤.`
    };
    stompClient.send("/app/private-chat", {}, JSON.stringify(chatMessage));
}

function updateCareRequestUI(sessionId, confirmedTime) {
    const requestElements = document.querySelectorAll(`[data-session-id="${sessionId}"]`);
    
    const confirmedDate = new Date(confirmedTime.replace(' ', 'T'));
    const formattedDate = `${confirmedDate.getFullYear()}-${(confirmedDate.getMonth() + 1).toString().padStart(2, '0')}-${confirmedDate.getDate().toString().padStart(2, '0')}`;
    const hours = confirmedDate.getHours();
    const minutes = confirmedDate.getMinutes().toString().padStart(2,'0');
    const ampm = hours >= 12 ? 'ì˜¤í›„' : 'ì˜¤ì „';
    const hour12 = hours % 12 === 0 ? 12 : hours % 12;
    const formattedTime = `${formattedDate} ${ampm} ${hour12}:${minutes}`;

    requestElements.forEach(element => {
        const confirmButton = element.querySelector('.confirm-btn');
        if (confirmButton) {
            confirmButton.remove();
        }
        
        const existingStatusSpan = element.querySelector('.care-status');
        if (existingStatusSpan) {
            existingStatusSpan.innerHTML = `[âœ… í™•ì •ë¨ - ${formattedTime}]`;
        } else {
            const confirmedSpan = document.createElement('span');
            confirmedSpan.classList.add('care-status'); 
            confirmedSpan.style.color = 'green';
            confirmedSpan.style.fontWeight = 'bold';
            confirmedSpan.innerText = `[âœ… í™•ì •ë¨ - ${formattedTime}]`;
            element.querySelector('.care-request').appendChild(confirmedSpan);
        }
    });
}

async function initChatRoom() {
    if (!senderId || !receiverId) return;
    if (stompClient && stompClient.connected) stompClient.disconnect();

    try {
    	
    			// ğŸ’¡ [ìˆ˜ì •] ìƒëŒ€ë°© ë‹‰ë„¤ì„ì„ ë¨¼ì € ê°€ì ¸ì˜µë‹ˆë‹¤.
        const receiverName = await fetchUserNames(receiverId);
    			
     // userNames ê°ì²´ë¥¼ ì‹¤ì œ ë‹‰ë„¤ì„ìœ¼ë¡œ ì—…ë°ì´íŠ¸
        userNames[senderId] = 'ë‚˜'; 
        userNames[receiverId] = receiverName; // â­ ìƒëŒ€ë°©ì˜ ì‹¤ì œ ë‹‰ë„¤ì„ìœ¼ë¡œ ì„¤ì •
    			
        const res = await fetch(`/api/chat/room?sender=${senderId}&receiver=${receiverId}`);
        const data = await res.json();
        chatRoomId = data.chatSeq;

        const histRes = await fetch(`/api/chat/history?roomId=${chatRoomId}`);
        const history = await histRes.json();
        
        // âœ¨ ë‚ ì§œ êµ¬ë¶„ì„  ì´ˆê¸°í™” ë¡œì§ ì¶”ê°€ âœ¨
        lastDisplayedDate = null; 
        
        displayChatHistory(history);

        connectWebSocket();
    } catch (error) {
        console.error("ì±„íŒ…ë°© ì´ˆê¸°í™” ì˜¤ë¥˜:", error);
    }
}

function connectWebSocket() {
    const socket = new SockJS('/ws');
    stompClient = Stomp.over(socket);

    stompClient.connect({}, () => {
        stompClient.subscribe(`/topic/chat/${chatRoomId}`, (message) => {
            const chatMessage = JSON.parse(message.body);
            displayMessage(chatMessage);
            
            if (chatMessage.type === "CARE_CONFIRM") {
                updateCareRequestUI(chatMessage.sessionId, chatMessage.confirmedTime);
            }
        });
    }, (error) => console.error("Connection error: ", error));
}

function sendMessage() {
    if (!stompClient || !stompClient.connected) return;
    if (!messageInput.value.trim()) return;

    const chatMessage = {
        chatRoomId: chatRoomId,
        senderId: senderId,
        receiverId: receiverId,
        type: "CHAT",
        content: messageInput.value.trim()
    };

    stompClient.send("/app/private-chat", {}, JSON.stringify(chatMessage));
    messageInput.value = '';
}

// --------------------------------------------------------
// ë©”ì‹œì§€ í‘œì‹œ 
// --------------------------------------------------------

// âœ¨ ë‚ ì§œë¥¼ 'YYYYë…„ Mì›” Dì¼' í˜•ì‹ìœ¼ë¡œ í¬ë§·í•˜ëŠ” í•¨ìˆ˜ (êµ¬ë¶„ì„ ìš©) âœ¨
function formatDateForSeparator(dateString) {
    if (!dateString) return '';
    const date = new Date(dateString.replace(' ', 'T'));
    const year = date.getFullYear();
    const month = date.getMonth() + 1;
    const day = date.getDate();
    return `${year}ë…„ ${month}ì›” ${day}ì¼`; 
}

// âœ¨ ë‚ ì§œ ë¹„êµë¥¼ ìœ„í•œ 'YYYY-MM-DD' í˜•ì‹ í•¨ìˆ˜ (ë¹„êµìš©) âœ¨
function getDateString(dateString) {
    if (!dateString) return '';
    const date = new Date(dateString.replace(' ', 'T'));
    const year = date.getFullYear();
    const month = (date.getMonth() + 1).toString().padStart(2, '0');
    const day = date.getDate().toString().padStart(2, '0');
    return `${year}-${month}-${day}`;
}


/**
 * ISO í˜•ì‹ì˜ ë‚ ì§œ ë¬¸ìì—´(ì˜ˆ: YYYY-MM-DDTHH:mm:ss)ì„ 
 * í•œêµ­ì–´ ë¡œì¼€ì¼ë¡œ í¬ë§·íŒ…í•©ë‹ˆë‹¤.
 */
function formatDateTime(dateString) {
    // ê°’ì´ null, undefined, ë˜ëŠ” ë¹ˆ ë¬¸ìì—´ì¼ ê²½ìš° ì²˜ë¦¬
    if (!dateString) {
        return 'ë‚ ì§œ ì •ë³´ ì—†ìŒ'; 
    }
    
    // ë°±ì—”ë“œì—ì„œ YYYY-MM-DDTHH:mm:ss í˜•ì‹ìœ¼ë¡œ ì˜¤ê¸° ë•Œë¬¸ì— 
    // ë¬¸ìì—´ì„ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•˜ì—¬ Date ê°ì²´ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
    const date = new Date(dateString);

    // Date ê°ì²´ ìœ íš¨ì„± ê²€ì‚¬
    if (isNaN(date.getTime())) { // getTime()ìœ¼ë¡œ Invalid Date ì²´í¬ë¥¼ ë” í™•ì‹¤í•˜ê²Œ í•©ë‹ˆë‹¤.
        // DTO í•„ë“œê°€ String íƒ€ì…ì´ì§€ë§Œ, ì„œë²„ì—ì„œ ë°ì´í„°ê°€ ê¹¨ì ¸ì„œ ì˜¬ ê²½ìš° ëŒ€ë¹„
        console.error("ë‚ ì§œ íŒŒì‹± ì˜¤ë¥˜ ë°œìƒ. ì›ë³¸ ë¬¸ìì—´:", dateString);
        return 'ë‚ ì§œ í˜•ì‹ ì˜¤ë¥˜'; 
    }

    // í•œêµ­ì–´ ë¡œì¼€ì¼ê³¼ ì˜µì…˜ì„ ì‚¬ìš©í•˜ì—¬ í¬ë§·íŒ…
    const options = {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: 'numeric',
        minute: '2-digit',
        hour12: true, // ì˜¤ì „/ì˜¤í›„ ì‚¬ìš©
        timeZone: 'Asia/Seoul' 
    };

    // ê²°ê³¼: "2025. 09. 28. ì˜¤í›„ 07:25"
    return date.toLocaleString('ko-KR', options);
}

function displayMessage(chatMessage) {
    // âœ¨ ë‚ ì§œ êµ¬ë¶„ì„  ë¡œì§ ì¶”ê°€ ì‹œì‘ âœ¨
    const currentMessageDateTimeStr = chatMessage.timestamp || new Date().toISOString().replace('T', ' ').substring(0, 19);
    
    // í˜„ì¬ ë©”ì‹œì§€ì˜ ë‚ ì§œ (YYYY-MM-DD)
    const currentMessageDate = getDateString(currentMessageDateTimeStr); 
    
    if (currentMessageDate !== lastDisplayedDate) {
        // ë‚ ì§œê°€ ë°”ë€Œì—ˆìœ¼ë©´ êµ¬ë¶„ì„  ì¶”ê°€
        const separatorDiv = document.createElement('div');
        separatorDiv.classList.add('date-separator');
        
        const dateSpan = document.createElement('span');
        // 'YYYYë…„ Mì›” Dì¼' í˜•ì‹ìœ¼ë¡œ í‘œì‹œ
        dateSpan.textContent = formatDateForSeparator(currentMessageDateTimeStr); 
        
        separatorDiv.appendChild(dateSpan);
        messageArea.appendChild(separatorDiv);
        
        // ë§ˆì§€ë§‰ ë‚ ì§œ ì—…ë°ì´íŠ¸
        lastDisplayedDate = currentMessageDate;
    }
    // âœ¨ ë‚ ì§œ êµ¬ë¶„ì„  ë¡œì§ ì¶”ê°€ ë âœ¨
    
    const isSent = chatMessage.senderId === senderId;
    const senderIdForPopup = chatMessage.senderId; 

    const senderName = userNames[chatMessage.senderId] || `User ${chatMessage.senderId}`;
    
    const messageRow = document.createElement('div');
    messageRow.classList.add('message-row');
    messageRow.classList.add(isSent ? 'sent' : 'received');
    
    const timeToFormat = chatMessage.timestamp ? new Date(chatMessage.timestamp.replace(' ', 'T')) : new Date();
    const hours = timeToFormat.getHours();
    const minutes = timeToFormat.getMinutes().toString().padStart(2,'0');
    const ampm = hours >= 12 ? 'ì˜¤í›„' : 'ì˜¤ì „';
    const hour12 = hours % 12 === 0 ? 12 : hours % 12;
    const timeString = `${ampm} ${hour12}:${minutes}`;
    
    if (!isSent) {
        // ë°›ì€ ë©”ì‹œì§€
        
        // â­ [ìˆ˜ì •] div ëŒ€ì‹  img íƒœê·¸ë¥¼ ì‚¬ìš©í•˜ê³ , URLì€ receiverProfileImageë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤. â­
        const profileImage = document.createElement('img');
        profileImage.className = 'profile-image'; // â­ ì•„ë˜ CSSì— ì¶”ê°€í•  í´ë˜ìŠ¤ ì´ë¦„
        profileImage.alt = senderName + ' í”„ë¡œí•„'; // ìƒëŒ€ë°©ì˜ ë‹‰ë„¤ì„ì„ alt í…ìŠ¤íŠ¸ë¡œ ì‚¬ìš©
        
       
        profileImage.src = chatMessage.senderProfileImage || '/images/no_image.jpg'; 


        // -------------------------------------------------
        // â­ í”„ë¡œí•„ ì´ë¯¸ì§€ í´ë¦­ ì‹œ ë¦¬ë·° íŒì—… ë¡œì§ (ìœ ì§€) â­
        // -------------------------------------------------
        profileImage.onclick = (e) => {
            e.stopPropagation();
            openReviewPopup(senderIdForPopup, senderName); // openReviewPopupì€ senderIdë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
        };
        
        messageRow.appendChild(profileImage); // ìˆ˜ì •ëœ img íƒœê·¸ë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤.
    }

    const contentWrapper = document.createElement('div');
    contentWrapper.classList.add('message-content-wrapper');

    if (!isSent) {
        const nameDiv = document.createElement('div');
        nameDiv.classList.add('user-nickname'); 
        nameDiv.innerText = senderName; 
        nameDiv.addEventListener('click', () => openReviewPopup(senderIdForPopup));
        contentWrapper.appendChild(nameDiv);
    }

    const messageDiv = document.createElement('div');
    messageDiv.classList.add('message');
    messageDiv.classList.add('tail'); // ê¼¬ë¦¬ ìŠ¤íƒ€ì¼ì„ ì ìš©í•©ë‹ˆë‹¤.

    if (chatMessage.type === "CARE_REQUEST") {
    	
   	 	console.log("DEBUG: CARE_REQUEST chatMessage Object:", chatMessage);
        console.log("DEBUG: Start Date Value:", chatMessage.startDate, "End Date Value:", chatMessage.endDate);
    	
    		const formattedStartDate = formatDateTime(chatMessage.startDate);
        const formattedEndDate = formatDateTime(chatMessage.endDate);
        const careDiv = document.createElement('div');
        careDiv.setAttribute('data-session-id', chatMessage.sessionId || -1); 
        careDiv.classList.add('care-request');

        const status = chatMessage.status || 'REQUESTED';
        const sessionId = chatMessage.sessionId || -1;
        const isReceiver = chatMessage.senderId !== senderId;

        let confirmButtonHtml = '';
        let statusDisplay = '';

        if (status === 'REQUESTED' && isReceiver) {
            confirmButtonHtml = `<button class="confirm-btn" data-session-id="${sessionId}" data-sender-id="${chatMessage.senderId}">í™•ì •</button>`;
        } else if (status === 'CONFIRMED') {
            const formattedConfirmTime = chatMessage.confirmedTime ? 
                formatDateTime(chatMessage.confirmedTime) : 
                'ì‹œê°„ ì •ë³´ ì—†ìŒ';
            statusDisplay = `<span class="care-status" style="color: green; font-weight: bold; font-size:20px;">[âœ… í™•ì •ë¨ - ${formattedConfirmTime}]</span>`;
        } else if (status === 'CANCELLED') {
            statusDisplay = `<span class="care-status" style="color: red; font-weight: bold; font-size:20px;">[âŒ ì·¨ì†Œë¨]</span>`;
        }
        
        


        careDiv.innerHTML =  `
            <div class="care-request-card" style="font-size:16px;">
            <div class="card-header">
                <span class="header-icon">ğŸ“Œ</span>
                <span class="header-title">ëŒë´„ ìš”ì²­ ìƒì„¸</span>
            </div>
            
            <div class="card-body" style="font-size:16px;">
                <div class="detail-row time-detail">
                    <span class="detail-icon">ğŸ“…</span>
                    <div class="detail-text">
                        <span class="label">ì‹œì‘:</span> ${formattedStartDate} 
                    </div>
                </div>
                <div class="detail-row time-detail">
                    <span class="detail-icon">ğŸ—“ï¸</span>
                    <div class="detail-text">
                        <span class="label">ì¢…ë£Œ:</span> ${formattedEndDate} 
                    </div>
                </div>
                <div class="detail-row memo-detail">
                    <span class="detail-icon">ğŸ“</span>
                    <div class="detail-text">
                        <span class="label">ë©”ëª¨:</span> ${chatMessage.note || 'ì—†ìŒ'}
                    </div>
                </div>
            </div>

            <div class="card-footer">
                ${statusDisplay ? `<div class="status-box">${statusDisplay}</div>` : ''}
                ${confirmButtonHtml ? `<div class="action-box">${confirmButtonHtml}</div>` : ''}
            </div>
        </div>
    `;
        messageDiv.appendChild(careDiv);

        if (status === 'REQUESTED' && isReceiver) {
            const confirmButton = careDiv.querySelector('.confirm-btn');
            if (confirmButton) {
                confirmButton.addEventListener('click', (event) => {
                    const session_Id = parseInt(event.target.dataset.sessionId);
                    const sender_Id = parseInt(event.target.dataset.senderId);
                    if (session_Id !== -1) {
                        confirmCareRequest(session_Id, sender_Id);

                        const tempConfirmedTime = new Date().toISOString().replace('T', ' ').substring(0, 19);
                        updateCareRequestUI(session_Id, tempConfirmedTime);
                    }
                });
            }
        }

    } else if (chatMessage.type === "CARE_CONFIRM") {
        messageDiv.classList.add('care-confirmed');
        messageDiv.innerText = chatMessage.content;
    } else {
        messageDiv.innerText = chatMessage.content;
    }
    
    contentWrapper.appendChild(messageDiv);
    
    const timeDiv = document.createElement('div');
    timeDiv.classList.add('message-time');
    timeDiv.innerText = timeString;
    contentWrapper.appendChild(timeDiv);

    messageRow.appendChild(contentWrapper);

    messageArea.appendChild(messageRow);
    messageArea.scrollTop = messageArea.scrollHeight;
}

function displayChatHistory(history) {
    messageArea.innerHTML = '';
    if (history && Array.isArray(history)) {
        // ë©”ì‹œì§€ ê¸°ë¡ì€ í•­ìƒ ì‹œê°„ ìˆœì„œëŒ€ë¡œ ì •ë ¬ë˜ì–´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.
        history.forEach(msg => displayMessage(msg)); 
    }
}


// --------------------------------------------------------
// ë¦¬ë·° íŒì—… ë° ë¡œì§ 
// --------------------------------------------------------

function openReviewPopup(targetSeq) {
    if (!targetSeq || targetSeq === senderId) {
        alert("ë³¸ì¸ì— ëŒ€í•œ ë¦¬ë·°ëŠ” ë“±ë¡í•˜ê±°ë‚˜ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        return;
    }
    
    // â­ [ìˆ˜ì •] ë‹¤ë¥¸ ë¦¬ë·° ìˆ˜ì • í¼ì´ ì—´ë ¤ìˆë‹¤ë©´ ë‹«ê¸°
    const activeForm = document.querySelector('.edit-inline-form[data-is-editing="true"]');
    if (activeForm) {
        const activeReviewId = parseInt(activeForm.dataset.reviewId);
        cancelEdit(activeReviewId);
    }


    targetUserSeqForReview = targetSeq;
    const targetName = userNames[targetSeq] || `User ${targetSeq}`;

    document.getElementById('review-target-name').innerText = `${targetName} ë‹˜ ë¦¬ë·°`;
    document.getElementById('review-popup').classList.add('show');

    fetchReviews(targetSeq);
}

function closeReviewPopup() {
    document.getElementById('review-popup').classList.remove('show');
    targetUserSeqForReview = null;
    
    currentRating = 0;
    document.getElementById('new-review-text').value = '';
    updateStarRating(0, document.getElementById('new-rating'));

    // â­ [ìˆ˜ì •] íŒì—… ë‹«ì„ ë•Œ ì—´ë ¤ìˆëŠ” ìˆ˜ì • í¼ì´ ìˆë‹¤ë©´ ë‹«ê¸°
    const activeForm = document.querySelector('.edit-inline-form[data-is-editing="true"]');
    if (activeForm) {
        const activeReviewId = parseInt(activeForm.dataset.reviewId);
        cancelEdit(activeReviewId);
    }
}

async function fetchReviews(targetSeq) {
    const listArea = document.getElementById('review-list');
    const avgRatingElem = document.getElementById('avg-rating');
    const totalReviewsElem = document.getElementById('total-reviews');
    listArea.innerHTML = 'ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';

    try {
        // ì´ API ê²½ë¡œëŠ” ì‚¬ìš©ìì˜ ì„œë²„ í™˜ê²½ì— ë§ê²Œ ì¡°ì •ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.
        const response = await fetch(`/api/care-reviews?targetUserSeq=${targetSeq}`);
        if (!response.ok) throw new Error('Failed to fetch reviews');
        
        const reviews = await response.json();
        listArea.innerHTML = '';
        
        let totalRating = 0;
        
        if (reviews.length === 0) {
            listArea.innerHTML = '<p style="text-align: center; color: #999;">ë“±ë¡ëœ ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
            avgRatingElem.innerHTML = 'í‰ì : <span class="star-rating">0.0</span>';
            totalReviewsElem.innerText = 'ì´ 0ê°œì˜ ë¦¬ë·°';
            return;
        }

        reviews.forEach(review => {
            totalRating += review.careRating;
            listArea.appendChild(createReviewItem(review));
        });

        const average = (totalRating / reviews.length).toFixed(1);
        const starHtml = 'â˜…'.repeat(Math.round(average)) + 'â˜†'.repeat(5 - Math.round(average));
        
        avgRatingElem.innerHTML = `í‰ì : <span class="star-rating">${average}</span> <span style="color:gold">${starHtml}</span>`;
        totalReviewsElem.innerText = `ì´ ${reviews.length}ê°œì˜ ë¦¬ë·°`;

    } catch (error) {
        console.error("ë¦¬ë·° ë¡œë“œ ì˜¤ë¥˜:", error);
        listArea.innerHTML = '<p style="color: red;">ë¦¬ë·°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>';
        avgRatingElem.innerHTML = 'í‰ì : <span class="star-rating">--</span>';
        totalReviewsElem.innerText = 'ì´ --ê°œì˜ ë¦¬ë·°';
    }
}

/**
 * ë¦¬ë·° ì•„ì´í…œ DOM ìš”ì†Œë¥¼ ìƒì„±í•©ë‹ˆë‹¤. 
 */
function createReviewItem(review) {
    const item = document.createElement('div');
    item.classList.add('review-item');
    
    const starHtml = 'â˜…'.repeat(review.careRating) + 'â˜†'.repeat(5 - review.careRating);
    const date = new Date(review.createDate);
    const dateString = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}`;

    // í˜„ì¬ ë¡œê·¸ì¸ëœ ì‚¬ìš©ìê°€ ë¦¬ë·° ì‘ì„±ìì¸ ê²½ìš°ì—ë§Œ ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ í‘œì‹œ
    let actionButtons = '';
    let editFormHtml = ''; 
    
    if (review.authorUserSeq === senderId) { 
        actionButtons = `
            <div class="review-actions"> 
                <button class="btn-outline-brown" onclick="editReview(${review.reviewSeq}, this)">ìˆ˜ì •</button>
                <button class="btn-outline-danger" onclick="deleteReview(${review.reviewSeq})">ì‚­ì œ</button>
            </div>
        `;
        
        // â­ ì¸ë¼ì¸ ìˆ˜ì • í¼ ì¶”ê°€ (ê¸°ë³¸ì ìœ¼ë¡œ ìˆ¨ê²¨ì§)
        editFormHtml = `
            <div class="edit-inline-form" data-review-id="${review.reviewSeq}">
                <div>
                    <h4>ë³„ì :</h4>
                    <div class="rating-input edit-inline-rating" data-initial-rating="${review.careRating}">
                        <span data-rating="1">â˜…</span>
                        <span data-rating="2">â˜…</span>
                        <span data-rating="3">â˜…</span>
                        <span data-rating="4">â˜…</span>
                        <span data-rating="5">â˜…</span>
                    </div>
                    <h4>ë‚´ìš©:</h4>
                    <textarea class="edit-review-textarea" rows="3">${review.careReview}</textarea>
                    <div class="edit-actions" style="margin-top: 5px; text-align: right;">
                        <button class="btn-outline-brown" onclick="saveEditReview(${review.reviewSeq}, this)">ì €ì¥</button>
                        <button class="btn-outline-danger" onclick="cancelEdit(${review.reviewSeq}, this)">ì·¨ì†Œ</button>
                    </div>
                </div>
            </div>
        `;
    }


    item.innerHTML = `
        <div class="review-content-wrapper" id="review-content-${review.reviewSeq}">
            <div class="review-header">
                <span>${review.authorNickname}</span>
                <span class="star-rating">${starHtml}</span>
            </div>
            <div class="review-body">${review.careReview}</div>
            <div class="review-date">
                <span>${dateString}</span>
                ${actionButtons}
            </div>
        </div>
        ${editFormHtml}
    `;
    item.id = `review-item-${review.reviewSeq}`;
    
    // â­ ì´ˆê¸° ë³„ì  UI ì„¤ì • ë° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
    if (review.authorUserSeq === senderId) {
        const starContainer = item.querySelector('.edit-inline-rating');
        
        // saveEditReviewì—ì„œ ì‚¬ìš©í•  í˜„ì¬ í‰ì ì„ data-current-ratingì— ì €ì¥
        starContainer.setAttribute('data-current-rating', review.careRating); 
        updateStarRating(review.careRating, starContainer); 
        
        starContainer.querySelectorAll('span').forEach(star => {
            star.addEventListener('click', () => {
                const newRating = parseInt(star.dataset.rating);
                // HTML ìš”ì†Œ ìì²´ì— í˜„ì¬ í‰ì ì„ ì €ì¥í•˜ì—¬ saveEditReviewì—ì„œ ì‚¬ìš©
                starContainer.setAttribute('data-current-rating', newRating); 
                updateStarRating(newRating, starContainer);
            });
        });
    }

    return item;
}

function updateStarRating(rating, container) {
    container.querySelectorAll('span').forEach(star => {
        if (parseInt(star.dataset.rating) <= rating) {
            star.classList.add('active');
        } else {
            star.classList.remove('active');
        }
    });
}

async function submitReview() {
    const reviewText = document.getElementById('new-review-text').value.trim();

    if (currentRating === 0) {
        return alert("ë³„ì ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
    }
    if (reviewText.length < 5) {
        return alert("ë¦¬ë·° ë‚´ìš©ì„ 5ì ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”.");
    }
    if (!targetUserSeqForReview || targetUserSeqForReview === senderId) {
        return alert("ë¦¬ë·° ëŒ€ìƒì„ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    }
    if (!senderId) {
        return alert("ë¦¬ë·°ë¥¼ ì‘ì„±í•  'ë³´ë‚´ëŠ” ì‚¬ëŒ'ì„ ì„ íƒí•´ì£¼ì„¸ìš”. (API í˜¸ì¶œì— í•„ìš”)");
    }

    const requestBody = {
        authorUserSeq: senderId, 
        targetUserSeq: targetUserSeqForReview,
        careReview: reviewText,
        careRating: currentRating,
        targetRole: "provider" 
    };

    try {
        // ì´ API ê²½ë¡œëŠ” ì‚¬ìš©ìì˜ ì„œë²„ í™˜ê²½ì— ë§ê²Œ ì¡°ì •ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.
        const response = await fetch('/api/care-reviews', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(requestBody)
        });

        if (!response.ok) {
            const errorData = await response.json().catch(() => ({ message: 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜' }));
            throw new Error(`ë¦¬ë·° ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (${errorData.message})`);
        }

        alert("ë¦¬ë·°ê°€ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!");
        
        currentRating = 0;
        document.getElementById('new-review-text').value = '';
        updateStarRating(0, document.getElementById('new-rating'));

        fetchReviews(targetUserSeqForReview); 

    } catch (error) {
        console.error("ë¦¬ë·° ë“±ë¡ ì˜¤ë¥˜:", error);
        alert(error.message || "ë¦¬ë·° ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
    }
}

/**
 * â­ ìˆ˜ì • ë²„íŠ¼ í´ë¦­ ì‹œ ì¸ë¼ì¸ ìˆ˜ì • í¼ì„ í‘œì‹œí•©ë‹ˆë‹¤.
 * @param {number} reviewId - ìˆ˜ì •í•  ë¦¬ë·° ID
 */
function editReview(reviewId) {
    // 1. í˜„ì¬ ìˆ˜ì • ì¤‘ì¸ ë‹¤ë¥¸ í¼ì´ ìˆëŠ”ì§€ í™•ì¸í•˜ê³  ë‹«ê¸°
    const activeForm = document.querySelector('.edit-inline-form[data-is-editing="true"]');
    if (activeForm && parseInt(activeForm.dataset.reviewId) !== reviewId) {
        const activeReviewId = parseInt(activeForm.dataset.reviewId);
        cancelEdit(activeReviewId);
    }

    const reviewContentWrapper = document.getElementById(`review-content-${reviewId}`);
    const editForm = document.querySelector(`.edit-inline-form[data-review-id="${reviewId}"]`);

    if (reviewContentWrapper && editForm) {
        // 2. ë¦¬ë·° ë‚´ìš© ìˆ¨ê¸°ê³  í¼ ë³´ì´ê¸°
        reviewContentWrapper.style.display = 'none';
        editForm.style.display = 'block';
        editForm.setAttribute('data-is-editing', 'true');
        
        // 3. í¼ì— í¬ì»¤ìŠ¤ ì£¼ê¸°
        const textarea = editForm.querySelector('.edit-review-textarea');
        if (textarea) textarea.focus();
        
        // 4. ìŠ¤í¬ë¡¤ ì¡°ì • (ë¦¬ë·° ëª©ë¡ì˜ ë§¨ ìœ„ë¡œ ìŠ¤í¬ë¡¤í•˜ì—¬ ìˆ˜ì •í•  ë¦¬ë·°ê°€ ì˜ ë³´ì´ë„ë¡)
        const reviewList = document.getElementById('review-list');
        const item = document.getElementById(`review-item-${reviewId}`);
        if (reviewList && item) {
             reviewList.scrollTop = item.offsetTop - reviewList.offsetTop - 10; // 10px ì—¬ë°±
        }
    }
}

/**
 * â­ ìˆ˜ì • í¼ì„ ë‹«ê³  ì›ë˜ ë¦¬ë·° ë‚´ìš©ìœ¼ë¡œ ë˜ëŒë¦½ë‹ˆë‹¤.
 * @param {number} reviewId - ë¦¬ë·° ID
 */
function cancelEdit(reviewId) {
    const reviewContentWrapper = document.getElementById(`review-content-${reviewId}`);
    const editForm = document.querySelector(`.edit-inline-form[data-review-id="${reviewId}"]`);
    
    if (reviewContentWrapper && editForm) {
        // 1. í¼ ìˆ¨ê¸°ê³  ë¦¬ë·° ë‚´ìš© ë³´ì´ê¸°
        editForm.style.display = 'none';
        editForm.removeAttribute('data-is-editing');
        reviewContentWrapper.style.display = 'block';
        
        // 2. ìˆ˜ì • ì¤‘ì´ì—ˆë˜ í¼ì˜ ë‚´ìš© ì´ˆê¸°í™” (ë¦¬ë·° ë‚´ìš©ìœ¼ë¡œ)
        const ratingContainer = editForm.querySelector('.edit-inline-rating');
        const initialRating = parseInt(ratingContainer.dataset.initialRating);
        const initialContent = reviewContentWrapper.querySelector('.review-body').innerText;
        
        editForm.querySelector('.edit-review-textarea').value = initialContent;
        ratingContainer.setAttribute('data-current-rating', initialRating);
        updateStarRating(initialRating, ratingContainer);
    }
}

/**
 * â­ ìˆ˜ì •ëœ ë‚´ìš©ì„ ì €ì¥í•˜ê³  APIë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤.
 * @param {number} reviewId - ìˆ˜ì •í•  ë¦¬ë·° ID
 * @param {HTMLElement} saveButton - í´ë¦­ëœ ì €ì¥ ë²„íŠ¼ ìš”ì†Œ
 */
async function saveEditReview(reviewId, saveButton) {
    const editForm = saveButton.closest('.edit-inline-form');
    if (!editForm) return alert("ìˆ˜ì • í¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    if (!senderId) return alert("'ë³´ë‚´ëŠ” ì‚¬ëŒ'ì„ ì„ íƒí•´ì•¼ ìˆ˜ì •ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤. (API í˜¸ì¶œì— í•„ìš”)"); 

    const editedText = editForm.querySelector('.edit-review-textarea').value.trim();
    const ratingContainer = editForm.querySelector('.edit-inline-rating');
    
    // data-current-ratingì—ì„œ í˜„ì¬ ì„ íƒëœ í‰ì ì„ ê°€ì ¸ì˜¤ê³ , ì—†ìœ¼ë©´ ì´ˆê¸° í‰ì ì„ ì‚¬ìš©
    const editedRating = parseInt(ratingContainer.getAttribute('data-current-rating') || ratingContainer.dataset.initialRating);

    if (editedRating === 0) {
        return alert("ë³„ì ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
    }
    if (editedText.length < 5) {
        return alert("ë¦¬ë·° ë‚´ìš©ì„ 5ì ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”.");
    }
    
    // ë²„íŠ¼ ë¹„í™œì„±í™” (ì¤‘ë³µ í´ë¦­ ë°©ì§€)
    saveButton.disabled = true;

    const requestBody = {
        authorUserSeq: senderId, 
        targetUserSeq: targetUserSeqForReview, 
        careReview: editedText,
        careRating: editedRating,
        targetRole: "provider" 
    };

    try {
        const response = await fetch(`/api/care-reviews/${reviewId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(requestBody)
        });

        if (!response.ok) {
            const errorData = await response.json().catch(() => ({ message: 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜' }));
            throw new Error(`ë¦¬ë·° ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (${errorData.message})`);
        }

        alert("ë¦¬ë·°ê°€ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!");
        
        // í¼ ë‹«ê³  ì „ì²´ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
        cancelEdit(reviewId); 
        fetchReviews(targetUserSeqForReview); 

    } catch (error) {
        console.error("ë¦¬ë·° ìˆ˜ì • ì˜¤ë¥˜:", error);
        alert(error.message || "ë¦¬ë·° ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
    } finally {
        saveButton.disabled = false; // ë²„íŠ¼ ë‹¤ì‹œ í™œì„±í™”
    }
}


async function deleteReview(reviewId) {
    if (!senderId) return alert("'ë³´ë‚´ëŠ” ì‚¬ëŒ'ì„ ì„ íƒí•´ì•¼ ì‚­ì œê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤. (API í˜¸ì¶œì— í•„ìš”)"); 
    if (!confirm("ì •ë§ë¡œ ì´ ë¦¬ë·°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

    // ì‚­ì œ ì „ì— í˜¹ì‹œ ìˆ˜ì • í¼ì´ ì—´ë ¤ìˆì—ˆë‹¤ë©´ ë‹«ìŠµë‹ˆë‹¤. (clean up)
    const activeForm = document.querySelector('.edit-inline-form[data-is-editing="true"]');
    if (activeForm && parseInt(activeForm.dataset.reviewId) === reviewId) {
        activeForm.removeAttribute('data-is-editing');
    }
    
    try {
        // ì´ API ê²½ë¡œëŠ” ì‚¬ìš©ìì˜ ì„œë²„ í™˜ê²½ì— ë§ê²Œ ì¡°ì •ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.
        const response = await fetch(`/api/care-reviews/${reviewId}?authorUserSeq=${senderId}`, {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' }
        });

        if (!response.ok) {
            const errorData = await response.json().catch(() => ({ message: 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜' }));
            throw new Error(`ë¦¬ë·° ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (${errorData.message})`);
        }

        alert("ë¦¬ë·°ê°€ ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤!");
        fetchReviews(targetUserSeqForReview); 

    } catch (error) {
        console.error("ë¦¬ë·° ì‚­ì œ ì˜¤ë¥˜:", error);
        alert(error.message || "ë¦¬ë·° ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
    }
}
</script>
</body>
</html>