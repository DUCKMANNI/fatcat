<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="utf-8">
<title>1:1 ì±„íŒ… + CareSession í…ŒìŠ¤íŠ¸</title>
<style>
/* ---------------------------------------------------------------------------------- */
/* 1. ê¸°ë³¸ ì±„íŒ… UI ìŠ¤íƒ€ì¼ */
/* ---------------------------------------------------------------------------------- */
body { font-family: Arial; margin:0; padding:0; display:flex; flex-direction:column; height:100vh; }
#user-select { display:flex; justify-content:center; gap:15px; padding:10px; border-bottom:1px solid #ddd; background:#fafafa; }
select, input, textarea { padding:5px 10px; border-radius:6px; border:1px solid #ccc; }
#chat-container { 
    flex-grow:1; display:flex; flex-direction:column; border:1px solid #ddd; 
    margin:10px; border-radius:8px; overflow:hidden; 
    position: relative; /* íŒì—…ì„ ìœ„í•´ í•„ìˆ˜ */
} 
#message-area { flex-grow:1; padding:10px; overflow-y:auto; background:#f7f7f7; display:flex; flex-direction:column; }
.message-row { display: flex; margin-bottom: 10px; align-items: flex-end; }
.message-row.sent { justify-content: flex-end; }
.message-row.received { justify-content: flex-start; }

/* í”„ë¡œí•„ ì´ë¯¸ì§€ (ë¹ˆ ë™ê·¸ë¼ë¯¸) ìŠ¤íƒ€ì¼ ë° í´ë¦­ ê°€ëŠ¥ ì„¤ì • */
.profile-placeholder { 
    width: 40px; 
    height: 40px; 
    border-radius: 50%; 
    background-color: #ccc; 
    margin-right: 10px; 
    align-self: flex-start; 
    flex-shrink: 0;
    cursor: pointer; /* í´ë¦­ ê°€ëŠ¥í•˜ë„ë¡ ì»¤ì„œ ë³€ê²½ */
}

/* ë©”ì‹œì§€ ë‚´ìš© ë° ì‹œê°„ í¬í•¨í•˜ëŠ” ì»¨í…ì¸  ë©í¼ */
.message-content-wrapper { 
    display: flex; 
    flex-direction: column; 
    max-width: 70%; 
}
.message-row.sent .message-content-wrapper { align-items: flex-end; }
.message-row.received .message-content-wrapper { align-items: flex-start; }

/* ë‹‰ë„¤ì„ -> User Name ìŠ¤íƒ€ì¼ ë° í´ë¦­ ê°€ëŠ¥ ì„¤ì • */
.user-nickname { 
    font-size: 12px; color: #555; margin-bottom: 4px; 
    cursor: pointer; /* í´ë¦­ ê°€ëŠ¥í•˜ë„ë¡ ì»¤ì„œ ë³€ê²½ */
}
.message-row.sent .user-nickname { display: none; }

/* ê¸°ì¡´ ë©”ì‹œì§€ ë°•ìŠ¤ ìŠ¤íƒ€ì¼ */
.message { padding:8px 12px; border-radius:18px; max-width:100%; word-wrap:break-word; position: relative; } 
.sent .message { background:#dcf8c6; }
.received .message { background:#fff; }

/* ì‹œê°„ ìŠ¤íƒ€ì¼ */
.message-time { font-size: 10px; color: #555; margin-top: 2px; align-self: flex-end; white-space: nowrap; }
.message-row.received .message-time { align-self: flex-start; }
.care-request { background:#FFFACD; padding:6px 10px; border-radius:12px; margin-top:4px; }
.care-confirmed { background:#8FBC8F; padding:6px 10px; border-radius:12px; margin-top:4px; }

/* ì…ë ¥ ì˜ì—­ ìŠ¤íƒ€ì¼ */
#input-area { display:flex; padding:10px; border-top:1px solid #ddd; gap:10px; }
#message-input { flex-grow:1; padding:8px; border-radius:20px; border:1px solid #ccc; outline:none; }
#send-button, #care-toggle { padding:8px 16px; border:none; background:#CD853F; color:white; border-radius:20px; cursor:pointer; }
#care-form { display:none; flex-direction:column; gap:5px; padding:10px; background:#fafafa; border-top:1px solid #ddd; }
#care-form input, #care-form select, #care-form textarea { width:100%; }
#confirm-care { background:#8FBC8F; color:white; border:none; padding:8px 16px; border-radius:20px; cursor:pointer; }

/* ---------------------------------------------------------------------------------- */
/* 2. ë¦¬ë·° íŒì—… ìŠ¤íƒ€ì¼ */
/* ---------------------------------------------------------------------------------- */

#review-popup {
    position: absolute;
    top: 0;
    right: 0;
    width: 350px;
    height: 100%;
    background: white;
    box-shadow: -2px 0 10px rgba(0,0,0,0.1);
    z-index: 100;
    transform: translateX(100%);
    transition: transform 0.3s ease-in-out;
    display: flex;
    flex-direction: column;
    padding: 15px;
    box-sizing: border-box;
    border-left: 1px solid #ddd;
    overflow-y: auto;
}
#review-popup.show {
    transform: translateX(0);
}
.popup-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}
.popup-header button {
    background: none;
    border: none;
    font-size: 20px;
    cursor: pointer;
}
#review-rating-summary {
    text-align: center;
    padding: 10px 0;
    border-bottom: 1px solid #eee;
    margin-bottom: 15px;
}
#review-rating-summary h3 { margin: 0; font-size: 1.5em; }
#review-rating-summary p { margin: 5px 0 0; color: #666; }
.star-rating { color: gold; font-size: 1.2em; }

/* ë¦¬ë·° ëª©ë¡ ìŠ¤íƒ€ì¼ */
#review-list {
    flex-grow: 1;
    overflow-y: auto;
    padding-right: 5px; /* ìŠ¤í¬ë¡¤ë°” ê³µê°„ */
}
.review-item {
    padding: 10px 0;
    border-bottom: 1px dotted #ddd;
}
.review-item:last-child {
    border-bottom: none;
}
.review-header {
    display: flex;
    justify-content: space-between;
    font-size: 0.9em;
    color: #444;
    margin-bottom: 5px;
}
.review-body {
    font-size: 0.95em;
    color: #333;
}
.review-date {
    font-size: 0.8em;
    color: #999;
}

/* ë¦¬ë·° ë“±ë¡ í¼ ìŠ¤íƒ€ì¼ */
#review-form-area {
    padding-top: 15px;
    border-top: 1px solid #eee;
}
#review-form-area h4 { margin-top: 0; }
#review-form-area textarea {
    width: 100%;
    margin-bottom: 10px;
    box-sizing: border-box;
}
.rating-input {
    margin-bottom: 10px;
}
.rating-input span {
    font-size: 1.5em;
    cursor: pointer;
    color: #ccc; /* ë¹„í™œì„± ë³„ ìƒ‰ìƒ */
}
.rating-input span.active {
    color: gold; /* í™œì„± ë³„ ìƒ‰ìƒ */
}
#submit-review-btn {
    width: 100%;
    padding: 8px;
    background: #007bff;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
}

</style>
<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
</head>
<body>

<div id="user-select">
    <label>ë³´ë‚´ëŠ” ì‚¬ëŒ:
        <select id="sender-select">
            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
            <option value="1" data-username="ê¹€ìœ ì •">User 1</option>
            <option value="2" data-username="ìœ ì •">User 2</option>
            <option value="3" data-username="ê´€ë¦¬ì™•">User 3</option>
        </select>
    </label>
    <label>ë°›ëŠ” ì‚¬ëŒ:
        <select id="receiver-select">
            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
            <option value="1" data-username="ê¹€ìœ ì •">User 1</option>
            <option value="2" data-username="ìœ ì •">User 2</option>
            <option value="3" data-username="ê´€ë¦¬ì™•">User 3</option>
        </select>
    </label>
</div>

<div id="chat-container">
    <div id="message-area"></div>
    <div id="input-area">
        <input type="text" id="message-input" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”...">
        <button id="send-button">ì „ì†¡</button>
        <button id="care-toggle">ëŒë´„ ì˜ˆì•½</button>
    </div>
    <div id="care-form">
        ì‹œì‘ì¼: <input type="datetime-local" id="start-date">
        ì¢…ë£Œì¼: <input type="datetime-local" id="end-date">
        ìƒíƒœ:
        <select id="session-status">
            <option value="REQUESTED">ìš”ì²­</option>
            <option value="CONFIRMED">í™•ì •</option>
            <option value="CANCELLED">ì·¨ì†Œ</option>
        </select>
        ë©”ëª¨: <textarea id="session-note" rows="2" placeholder="ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”"></textarea>
        <button id="confirm-care">ì˜ˆì•½ ì „ì†¡</button>
    </div>
    
    <div id="review-popup">
        <div class="popup-header">
            <h2 id="review-target-name"></h2>
            <button onclick="closeReviewPopup()">Ã—</button>
        </div>
        
        <div id="review-rating-summary">
            <h3 id="avg-rating"></h3>
            <p id="total-reviews"></p>
        </div>

        <div id="review-form-area">
            <h4>ë¦¬ë·° ë“±ë¡</h4>
            <div class="rating-input" id="new-rating">
                <span data-rating="1">â˜…</span>
                <span data-rating="2">â˜…</span>
                <span data-rating="3">â˜…</span>
                <span data-rating="4">â˜…</span>
                <span data-rating="5">â˜…</span>
            </div>
            <textarea id="new-review-text" rows="3" placeholder="ë¦¬ë·° ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”."></textarea>
            <button id="submit-review-btn">ë¦¬ë·° ì‘ì„±</button>
        </div>

        <h4>ë¦¬ë·° ëª©ë¡</h4>
        <div id="review-list">
            </div>
    </div>
</div>

<script>
let senderId = null;
let receiverId = null;
let chatRoomId = null;
let stompClient = null;
let targetUserSeqForReview = null; // í˜„ì¬ ë¦¬ë·° ëŒ€ìƒ ì‚¬ìš©ì ID
let currentRating = 0; // ë¦¬ë·° ë“±ë¡ ì‹œ ì„ íƒëœ ë³„ì 

let userNames = {}; // User Name ë§¤í•‘ ê°ì²´

const messageArea = document.getElementById('message-area');
const messageInput = document.getElementById('message-input');
const sendButton = document.getElementById('send-button');
const careToggle = document.getElementById('care-toggle');
const careForm = document.getElementById('care-form');
const startDateInput = document.getElementById('start-date');
const endDateInput = document.getElementById('end-date');
const confirmCare = document.getElementById('confirm-care');

// --------------------------------------------------------
// LocalStorage í—¬í¼ í•¨ìˆ˜ ğŸ’¥ ì œê±°ë¨ ğŸ’¥
// (DBì˜ status í•„ë“œë¥¼ ì‚¬ìš©í•˜ë¯€ë¡œ ë” ì´ìƒ í•„ìš”í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.)
// --------------------------------------------------------

// --------------------------------------------------------
// ì´ˆê¸°í™” ë° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (User Name ì €ì¥ ë¡œì§ ë°˜ì˜)
// --------------------------------------------------------

window.onload = function() {
    const senderSelect = document.getElementById('sender-select');
    const receiverSelect = document.getElementById('receiver-select');

    // ë“œë¡­ë‹¤ìš´ì—ì„œ user_name ì •ë³´ë¥¼ ì¶”ì¶œí•˜ì—¬ userNamesì— ì €ì¥
    function extractUserNames(selectElement) {
        Array.from(selectElement.options).forEach(option => {
            if (option.value) {
                // data-username ì†ì„± ì‚¬ìš©
                userNames[option.value] = option.dataset.username || `User ${option.value}`;
            }
        });
    }
    extractUserNames(senderSelect);
    extractUserNames(receiverSelect);


    senderSelect.addEventListener('change', async (e) => {
        senderId = parseInt(e.target.value);
        if (senderId && receiverId) await initChatRoom();
    });
    
    receiverSelect.addEventListener('change', async (e) => {
        receiverId = parseInt(e.target.value);
        if (senderId && receiverId) await initChatRoom();
    });

    sendButton.addEventListener('click', sendMessage);
    messageInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') sendMessage();
    });

    careToggle.addEventListener('click', () => {
        careForm.style.display = careForm.style.display === 'none' ? 'flex' : 'none';
    });

    confirmCare.addEventListener('click', sendCareRequest);

    // ë¦¬ë·° ë³„ì  ì„ íƒ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
    document.querySelectorAll('#new-rating span').forEach(star => {
        star.addEventListener('click', () => {
            currentRating = parseInt(star.dataset.rating);
            updateStarRating(currentRating);
        });
    });

    // ë¦¬ë·° ë“±ë¡ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
    document.getElementById('submit-review-btn').addEventListener('click', submitReview);
};

// --------------------------------------------------------
// ëŒë´„ ìš”ì²­/í™•ì • ë¡œì§ (LocalStorage ë¡œì§ ì œê±°)
// --------------------------------------------------------

/**
 * ëŒë´„ ìš”ì²­ ë©”ì‹œì§€ë¥¼ ì„œë²„ë¡œ ì „ì†¡í•©ë‹ˆë‹¤.
 */
function sendCareRequest() {
    const start = startDateInput.value;
    const end = endDateInput.value;
    if (!start || !end) return alert("ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”.");

    // ì´ˆ(seconds)ë¥¼ ì¶”ê°€í•˜ì—¬ ë°±ì—”ë“œ DTO @JsonFormat(pattern = "yyyy-MM-dd'T'HH:mm:ss")ì— ë§ì¶¥ë‹ˆë‹¤.
    const startWithSeconds = start + ':00';
    const endWithSeconds = end + ':00';

    const chatMessage = {
        chatRoomId: chatRoomId,
        senderId: senderId,
        receiverId: receiverId,
        type: "CARE_REQUEST",
        startDate: startWithSeconds,
        endDate: endWithSeconds,
        status: 'REQUESTED',
        note: document.getElementById('session-note').value,
        content: `ëŒë´„ ìš”ì²­: ${start} ~ ${end}`
    };

    stompClient.send("/app/private-chat", {}, JSON.stringify(chatMessage));

    careForm.style.display = 'none';
    startDateInput.value = '';
    endDateInput.value = '';
    // document.getElementById('session-status').value = 'REQUESTED'; // í•´ë‹¹ HTML ìš”ì†ŒëŠ” ì œê±°ë˜ì—ˆìŒ
    document.getElementById('session-note').value = '';
}

/**
 * ëŒë´„ ìš”ì²­ì„ í™•ì •í•˜ëŠ” ë©”ì‹œì§€ë¥¼ ì„œë²„ë¡œ ì „ì†¡í•©ë‹ˆë‹¤.
 * @param {number} sessionId í™•ì •í•  CareSession ID
 * @param {number} senderIdFromMsg ìš”ì²­ ë©”ì‹œì§€ë¥¼ ë³´ë‚¸ ì‚¬ëŒ ID (ìš”ì²­ì)
 */
function confirmCareRequest(sessionId, senderIdFromMsg) {
    const chatMessage = {
        chatRoomId: chatRoomId,
        senderId: senderId, // í™•ì •í•˜ëŠ” ì‚¬ëŒ (ë‚˜)
        receiverId: senderIdFromMsg, // ìš”ì²­ì (ìƒëŒ€ë°©)
        type: "CARE_CONFIRM",
        sessionId: sessionId,
        content: `âœ… ëŒë´„ ì˜ˆì•½ì´ í™•ì •ë˜ì—ˆìŠµë‹ˆë‹¤.`
    };
    stompClient.send("/app/private-chat", {}, JSON.stringify(chatMessage));
}


/**
 * ì‹¤ì‹œê°„ CARE_CONFIRM ë©”ì‹œì§€ ìˆ˜ì‹  ì‹œ,
 * í™”ë©´ì— ì¡´ì¬í•˜ëŠ” ëª¨ë“  í•´ë‹¹ CARE_REQUEST UIë¥¼ ì—…ë°ì´íŠ¸í•˜ì—¬ ë²„íŠ¼ì„ ì œê±°í•˜ê³  í™•ì • ìƒíƒœë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.
 * @param {number} sessionId í™•ì •ëœ ì„¸ì…˜ ID
 * @param {string} confirmedTime í™•ì • ì‹œê°„ ë¬¸ìì—´
 */
function updateCareRequestUI(sessionId, confirmedTime) {
    const requestElements = document.querySelectorAll(`[data-session-id="${sessionId}"]`);
    
    // YYYY-MM-DDTHH:mm:ss -> YYYY-MM-DD HH:mm í˜•ì‹ìœ¼ë¡œ í¬ë§·íŒ…
    const confirmedDate = new Date(confirmedTime.replace(' ', 'T'));
    const formattedDate = `${confirmedDate.getFullYear()}-${(confirmedDate.getMonth() + 1).toString().padStart(2, '0')}-${confirmedDate.getDate().toString().padStart(2, '0')}`;
    const hours = confirmedDate.getHours();
    const minutes = confirmedDate.getMinutes().toString().padStart(2,'0');
    const ampm = hours >= 12 ? 'ì˜¤í›„' : 'ì˜¤ì „';
    const hour12 = hours % 12 === 0 ? 12 : hours % 12;
    const formattedTime = `${formattedDate} ${ampm} ${hour12}:${minutes}`;

    requestElements.forEach(element => {
        // ê¸°ì¡´ í™•ì • ë²„íŠ¼ ì œê±°
        const confirmButton = element.querySelector('.confirm-btn');
        if (confirmButton) {
            confirmButton.remove();
        }
        
        // í™•ì • ìƒíƒœ í‘œì‹œ (ì‹œê°„ ì •ë³´ í¬í•¨)
        const existingStatusSpan = element.querySelector('.care-status');
        if (existingStatusSpan) {
            existingStatusSpan.innerHTML = `[âœ… í™•ì •ë¨ - ${formattedTime}]`;
        } else {
            const confirmedSpan = document.createElement('span');
            confirmedSpan.classList.add('care-status'); // í´ë˜ìŠ¤ ì¶”ê°€
            confirmedSpan.style.color = 'green';
            confirmedSpan.style.fontWeight = 'bold';
            confirmedSpan.innerText = `[âœ… í™•ì •ë¨ - ${formattedTime}]`;
            element.querySelector('.care-request').appendChild(confirmedSpan);
        }
    });
}

// --------------------------------------------------------
// ì±„íŒ…ë°© ë° ì›¹ì†Œì¼“ ì—°ê²° (ì´ì „ê³¼ ë™ì¼)
// --------------------------------------------------------

async function initChatRoom() {
    if (!senderId || !receiverId) return;
    if (stompClient && stompClient.connected) stompClient.disconnect();

    const res = await fetch(`/api/chat/room?sender=${senderId}&receiver=${receiverId}`);
    const data = await res.json();
    chatRoomId = data.chatSeq;

    const histRes = await fetch(`/api/chat/history?roomId=${chatRoomId}`);
    const history = await histRes.json();
    displayChatHistory(history);

    connectWebSocket();
}

function connectWebSocket() {
    const socket = new SockJS('/ws');
    stompClient = Stomp.over(socket);

    stompClient.connect({}, () => {
        stompClient.subscribe(`/topic/chat/${chatRoomId}`, (message) => {
            const chatMessage = JSON.parse(message.body);
            displayMessage(chatMessage);
            
            // â­ ì‹¤ì‹œê°„ CARE_CONFIRM ë©”ì‹œì§€ ìˆ˜ì‹  ì‹œ UI ì—…ë°ì´íŠ¸
            if (chatMessage.type === "CARE_CONFIRM") {
                updateCareRequestUI(chatMessage.sessionId, chatMessage.confirmedTime);
            }
        });
    }, (error) => console.error("Connection error: ", error));
}

function sendMessage() {
    if (!stompClient || !stompClient.connected) return;
    if (!messageInput.value.trim()) return;

    const chatMessage = {
        chatRoomId: chatRoomId,
        senderId: senderId,
        receiverId: receiverId,
        type: "CHAT",
        content: messageInput.value.trim()
    };

    stompClient.send("/app/private-chat", {}, JSON.stringify(chatMessage));
    messageInput.value = '';
}

// --------------------------------------------------------
// ë¦¬ë·° íŒì—… ê´€ë ¨ í•¨ìˆ˜ (ì´ì „ê³¼ ë™ì¼)
// --------------------------------------------------------

/**
 * í”„ë¡œí•„ì´ë‚˜ ë‹‰ë„¤ì„ í´ë¦­ ì‹œ ë¦¬ë·° íŒì—…ì„ ì—½ë‹ˆë‹¤.
 * @param {number} targetSeq ë¦¬ë·° ëŒ€ìƒ ì‚¬ìš©ì ID
 */
function openReviewPopup(targetSeq) {
    if (!targetSeq || targetSeq === senderId) {
        alert("ë³¸ì¸ì— ëŒ€í•œ ë¦¬ë·°ëŠ” ë“±ë¡í•˜ê±°ë‚˜ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        return;
    }

    targetUserSeqForReview = targetSeq;
    const targetName = userNames[targetSeq] || `User ${targetSeq}`;

    document.getElementById('review-target-name').innerText = `${targetName} ë‹˜ ë¦¬ë·°`;
    document.getElementById('review-popup').classList.add('show');

    // ë¦¬ë·° ëª©ë¡ ë° í‰ì  ê°€ì ¸ì˜¤ê¸°
    fetchReviews(targetSeq);
}

function closeReviewPopup() {
    document.getElementById('review-popup').classList.remove('show');
    targetUserSeqForReview = null;
    currentRating = 0;
    document.getElementById('new-review-text').value = '';
    updateStarRating(0);
}

/**
 * ì„œë²„ì—ì„œ ë¦¬ë·° ëª©ë¡ì„ ê°€ì ¸ì™€ í™”ë©´ì— í‘œì‹œí•©ë‹ˆë‹¤.
 */
async function fetchReviews(targetSeq) {
    const listArea = document.getElementById('review-list');
    const avgRatingElem = document.getElementById('avg-rating');
    const totalReviewsElem = document.getElementById('total-reviews');
    listArea.innerHTML = 'ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';

    try {
        const response = await fetch(`/api/care-reviews?targetUserSeq=${targetSeq}`);
        if (!response.ok) throw new Error('Failed to fetch reviews');
        
        const reviews = await response.json();
        listArea.innerHTML = '';
        
        let totalRating = 0;
        
        if (reviews.length === 0) {
            listArea.innerHTML = '<p style="text-align: center; color: #999;">ë“±ë¡ëœ ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
            avgRatingElem.innerHTML = 'í‰ì : <span class="star-rating">0.0</span>';
            totalReviewsElem.innerText = 'ì´ 0ê°œì˜ ë¦¬ë·°';
            return;
        }

        reviews.forEach(review => {
            totalRating += review.careRating;
            listArea.appendChild(createReviewItem(review));
        });

        // í‰ì  ìš”ì•½ ê³„ì‚° ë° í‘œì‹œ
        const average = (totalRating / reviews.length).toFixed(1);
        const starHtml = 'â˜…'.repeat(Math.round(average)) + 'â˜†'.repeat(5 - Math.round(average));
        
        avgRatingElem.innerHTML = `í‰ì : <span class="star-rating">${average}</span> (${starHtml})`;
        totalReviewsElem.innerText = `ì´ ${reviews.length}ê°œì˜ ë¦¬ë·°`;

    } catch (error) {
        console.error("ë¦¬ë·° ë¡œë“œ ì˜¤ë¥˜:", error);
        listArea.innerHTML = '<p style="color: red;">ë¦¬ë·°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>';
        avgRatingElem.innerHTML = 'í‰ì : <span class="star-rating">--</span>';
        totalReviewsElem.innerText = 'ì´ --ê°œì˜ ë¦¬ë·°';
    }
}

/**
 * ë¦¬ë·° ì•„ì´í…œ DOM ìš”ì†Œë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
 */
function createReviewItem(review) {
    const item = document.createElement('div');
    item.classList.add('review-item');
    
    const starHtml = 'â˜…'.repeat(review.careRating) + 'â˜†'.repeat(5 - review.careRating);
    const date = new Date(review.createDate);
    const dateString = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}`;

    item.innerHTML = `
        <div class="review-header">
            <span>${review.authorNickname}</span>
            <span class="star-rating">${starHtml}</span>
        </div>
        <div class="review-body">${review.careReview}</div>
        <div class="review-date">${dateString}</div>
    `;
    return item;
}

/**
 * ë³„ì  ì•„ì´ì½˜ì˜ í™œì„±í™” ìƒíƒœë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
 */
function updateStarRating(rating) {
    document.querySelectorAll('#new-rating span').forEach(star => {
        if (parseInt(star.dataset.rating) <= rating) {
            star.classList.add('active');
        } else {
            star.classList.remove('active');
        }
    });
}

/**
 * ìƒˆë¡œìš´ ë¦¬ë·°ë¥¼ ë“±ë¡í•©ë‹ˆë‹¤.
 * ë°±ì—”ë“œ DTOì— ë§ê²Œ senderIdë¥¼ authorUserSeqë¡œ ì „ì†¡í•©ë‹ˆë‹¤.
 */
async function submitReview() {
    const reviewText = document.getElementById('new-review-text').value.trim();

    if (currentRating === 0) {
        return alert("ë³„ì ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
    }
    if (reviewText.length < 5) {
        return alert("ë¦¬ë·° ë‚´ìš©ì„ 5ì ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”.");
    }
    if (!targetUserSeqForReview || targetUserSeqForReview === senderId) {
        return alert("ë¦¬ë·° ëŒ€ìƒì„ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    }
    if (!senderId) {
        return alert("ë¦¬ë·°ë¥¼ ì‘ì„±í•  'ë³´ë‚´ëŠ” ì‚¬ëŒ'ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
    }

    const requestBody = {
        // ë°±ì—”ë“œ DTOì— ë§ê²Œ senderIdë¥¼ ì‘ì„±ìë¡œ ì„¤ì •
        authorUserSeq: senderId, 
        targetUserSeq: targetUserSeqForReview,
        careReview: reviewText,
        careRating: currentRating,
        targetRole: "provider" 
    };

    try {
        const response = await fetch('/api/care-reviews', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestBody)
        });

        if (!response.ok) {
            // ì„œë²„ì—ì„œ ì—ëŸ¬ ë©”ì‹œì§€ë¥¼ JSONìœ¼ë¡œ ë°˜í™˜í•˜ë©´ ì²˜ë¦¬
            const errorData = await response.json().catch(() => ({ message: 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜' }));
            throw new Error(`ë¦¬ë·° ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (${errorData.message})`);
        }

        alert("ë¦¬ë·°ê°€ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!");
        
        // í¼ ì´ˆê¸°í™”
        document.getElementById('new-review-text').value = '';
        currentRating = 0;
        updateStarRating(0);

        // ë¦¬ë·° ëª©ë¡ ìƒˆë¡œê³ ì¹¨
        fetchReviews(targetUserSeqForReview);

    } catch (error) {
        console.error("ë¦¬ë·° ë“±ë¡ ì˜¤ë¥˜:", error);
        alert(error.message || "ë¦¬ë·° ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
    }
}

// --------------------------------------------------------
// ë©”ì‹œì§€ í‘œì‹œ (í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€) - DB ìƒíƒœ ë°˜ì˜
// --------------------------------------------------------

/**
 * ë‚ ì§œ ë¬¸ìì—´(YYYY-MM-DDTHH:mm:ss)ì„ í¬ë§·íŒ…í•©ë‹ˆë‹¤.
 * @param {string} dateString DTOì—ì„œ ë„˜ì–´ì˜¨ ë‚ ì§œ ë¬¸ìì—´
 * @returns {string} í¬ë§·íŒ…ëœ ë‚ ì§œ ë¬¸ìì—´ (YYYY-MM-DD HH:mm)
 */
function formatDateTime(dateString) {
    if (!dateString) return '';
    // YYYY-MM-DDTHH:mm:ss ë˜ëŠ” YYYY-MM-DD HH:mm:ss í˜•íƒœë¥¼ íŒŒì‹±
    const date = new Date(dateString.replace(' ', 'T'));
    const year = date.getFullYear();
    const month = (date.getMonth() + 1).toString().padStart(2, '0');
    const day = date.getDate().toString().padStart(2, '0');
    const hours = date.getHours().toString().padStart(2, '0');
    const minutes = date.getMinutes().toString().padStart(2, '0');
    return `${year}-${month}-${day} ${hours}:${minutes}`;
}


/**
 * ë‹¨ì¼ ë©”ì‹œì§€ë¥¼ í™”ë©´ì— í‘œì‹œí•©ë‹ˆë‹¤.
 * @param {object} chatMessage ë°±ì—”ë“œì—ì„œ ë°›ì€ ChatMessageDto ê°ì²´
 */
function displayMessage(chatMessage) {
    const isSent = chatMessage.senderId === senderId;
    const senderIdForPopup = chatMessage.senderId; // ë¦¬ë·° ëŒ€ìƒì€ ë©”ì‹œì§€ ë³´ë‚¸ ì‚¬ëŒ

    const senderName = userNames[chatMessage.senderId] || `User ${chatMessage.senderId}`;
    
    const messageRow = document.createElement('div');
    messageRow.classList.add('message-row');
    messageRow.classList.add(isSent ? 'sent' : 'received');
    
    // â­ ì‹œê° ì •ë³´ í¬ë§·íŒ… (DB ì €ì¥ ì‹œê°„)
    const timeToFormat = chatMessage.timestamp ? new Date(chatMessage.timestamp.replace(' ', 'T')) : new Date();
    const hours = timeToFormat.getHours();
    const minutes = timeToFormat.getMinutes().toString().padStart(2,'0');
    const ampm = hours >= 12 ? 'ì˜¤í›„' : 'ì˜¤ì „';
    const hour12 = hours % 12 === 0 ? 12 : hours % 12;
    const timeString = `${ampm} ${hour12}:${minutes}`;
    
    // 2. ë°›ì€ ë©”ì‹œì§€ì¸ ê²½ìš°ì—ë§Œ í”„ë¡œí•„ í”Œë ˆì´ìŠ¤í™€ë” ì¶”ê°€
    if (!isSent) {
        const profilePlaceholder = document.createElement('div');
        profilePlaceholder.classList.add('profile-placeholder');
        // í”„ë¡œí•„ í´ë¦­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        profilePlaceholder.addEventListener('click', () => openReviewPopup(senderIdForPopup));
        messageRow.appendChild(profilePlaceholder);
    }

    // 3. User Name, ë©”ì‹œì§€ ë³¸ë¬¸, ì‹œê°„ì„ ë‹´ëŠ” content wrapper ìƒì„±
    const contentWrapper = document.createElement('div');
    contentWrapper.classList.add('message-content-wrapper');

    // User Name ì¶”ê°€ (ë°›ì€ ë©”ì‹œì§€ì—ë§Œ í‘œì‹œ)
    if (!isSent) {
        const nameDiv = document.createElement('div');
        nameDiv.classList.add('user-nickname'); 
        nameDiv.innerText = senderName; 
        // User Name í´ë¦­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        nameDiv.addEventListener('click', () => openReviewPopup(senderIdForPopup));
        contentWrapper.appendChild(nameDiv);
    }

    // ë©”ì‹œì§€ ë³¸ë¬¸
    const messageDiv = document.createElement('div');
    messageDiv.classList.add('message');

    if (chatMessage.type === "CARE_REQUEST") {
        const careDiv = document.createElement('div');
        // â­ data-session-id ì†ì„± ì¶”ê°€ (CARE_CONFIRM ìˆ˜ì‹  ì‹œ UI ì—…ë°ì´íŠ¸ë¥¼ ìœ„í•¨)
        careDiv.setAttribute('data-session-id', chatMessage.sessionId || -1); 
        careDiv.classList.add('care-request');

        // â­ DBì—ì„œ ë„˜ì–´ì˜¨ status í•„ë“œë§Œ ì‚¬ìš©í•©ë‹ˆë‹¤.
        const status = chatMessage.status || 'REQUESTED';
        const sessionId = chatMessage.sessionId || -1;
        const isReceiver = chatMessage.senderId !== senderId;

        let confirmButtonHtml = '';
        let statusDisplay = '';

        // â­ status í•„ë“œë¥¼ ê¸°ì¤€ìœ¼ë¡œ ìƒíƒœ í‘œì‹œ ë° ë²„íŠ¼ ê²°ì •
        if (status === 'REQUESTED' && isReceiver) {
            confirmButtonHtml = `<button class="confirm-btn" data-session-id="${sessionId}" data-sender-id="${chatMessage.senderId}">í™•ì •</button>`;
        } else if (status === 'CONFIRMED') {
            // â­ í™•ì • ì‹œê°„ í¬ë§·íŒ… ë° í‘œì‹œ
            const formattedConfirmTime = chatMessage.confirmedTime ? 
                formatDateTime(chatMessage.confirmedTime) : 
                'ì‹œê°„ ì •ë³´ ì—†ìŒ';
            statusDisplay = `<span class="care-status" style="color: green; font-weight: bold;">[âœ… í™•ì •ë¨ - ${formattedConfirmTime}]</span>`;
        } else if (status === 'CANCELLED') {
            statusDisplay = `<span class="care-status" style="color: red; font-weight: bold;">[âŒ ì·¨ì†Œë¨]</span>`;
        }
        
        // â­ ëŒë´„ ê¸°ê°„ í¬ë§·íŒ…
        const formattedStartDate = formatDateTime(chatMessage.startDate);
        const formattedEndDate = formatDateTime(chatMessage.endDate);


        careDiv.innerHTML = `
            <div style="font-weight: bold;">${chatMessage.content}</div>
            <div style="font-size: 0.9em;">ê¸°ê°„: ${formattedStartDate} ~ ${formattedEndDate}</div>
            <div style="font-size: 0.9em;">ë©”ëª¨: ${chatMessage.note || 'ì—†ìŒ'}</div>
            ${statusDisplay}
            ${confirmButtonHtml}
        `;
        messageDiv.appendChild(careDiv);

        // í™•ì • ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        if (status === 'REQUESTED' && isReceiver) {
            const confirmButton = careDiv.querySelector('.confirm-btn');
            if (confirmButton) {
                confirmButton.addEventListener('click', (event) => {
                    const session_Id = parseInt(event.target.dataset.sessionId);
                    const sender_Id = parseInt(event.target.dataset.senderId);
                    if (session_Id !== -1) {
                        // ì„œë²„ë¡œ í™•ì • ë©”ì‹œì§€ ì „ì†¡
                        confirmCareRequest(session_Id, sender_Id);

                        // â­ UI ì¦‰ì‹œ ì—…ë°ì´íŠ¸ (ë¡œì»¬ì—ì„œë§Œ ì—…ë°ì´íŠ¸, ì‹¤ì œ í™•ì •ì€ ì„œë²„ ì‘ë‹µ í›„ ê°±ì‹ ë˜ì§€ë§Œ, UXë¥¼ ìœ„í•´ ì¦‰ì‹œ ë³€ê²½ ì‹œë„)
                        // ì£¼ì˜: ì´ ë¡œì§ì€ ì„œë²„ ì‘ë‹µ(CARE_CONFIRM)ì„ ê¸°ë‹¤ë¦¬ëŠ” ê²ƒì´ ë” ì•ˆì „í•˜ì§€ë§Œ, ë¹ ë¥¸ UXë¥¼ ìœ„í•´ ì„ì‹œë¡œ ì¦‰ì‹œ ë³€ê²½
                        const tempConfirmedTime = new Date().toISOString().replace('T', ' ').substring(0, 19);
                        updateCareRequestUI(session_Id, tempConfirmedTime);
                    }
                });
            }
        }

    } else if (chatMessage.type === "CARE_CONFIRM") {
        messageDiv.classList.add('care-confirmed');
        messageDiv.innerText = chatMessage.content;
    } else {
        messageDiv.innerText = chatMessage.content;
    }
    
    contentWrapper.appendChild(messageDiv);
    
    const timeDiv = document.createElement('div');
    timeDiv.classList.add('message-time');
    timeDiv.innerText = timeString;
    contentWrapper.appendChild(timeDiv);

    messageRow.appendChild(contentWrapper);

    messageArea.appendChild(messageRow);
    messageArea.scrollTop = messageArea.scrollHeight;
}

function displayChatHistory(history) {
    messageArea.innerHTML = '';
    if (history && Array.isArray(history)) {
        history.forEach(msg => displayMessage(msg)); 
    }
}
</script>

</body>
</html>