<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{shared/layout}">
<head>
<title>FatCat 1:1 Chat</title>
<meta charset="UTF-8">
<style>
/* body {
	font-family: Arial, sans-serif;
	background-color: #f0f0f0;
	padding: 20px;
}
 */
#chat-container {
	max-width: 600px;
	margin: auto;
	background-color: white;
	padding: 20px;
	border-radius: 50px;
	box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
}

h2 {
	text-align: center;
	color: #333;
}

#chat-window {
	height: 400px;
	border: 1px solid #ddd;
	overflow-y: auto;
	padding: 10px;
	margin-bottom: 10px;
	border-radius: 4px;
	background-color: #fafafa;
}

#chat-window p {
	margin: 5px 0;
	padding: 5px;
	border-radius: 5px;
}

.message-sent {
	text-align: right;
	background-color: #e2f0e2;
}

.message-received {
	text-align: left;
	background-color: #f0e2e2;
}

.info-message {
	text-align: center;
	color: #888;
	font-style: italic;
}

.input-group {
	display: flex;
	margin-top: 10px;
}

.input-group input {
	flex-grow: 1;
	padding: 10px;
	border: 1px solid #ddd;
	border-radius: 4px;
	margin-right: 5px;
}

.input-group button {
	padding: 10px 15px;
	background-color: #D2B48C;
	color: white;
	border: none;
	border-radius: 4px;
	cursor: pointer;
}

.input-group button:hover {
	background-color: #CD853F;
}

#connect-group {
	margin-bottom: 20px;
	text-align: center;
}

#connect-group input, #connect-group button {
	margin: 5px;
}
</style>
</head>
<body>
<div layout:fragment="content" class="container mt-5">
	<div id="chat-container">
		<h2>FatCat 1:1 Chat</h2>
		<div id="connect-group">
			<input type="text" id="username" placeholder="내 ID 입력">
			<button onclick="connect()">채팅 시작</button>
		</div>

		<div id="chat-window"></div>

		<div class="input-group">
			<input type="text" id="receiver" placeholder="상대방 ID 입력"> <input
				type="text" id="message" placeholder="메시지 입력..."
				onkeypress="if(event.keyCode==13) sendMessage()">
			<button onclick="sendMessage()">보내기</button>
		</div>
	</div>

	<script
		src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.0/sockjs.min.js"></script>
	<script
		src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
	<script>
    let stompClient = null;
    let username = null;

    function connect() {
        username = document.getElementById('username').value.trim();
        if (username) {
            const socket = new SockJS('/ws-fatcat');
            stompClient = Stomp.over(socket);

            stompClient.connect({}, function (frame) {
                console.log('Connected: ' + frame);
                document.getElementById('connect-group').innerHTML = `<p><strong>${username}</strong>님, 환영합니다! 🥳</p>`;

                stompClient.subscribe(`/user/${username}/private`, function (message) {
                    console.log("메시지 수신:", message.body);
                    const receivedMessage = JSON.parse(message.body);
                    const type = (receivedMessage.sender === username) ? 'sent' : 'received';
                    showMessage(receivedMessage, type);
                });
                
                stompClient.send("/pub/private-chat", {}, JSON.stringify({
                    sender: username,
                    receiver: username,
                    content: "채팅방에 입장했습니다.",
                    type: "JOIN"
                }));
            }, function(error) {
                console.error('STOMP error: ' + error);
                alert('연결 실패: ' + error);
            });
        } else {
            alert("ID를 입력해주세요.");
        }
    }
    
    // **수정된 sendMessage() 함수**
    function sendMessage() {
        const receiver = document.getElementById('receiver').value.trim();
        const message = document.getElementById('message').value.trim();
        
        if (message && receiver && stompClient) {
            const chatMessage = {
                sender: username,
                receiver: receiver,
                content: message,
                type: 'CHAT'
            };
            
            // 1. 서버로 메시지 전송 (수신자에게 전달)
            stompClient.send("/pub/private-chat", {}, JSON.stringify(chatMessage));
            
            // 2. 보낸 메시지를 자신의 화면에 즉시 표시
            showMessage(chatMessage, 'sent');
            
            // 3. 메시지 입력창 초기화
            document.getElementById('message').value = '';
        } else {
            alert("받는 사람 ID와 메시지를 입력해주세요.");
        }
    }

    // **수정된 showMessage() 함수**
    function showMessage(message, type) {
        const chatWindow = document.getElementById('chat-window');
        const p = document.createElement('p');
        
        if (message.type === 'JOIN' || message.type === 'LEAVE') {
            p.classList.add('info-message');
            p.innerText = message.content;
        } else {
            if (type === 'sent') {
                p.classList.add('message-sent');
                p.innerText = message.content;
            } else {
                p.classList.add('message-received');
                p.innerText = `${message.sender}: ${message.content}`;
            }
        }
        chatWindow.appendChild(p);
        chatWindow.scrollTop = chatWindow.scrollHeight;
    }
</script>
</div>
</body>
</html>