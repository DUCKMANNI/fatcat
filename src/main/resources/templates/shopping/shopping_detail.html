<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{shopping/layout}">
<head>
<meta charset="UTF-8">
<title>ì‡¼í•‘ëª° ìƒí’ˆ ìƒì„¸ë³´ê¸°</title>
</head>
<body>
	<!-- âœ… í­/ë†’ì´ í•œ ë²ˆì— ì¡°ì •: max-widthì™€ --box-h ìˆ«ìë§Œ ë°”ê¾¸ë©´ ë¨ -->
	<div layout:fragment="shopContent"
		class="container my-3 d-flex flex-column align-items-center mt-5"
		style="max-width: 1200px; --box-h: 520px;">

		<!-- ===== ìƒë‹¨: ëŒ€í‘œì´ë¯¸ì§€ / ìƒí’ˆì •ë³´ (ê°™ì€ ë†’ì´, ê°€ìš´ë° ì •ë ¬) ===== -->
		<div class="row g-4 align-items-stretch w-100">

			<!-- ëŒ€í‘œ ì´ë¯¸ì§€ -->
			<div class="col-md-6 d-flex">
				<!-- ê¸°ì¡´ product-img-box ìŠ¤íƒ€ì¼ì´ ê²¹ì¹¨ ì›ì¸ì´ì—ˆì„ ìˆ˜ ìˆìœ¼ë‹ˆ ì¸ë¼ì¸ë¡œ ì™„ì „ ì œì–´ -->
				<div
					class="flex-fill d-flex align-items-center justify-content-center"
					style="height: var(--box-h); position: static !important; overflow: hidden;">
					<img
						th:src="${product.productImageList.^[imageTypeCode == 'm']?.fileName}"
						th:alt="${product.productName}" class="w-100 h-100"
						style="object-fit: contain;">
				</div>
			</div>

			<!-- ìƒí’ˆ ì •ë³´ -->
			<div class="col-md-6 d-flex">
				<div class="flex-fill p-4 d-flex flex-column"
					style="min-height: var(--box-h);">
					<h3 th:text="${product.productName}">ìƒí’ˆëª…</h3>
					<p class="mb-2" id="starRating">
					<!-- <p class="mb-2">
						â˜…â˜…â˜…â˜…â˜… <span class="text-muted">(0ê°œ)</span>
					</p> -->

					<form th:action="@{/shopping/cart/add}" method="post"
						class="mt-auto">
						<input type="hidden" name="productCode"
							th:value="${product.productCode}">
						<div id="orderBox"
							class="d-flex align-items-center mb-4 qty-group"
							th:attr="data-unit-price=${product.productPrice}, data-min=1, data-max=99">

							<button class="btn btn-outline-secondary btn-qty" type="button"
								data-op="minus">-</button>
							<input type="number"  name="qty"
								class="form-control text-center mx-2 qty-input"
								style="width: 70px;" value="1" min="1" max="99">
							<button class="btn btn-outline-secondary btn-qty" type="button"
								data-op="plus">+</button>

							<p class="ms-3 h5 mb-0 price-text"
								th:text="'â‚© ' + ${#numbers.formatInteger(product.productPrice, 3, 'COMMA')}">
							</p>
						</div>

						<div class="d-flex gap-2 mt-3">
							<button class="btn btn-outline-dark flex-fill" type="submit"
								style="font-size: 20px; border-radius: 999px;" onclick="addToCart('[[${product.productCode}]]')">ì¥ë°”êµ¬ë‹ˆ</button>
							<button class="btn btn-fatcat flex-fill" type="button"
								style="font-size: 20px; border-radius: 999px;"
								onclick="location.href='/orders/buyNow?productCode=[[${product.productCode}]]'">ë°”ë¡œêµ¬ë§¤</button>
						</div>
					</form>

				</div>
			</div>
		</div>


		<div class="mt-5 w-100">
			<!-- íƒ­ ë©”ë‰´ -->
			<ul class="nav nav-tabs" id="productTab" role="tablist">
				<li class="nav-item" role="presentation">
					<button class="nav-link active" id="detail-tab"
						data-bs-toggle="tab" data-bs-target="#detail" type="button"
						role="tab">ìƒí’ˆ ìƒì„¸</button>
				</li>
				<li class="nav-item" role="presentation">
					<button class="nav-link" id="review-tab" data-bs-toggle="tab"
						data-bs-target="#review" type="button" role="tab">ë¦¬ë·°</button>
				</li>
			</ul>

			<!-- íƒ­ ë‚´ìš© -->
			<div class="tab-content p-4 border border-top-0"
				id="productTabContent">
				<!-- âœ… ì¤‘ë³µ tab-pane ì œê±° & id ì¤‘ë³µ ì œê±° -->
				<div class="tab-pane fade show active text-center" id="detail"
					role="tabpanel">
					<div class="border rounded d-inline-block"
						style="max-width: 100%; width: 100%; position: static !important; overflow: hidden;">
						<img
							th:src="${product.productImageList.^[imageTypeCode == 'd']?.fileName}"
							th:alt="${product.productName}"
							style="max-width: 100%; height: auto; object-fit: contain;">
					</div>
				</div>

				<!-- <div class="tab-pane fade" id="review" role="tabpanel">
				    <h5 class="mb-4">ìƒí’ˆ ë¦¬ë·°</h5>
				
				    í‰ê·  í‰ì 
				    <div id="avgRating" class="mb-3"></div>
				
				    ë¦¬ë·° ì‘ì„± í¼
				    <div class="mb-4">
				        <textarea id="reviewContent" class="form-control mb-2" placeholder="ë¦¬ë·° ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
				        <select id="reviewRating" class="form-select w-auto mb-2">
				            <option value="5">â˜…â˜…â˜…â˜…â˜…</option>
				            <option value="4">â˜…â˜…â˜…â˜…â˜†</option>
				            <option value="3">â˜…â˜…â˜…â˜†â˜†</option>
				            <option value="2">â˜…â˜…â˜†â˜†â˜†</option>
				            <option value="1">â˜…â˜†â˜†â˜†â˜†</option>
				        </select>
				        <button id="submitReview" class="btn btn-primary">ë¦¬ë·° ì‘ì„±</button>
				    </div>
				
				    ë¦¬ë·° ë¦¬ìŠ¤íŠ¸
				    <div id="reviewList"></div>
				</div> -->
				
				<div class="tab-pane fade" id="review" role="tabpanel">
					<h5 class="mb-4">ìƒí’ˆ ë¦¬ë·°</h5>
					<p>ì•„ì§ ë“±ë¡ëœ ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
				</div>

			</div>
		</div>
		
		<!-- ëª¨ë‹¬ -->
<div class="modal fade" id="cartModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content" style="border-radius: 20px; text-align:center;">
      <div class="modal-body">
        <p style="font-size:20px; font-weight:bold;">ğŸ›’ ìƒí’ˆì´ ì¥ë°”êµ¬ë‹ˆì— ë‹´ê²¼ìŠµë‹ˆë‹¤!</p>
        <div class="d-flex justify-content-center gap-3 mt-3">
          <button class="btn btn-outline-brown" data-bs-dismiss="modal">ê³„ì† ì‡¼í•‘í•˜ê¸°</button>
          <a href="/cart/list" class="btn btn-fatcat">ì¥ë°”êµ¬ë‹ˆë¡œ ê°€ê¸°</a>
        </div>
      </div>
    </div>
  </div>
</div>

		<script th:inline="javascript">
		(function () {
			  const box = document.querySelector('#orderBox');
			  if (!box) return;

			  const unitPrice = parseInt(box.dataset.unitPrice || '0', 10);
			  const min = parseInt(box.dataset.min || '1', 10);
			  const max = parseInt(box.dataset.max || '99', 10);

			  const input = box.querySelector('.qty-input');
			  const priceEl = box.querySelector('.price-text');
			  const minusBtn = box.querySelector('.btn-qty[data-op="minus"]');
			  const plusBtn  = box.querySelector('.btn-qty[data-op="plus"]');

			  const clamp = v => Math.max(min, Math.min(max, v));
			  const parseQty = v => {
			    const n = parseInt(v, 10);
			    return clamp(isNaN(n) ? min : n);
			  };

			  function update(qty) {
			    input.value = qty;
			    minusBtn.disabled = qty <= min;
			    plusBtn.disabled  = qty >= max;
			    const total = unitPrice * qty;
			    priceEl.textContent = 'â‚© ' + total.toLocaleString('ko-KR');
			  }

			  minusBtn.addEventListener('click', () => update(parseQty(input.value) - 1));
			  plusBtn .addEventListener('click', () => update(parseQty(input.value) + 1));
			  input.addEventListener('input', () => update(parseQty(input.value)));

			  update(parseQty(input.value));
			})();
		
		/* const productCode = '[[${product.productCode}]]';
		
		console.log("productCode : ", productCode)

		// ë¦¬ë·° ë¶ˆëŸ¬ì˜¤ê¸°
		function loadReviews() {
		    fetch(`/reviews/${productCode}`)
		        .then(res => res.json())
		        .then(data => {
		            const avgRatingEl = document.getElementById("avgRating");

		            if (data.ratingAvg !== null) {
		                const avgRating = parseFloat(data.ratingAvg).toFixed(1);
		                const starCount = Math.round(data.ratingAvg);
		                
		                console.log("ratingAvg:", data.ratingAvg, typeof data.ratingAvg);

		                const filledStars = '<span style="color:#FFD700;">' + 'â˜…'.repeat(starCount) + '</span>';
		                const emptyStars = '<span style="color:#CCCCCC;">' + 'â˜…'.repeat(5 - starCount) + '</span>';

		                avgRatingEl.innerHTML = `${avgRating}ì  ${filledStars}${emptyStars} (${data.ratingCount}ëª… ì°¸ì—¬)`;
		            } else {
		                avgRatingEl.textContent = "ì•„ì§ í‰ì ì´ ì—†ìŠµë‹ˆë‹¤.";
		            }

		            // ë¦¬ë·° ë¦¬ìŠ¤íŠ¸
		            const reviewListEl = document.getElementById("reviewList");
		            reviewListEl.innerHTML = "";
		            data.reviews.forEach(review => {
		                const reviewItem = document.createElement("div");
		                reviewItem.innerHTML = `
		                    <p style="font-size: 20px; color:#555555;">
		                        ì‘ì„±ì: ${review.authorName} |
		                        ë³„ì : ${'â˜…'.repeat(review.rating)}${'â˜†'.repeat(5 - review.rating)} |
		                        ì‘ì„±ì¼ì: ${review.createDate}
		                    </p>
		                    <p style="font-size: 20px;">${review.content}</p>
		                    <hr>
		                `;
		                reviewListEl.appendChild(reviewItem);
		            });
		        });
		}

		// ë¦¬ë·° ì‘ì„±
		document.getElementById("submitReview").addEventListener("click", () => {
		    const content = document.getElementById("reviewContent").value;
		    const rating = document.getElementById("reviewRating").value;

		    fetch("/reviews/add", {
		        method: "POST",
		        headers: { "Content-Type": "application/json" },
		        body: JSON.stringify({ productCode, content, rating })
		    })
		    .then(res => res.json())
		    .then(msg => {
		        alert(msg);
		        document.getElementById("reviewContent").value = "";
		        document.getElementById("reviewRating").value = "5";
		        loadReviews(); // ìƒˆ ë¦¬ë·° ë°˜ì˜
		    })
		    .catch(err => console.error(err));
		});

		// ì´ˆê¸° ë¡œë”©
		window.addEventListener("load", loadReviews); */
		
		function renderStars(rating, count) {
		    const filledStars = '<span style="color:#FFD700;">' + 'â˜…'.repeat(rating) + '</span>';
		    const emptyStars  = '<span style="color:#CCCCCC;">' + 'â˜…'.repeat(5 - rating) + '</span>';
		    return `${filledStars}${emptyStars} <span class="text-muted">(${count}ê°œ)</span>`;
		  }

		  // ë¦¬ë·°ê°€ ì—†ì„ ê²½ìš°
		  document.getElementById("starRating").innerHTML = renderStars(0, 0);
		  
		  /* function addToCart(productCode) {
			  fetch("/cart/add", {
			    method: "POST",
			    headers: { "Content-Type": "application/json" },
			    body: JSON.stringify({ productCode: productCode, qty: 1 })
			  })
			    .then(res => {
			      if (!res.ok) throw new Error("HTTP ì˜¤ë¥˜: " + res.status);
			      return res.json();
			    })
			    .then(data => {
			      if (data.result === "success") {
			        new bootstrap.Modal(document.getElementById('cartModal')).show();
			      } else {
			        alert("ì¥ë°”êµ¬ë‹ˆ ë‹´ê¸° ì‹¤íŒ¨!");
			      }
			    })
			    .catch(err => {
			      console.error(err);
			      alert("ì¥ë°”êµ¬ë‹ˆ ë‹´ê¸° ì¤‘ ì˜¤ë¥˜ ë°œìƒ!");
			    }); 
		  }*/
			


</script>
	</div>
</body>

</html>