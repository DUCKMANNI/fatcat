<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{shopping/layout}">
<head>
<meta charset="UTF-8">
<title>쇼핑몰 상품 상세보기</title>
</head>
<body>
	<!-- ✅ 폭/높이 한 번에 조정: max-width와 --box-h 숫자만 바꾸면 됨 -->
	<div layout:fragment="shopContent"
		class="container my-3 d-flex flex-column align-items-center mt-5"
		style="max-width: 1200px; --box-h: 520px;">

		<!-- ===== 상단: 대표이미지 / 상품정보 (같은 높이, 가운데 정렬) ===== -->
		<div class="row g-4 align-items-stretch w-100">

			<!-- 대표 이미지 -->
			<div class="col-md-6 d-flex">
				<!-- 기존 product-img-box 스타일이 겹침 원인이었을 수 있으니 인라인로 완전 제어 -->
				<div
					class="flex-fill d-flex align-items-center justify-content-center"
					style="height: var(--box-h); position: static !important; overflow: hidden;">
					<img
						th:src="${product.productImageList.^[imageTypeCode == 'm']?.fileName}"
						th:alt="${product.productName}" class="w-100 h-100"
						style="object-fit: contain;">
				</div>
			</div>

			<!-- 상품 정보 -->
			<div class="col-md-6 d-flex">
				<div class="flex-fill p-4 d-flex flex-column"
					style="min-height: var(--box-h);">
					<h3 th:text="${product.productName}">상품명</h3>
					<p class="mb-2" id="starRating">
					<!-- <p class="mb-2">
						★★★★★ <span class="text-muted">(0개)</span>
					</p> -->

					<form th:action="@{/shopping/cart/add}" method="post"
						class="mt-auto">
						<input type="hidden" name="productCode"
							th:value="${product.productCode}">
						<div id="orderBox"
							class="d-flex align-items-center mb-4 qty-group"
							th:attr="data-unit-price=${product.productPrice}, data-min=1, data-max=99">

							<button class="btn btn-outline-secondary btn-qty" type="button"
								data-op="minus">-</button>
							<input type="number"  name="qty"
								class="form-control text-center mx-2 qty-input"
								style="width: 70px;" value="1" min="1" max="99">
							<button class="btn btn-outline-secondary btn-qty" type="button"
								data-op="plus">+</button>

							<p class="ms-3 h5 mb-0 price-text"
								th:text="'₩ ' + ${#numbers.formatInteger(product.productPrice, 3, 'COMMA')}">
							</p>
						</div>

						<div class="d-flex gap-2 mt-3">
							<button class="btn btn-outline-dark flex-fill" type="submit"
								style="font-size: 20px; border-radius: 999px;">장바구니</button>
							<button class="btn btn-primary flex-fill" type="button"
								style="font-size: 20px; border-radius: 999px;">바로구매</button>
						</div>
					</form>

				</div>
			</div>
		</div>


		<div class="mt-5 w-100">
			<!-- 탭 메뉴 -->
			<ul class="nav nav-tabs" id="productTab" role="tablist">
				<li class="nav-item" role="presentation">
					<button class="nav-link active" id="detail-tab"
						data-bs-toggle="tab" data-bs-target="#detail" type="button"
						role="tab">상품 상세</button>
				</li>
				<li class="nav-item" role="presentation">
					<button class="nav-link" id="review-tab" data-bs-toggle="tab"
						data-bs-target="#review" type="button" role="tab">리뷰</button>
				</li>
			</ul>

			<!-- 탭 내용 -->
			<div class="tab-content p-4 border border-top-0"
				id="productTabContent">
				<!-- ✅ 중복 tab-pane 제거 & id 중복 제거 -->
				<div class="tab-pane fade show active text-center" id="detail"
					role="tabpanel">
					<div class="border rounded d-inline-block"
						style="max-width: 100%; width: 100%; position: static !important; overflow: hidden;">
						<img
							th:src="${product.productImageList.^[imageTypeCode == 'd']?.fileName}"
							th:alt="${product.productName}"
							style="max-width: 100%; height: auto; object-fit: contain;">
					</div>
				</div>

				<!-- <div class="tab-pane fade" id="review" role="tabpanel">
				    <h5 class="mb-4">상품 리뷰</h5>
				
				    평균 평점
				    <div id="avgRating" class="mb-3"></div>
				
				    리뷰 작성 폼
				    <div class="mb-4">
				        <textarea id="reviewContent" class="form-control mb-2" placeholder="리뷰 내용을 입력하세요"></textarea>
				        <select id="reviewRating" class="form-select w-auto mb-2">
				            <option value="5">★★★★★</option>
				            <option value="4">★★★★☆</option>
				            <option value="3">★★★☆☆</option>
				            <option value="2">★★☆☆☆</option>
				            <option value="1">★☆☆☆☆</option>
				        </select>
				        <button id="submitReview" class="btn btn-primary">리뷰 작성</button>
				    </div>
				
				    리뷰 리스트
				    <div id="reviewList"></div>
				</div> -->
				
				<div class="tab-pane fade" id="review" role="tabpanel">
					<h5 class="mb-4">상품 리뷰</h5>
					<p>아직 등록된 리뷰가 없습니다.</p>
				</div>

			</div>
		</div>

		<script th:inline="javascript">
		(function () {
			  const box = document.querySelector('#orderBox');
			  if (!box) return;

			  const unitPrice = parseInt(box.dataset.unitPrice || '0', 10);
			  const min = parseInt(box.dataset.min || '1', 10);
			  const max = parseInt(box.dataset.max || '99', 10);

			  const input = box.querySelector('.qty-input');
			  const priceEl = box.querySelector('.price-text');
			  const minusBtn = box.querySelector('.btn-qty[data-op="minus"]');
			  const plusBtn  = box.querySelector('.btn-qty[data-op="plus"]');

			  const clamp = v => Math.max(min, Math.min(max, v));
			  const parseQty = v => {
			    const n = parseInt(v, 10);
			    return clamp(isNaN(n) ? min : n);
			  };

			  function update(qty) {
			    input.value = qty;
			    minusBtn.disabled = qty <= min;
			    plusBtn.disabled  = qty >= max;
			    const total = unitPrice * qty;
			    priceEl.textContent = '₩ ' + total.toLocaleString('ko-KR');
			  }

			  minusBtn.addEventListener('click', () => update(parseQty(input.value) - 1));
			  plusBtn .addEventListener('click', () => update(parseQty(input.value) + 1));
			  input.addEventListener('input', () => update(parseQty(input.value)));

			  update(parseQty(input.value));
			})();
		
		/* const productCode = '[[${product.productCode}]]';
		
		console.log("productCode : ", productCode)

		// 리뷰 불러오기
		function loadReviews() {
		    fetch(`/reviews/${productCode}`)
		        .then(res => res.json())
		        .then(data => {
		            const avgRatingEl = document.getElementById("avgRating");

		            if (data.ratingAvg !== null) {
		                const avgRating = parseFloat(data.ratingAvg).toFixed(1);
		                const starCount = Math.round(data.ratingAvg);
		                
		                console.log("ratingAvg:", data.ratingAvg, typeof data.ratingAvg);

		                const filledStars = '<span style="color:#FFD700;">' + '★'.repeat(starCount) + '</span>';
		                const emptyStars = '<span style="color:#CCCCCC;">' + '★'.repeat(5 - starCount) + '</span>';

		                avgRatingEl.innerHTML = `${avgRating}점 ${filledStars}${emptyStars} (${data.ratingCount}명 참여)`;
		            } else {
		                avgRatingEl.textContent = "아직 평점이 없습니다.";
		            }

		            // 리뷰 리스트
		            const reviewListEl = document.getElementById("reviewList");
		            reviewListEl.innerHTML = "";
		            data.reviews.forEach(review => {
		                const reviewItem = document.createElement("div");
		                reviewItem.innerHTML = `
		                    <p style="font-size: 20px; color:#555555;">
		                        작성자: ${review.authorName} |
		                        별점: ${'★'.repeat(review.rating)}${'☆'.repeat(5 - review.rating)} |
		                        작성일자: ${review.createDate}
		                    </p>
		                    <p style="font-size: 20px;">${review.content}</p>
		                    <hr>
		                `;
		                reviewListEl.appendChild(reviewItem);
		            });
		        });
		}

		// 리뷰 작성
		document.getElementById("submitReview").addEventListener("click", () => {
		    const content = document.getElementById("reviewContent").value;
		    const rating = document.getElementById("reviewRating").value;

		    fetch("/reviews/add", {
		        method: "POST",
		        headers: { "Content-Type": "application/json" },
		        body: JSON.stringify({ productCode, content, rating })
		    })
		    .then(res => res.json())
		    .then(msg => {
		        alert(msg);
		        document.getElementById("reviewContent").value = "";
		        document.getElementById("reviewRating").value = "5";
		        loadReviews(); // 새 리뷰 반영
		    })
		    .catch(err => console.error(err));
		});

		// 초기 로딩
		window.addEventListener("load", loadReviews); */
		
		function renderStars(rating, count) {
		    const filledStars = '<span style="color:#FFD700;">' + '★'.repeat(rating) + '</span>';
		    const emptyStars  = '<span style="color:#CCCCCC;">' + '★'.repeat(5 - rating) + '</span>';
		    return `${filledStars}${emptyStars} <span class="text-muted">(${count}개)</span>`;
		  }

		  // 리뷰가 없을 경우
		  document.getElementById("starRating").innerHTML = renderStars(0, 0);

</script>
	</div>
</body>

</html>