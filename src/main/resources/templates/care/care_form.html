<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{shared/layout}">

<head>
<meta charset="UTF-8">
<title>돌봄서비스 구인등록</title>
<style>

.form-label {
   
    margin-bottom: 0;
}

/* ⭐️ 새로 추가: 가격 입력 필드의 너비를 제한 */
.price-input-width {
    width: 700px; /* 원하는 너비로 조정 가능 */
}
#controls {
	 /* 기존: justify-content: space-between; (양 끝으로 벌림) */
    /* ⭐️ 변경: justify-content: flex-start; (왼쪽으로 모이게 함) */
	background: rgba(255, 255, 255, 0.96);
	border: 1px solid #ddd;
	border-radius: 14px;
	padding: 15px 20px;
	/* 드롭다운 그룹과 검색 버튼 사이의 간격 */
	gap: 15px; 
	align-items: center;
	margin: 2px auto; 
	display: flex;

	justify-content: flex-start;
}

.controls-item {
	display: flex;
	gap: 8px; /* 드롭다운 간 간격 조절 */
	align-items: center;
}

#controls select {
	height: 36px;
	font-size: 14px;
	border-radius: 8px;
	border: 1px solid #ccc;
	padding: 0 10px;
}

#controls select {
	width: 120px; /* 드롭다운 너비 고정 */
}

/* #controls button {
	cursor: pointer;
	border: none;
	background: #CD853F;
	color: #fff;
	font-weight: 600;
	padding: 10px 12px;
} */

#map {
	height: 100%;
	border: 1px solid #e5e5e5;
	border-radius: 24px;
	position: relative;
}
/* 
.fixed-element button {
	display: block !important;
} */

/* 폼 컨테이너와 지도 컨테이너의 간격 조절 */
.row {
	margin-right: -15px;
	margin-left: -15px;
}

.col-md-6 {
	padding-right: 15px;
	padding-left: 15px;
}
</style>
</head>
<body>
	<div layout:fragment="content" class="container mt-5">
		<script
			src="//dapi.kakao.com/v2/maps/sdk.js?appkey=4c15890a040537b9e018efed80761b21&libraries=services"></script>

		<div class="row">
			<div class="col-md-6">
				<h2 class="my-3 border-bottom pb-2 text-center">돌봄서비스 구인등록</h2>

				<form method="post" id="careServiceForm" th:object="${careServiceBoardDto}"
					th:action="@{${careSeq != null} ? '/care/modify/' + ${careSeq} : '/care/create'}">
					
					<div th:replace="~{shared/form_errors :: formErrorsFragment}"></div>

					<input type="hidden"	th:field="*{userSeq}" />

					<div class="mb-2">
						<label for="careTitle" class="form-label" style="font-size:25px;">제목</label> <input
							type="text" id="careTitle" th:field="*{careTitle}"
							class="form-control" style="font-size:20px;" required />
						<div class="invalid-feedback" style="font-size:20px;">제목을 입력해주세요.</div>
					</div>
					
					<div class="mb-2">
					<label class="form-label" style="font-size:25px;">돌봄 희망 기간</label>
					    <div class="d-flex gap-3">
					        <div class="d-flex flex-column flex-grow-1">
					            <label for="startDate" class="form-label" style="font-size:20px;">시작일:</label>
					            <input type="date" id="startDate" class="form-control" style="font-size:20px; width: 100%;" required />
					        </div>
					        <div class="d-flex flex-column flex-grow-1">
					            <label for="endDate" class="form-label" style="font-size:20px;">종료일:</label>
					            <input type="date" id="endDate" class="form-control" style="font-size:20px; width: 100%;" required />
					        </div>
					    </div>
					    </div>
				

					<div class="mb-2">
						<label for="careContent" class="form-label" style="font-size:25px;">내용</label>
						<textarea id="careContent" th:field="*{careContent}" rows="8"
							class="form-control" style="font-size:20px;" required></textarea>
						<div class="invalid-feedback" style="font-size:20px;">내용을 입력해주세요.</div>
					</div>

					<div class="mb-2">
						<label for="price" class="form-label" style="font-size: 25px;">가격</label>
						<div
							style="font-size: 20px; display: flex; align-items: center; gap: 5px;">
							<input type="number" id="price" th:field="*{price}"
								class="form-control price-input-width" style="font-size:20px;" required /> 원
						</div>
						<div class="invalid-feedback">가격을 입력해주세요.</div>
					</div>

					<div class="mb-2">
						<label class="form-label" style="font-size:25px;">주소 검색</label>
						<div id="controls" class="d-flex">
							<div class="controls-item" style="font-size : 20px;">
								<label >시/도 <select id="sido" style="font-size:18px;" ></select></label> <label
									>시/군/구 <select id="sigungu" style="font-size:18px;"></select></label> <label
									>동 <select id="dong" style="font-size:18px;"></select></label>
							</div>
							<button id="searchBtn" type="button" class="btn btn-fatcat" style="font-size:20px;">검색</button>
						</div>
					</div>

					<div class="mb-2">
						<input type="hidden" id="address1" th:field="*{address1}" style="font-size:25px;"
							class="form-control" required readonly />
						<div class="invalid-feedback" style="font-size : 20px;">주소를 검색해주세요.</div>
					</div>

					<div class="mb-2">
						<label for="address2" class="form-label" style="font-size:25px;">상세주소</label> <input
							type="text" id="address2" th:field="*{address2}"
							class="form-control" style="font-size:20px;" required />
						<div class="invalid-feedback" style="font-size : 20px;">상세주소를 입력해주세요.</div>
					</div>

					<input type="hidden" id="latitude" th:field="*{latitude}" /> <input
						type="hidden" id="longitude" th:field="*{longitude}" />

					<div class="d-grid gap-2 mb-2">
						<button type="submit" class="btn btn-fatcat" style="font-size : 25px;">저장하기</button>
					</div>
				</form>
			</div>

			<div class="col-md-6">
				<div id="map"></div>
			</div>
		</div>
		<script>
    let REGION_DATA={}, circle = null;

    const markers = [];
    const $sido = document.getElementById('sido');
    const $sigungu = document.getElementById('sigungu');
    const $dong = document.getElementById('dong');
    const $searchBtn = document.getElementById('searchBtn');
    
    // 🚨 누락되었던 필수 변수들을 여기에 정의합니다.
    const $form = document.getElementById('careServiceForm'); 
    const $startDate = document.getElementById('startDate');
    const $endDate = document.getElementById('endDate');
    const $careContent = document.getElementById('careContent');
    // $careContent가 null일 경우를 대비하여 체크
    const originalContent = $careContent ? $careContent.value : ''; 
    // ----------------------------------------------------

    const map = new kakao.maps.Map(document.getElementById('map'), {
        center: new kakao.maps.LatLng(37.566826, 126.9786567),
        level: 5
    });
    const geocoder = new kakao.maps.services.Geocoder();
    
    

    window.addEventListener('DOMContentLoaded', () => {
        // CSV 파일 로드 및 데이터 파싱을 먼저 완료
        fetch('/data/korea_map_info.txt')
            .then(res => res.text())
            .then(text => {
                parseCSV(text);
                fillSido();
                
                // 🚨 수정 시 careContent에서 날짜 추출하여 DatePicker 채우기
                // $careContent가 있을 때만 실행하도록 변경 (불필요한 에러 방지)
                if ($careContent && originalContent.includes('시작일:') && originalContent.includes('종료일:')) {
                    const lines = originalContent.split('\n');
                    const startDateLine = lines.find(line => line.startsWith('시작일:'));
                    const endDateLine = lines.find(line => line.startsWith('종료일:'));

                    if (startDateLine) {
                        $startDate.value = startDateLine.split(':')[1].trim();
                    }
                    if (endDateLine) {
                        $endDate.value = endDateLine.split(':')[1].trim();
                    }
                    // 내용 필드에서 날짜 정보 제거 (제출 시 다시 합칠 예정)
                    $careContent.value = lines.filter(line => !line.startsWith('시작일:') && !line.startsWith('종료일:')).join('\n').trim();
                }

                // CSV 데이터 로드 완료 후 위치 정보 가져오기 시작
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(pos => {
                        const lat = pos.coords.latitude;
                        const lng = pos.coords.longitude;
                        const loc = new kakao.maps.LatLng(lat, lng);
                        
                        // 기존 코드 대신 새로운 reverseGeocode 함수 호출
                        reverseGeocode(lat, lng, loc);

                    }, err => {
                        console.warn("위치 가져오기 실패", err);
                        // 실패 시 기본 지도로 설정
                        addCenterMarkerAndCircle(new kakao.maps.LatLng(37.566826, 126.9786567));
                    });
                } else {
                    console.warn("Geolocation API를 지원하지 않는 브라우저입니다.");
                }
                
                // 🚨 searchBtn 이벤트 리스너를 Geolocation 결과와 상관없이 여기서 한 번만 등록
                $searchBtn.addEventListener('click', searchLocation);

            })
            .catch(err => console.error('CSV 읽기 실패', err));
    });
    
 // 🚨 폼 제출 이벤트 리스너 (변수 정의가 상단으로 이동했으므로 정상 작동)
    $form.addEventListener('submit', function(e) {
        const startDate = $startDate.value;
        const endDate = $endDate.value;
        const rawContent = $careContent.value.trim();

        // 1. 날짜 유효성 검사 (HTML required 속성이 있지만, JS로 한 번 더 체크)
        if (!startDate || !endDate) {
            e.preventDefault();
            alert("돌봄 희망 기간 (시작일/종료일)을 모두 선택해주세요.");
            return;
        }

        if (new Date(startDate) > new Date(endDate)) {
            e.preventDefault();
            alert("시작일은 종료일보다 이전이거나 같아야 합니다.");
            return;
        }
        
        if (rawContent.length < 5) {
             e.preventDefault();
             alert("내용을 5자 이상 입력해주세요.");
             return;
        }

        // 2. 내용에 시작일/종료일 정보 통합
        const combinedContent = `시작일: ${startDate}\n종료일: ${endDate}\n${rawContent}`;
        $careContent.value = combinedContent;
        
    });


    function parseCSV(csvText) {
        REGION_DATA = {};
        csvText.split('\n').slice(1).forEach(line => {
            const [sido, sigungu, dong] = line.split(',').map(s => s.trim());
            if (!sido || !sigungu || !dong) return;
            REGION_DATA[sido] = REGION_DATA[sido] || {};
            REGION_DATA[sido][sigungu] = REGION_DATA[sido][sigungu] || [];
            REGION_DATA[sido][sigungu].push(dong);
        });
    }

    function fillSido() {
        $sido.innerHTML = '<option value="">시/도 선택</option>';
        Object.keys(REGION_DATA).forEach(sd => $sido.innerHTML += `<option value="${sd}">${sd}</option>`);
        $sigungu.innerHTML = '<option value="">시/군/구 선택</option>';
        $dong.innerHTML = '<option value="">동 선택</option>';
    }

    function fillSigungu() {
        const sd = $sido.value;
        $sigungu.innerHTML = '<option value="">시/군/구 선택</option>';
        $dong.innerHTML = '<option value="">동 선택</option>';
        if (!sd) return;
        Object.keys(REGION_DATA[sd]).forEach(gu => $sigungu.innerHTML += `<option value="${gu}">${gu}</option>`);
    }

    function fillDong() {
        const sd = $sido.value;
        const gu = $sigungu.value;
        $dong.innerHTML = '<option value="">동 선택</option>';
        if (!sd || !gu) return;
        REGION_DATA[sd][gu].forEach(d => $dong.innerHTML += `<option value="${d}">${d}</option>`);
    }

    $sido.addEventListener('change', fillSigungu);
    $sigungu.addEventListener('change', fillDong);

    function buildRegionText() {
        return [$sido.value, $sigungu.value, $dong.value].filter(Boolean).join(' ');
    }
    
 // ⭐️ 새로 추가된 함수: 좌표를 주소로 변환하고 드롭다운을 설정합니다.
    function reverseGeocode(lat, lon, loc) {
        geocoder.coord2RegionCode(lon, lat, (result, status) => {
            if (status === kakao.maps.services.Status.OK) {
                const regionInfo = result.find(item => item.region_type === 'H');
                
                if (regionInfo) {
                    const { region_1depth_name, region_2depth_name, region_3depth_name } = regionInfo;
                    
                    // 드롭다운에 시/도와 시/군/구 설정
                    $sido.value = region_1depth_name;
                    fillSigungu();
                    $sigungu.value = region_2depth_name;
                    fillDong();
                    
                    // Geocoder 결과와 비슷한 동(dong) 찾기
                    const dongList = REGION_DATA[region_1depth_name] ? REGION_DATA[region_1depth_name][region_2depth_name] : null;
                    const matchedDong = dongList ? dongList.find(d => region_3depth_name.includes(d) || d.includes(region_3depth_name)) : null;

                    if (matchedDong) {
                        $dong.value = matchedDong;
                    }
                    
                    // 주소와 위경도 필드 자동 채움
                    const fullAddress = `${region_1depth_name} ${region_2depth_name} ${matchedDong || region_3depth_name}`;
                    document.getElementById('address1').value = fullAddress;
                    document.getElementById('latitude').value = lat;
                    document.getElementById('longitude').value = lon;
                    
                    addCenterMarkerAndCircle(loc);
                }
            } else {
                console.error("주소 변환에 실패했습니다.");
                addCenterMarkerAndCircle(loc);
            }
        });
    }

    function addCenterMarkerAndCircle(position) {
        markers.forEach(m => m.setMap(null));
        markers.length = 0;
        if (circle) {
            circle.setMap(null);
        }

        const centerMarker = new kakao.maps.Marker({
            map: map,
            position: position,
            image: new kakao.maps.MarkerImage("/images/map_marker.png", new kakao.maps.Size(50, 50))
        });
        markers.push(centerMarker);

        circle = new kakao.maps.Circle({
            center: position,
            radius: 3000,
            strokeWeight: 5,
            strokeColor: '#75B8FA',
            strokeOpacity: 0.8,
            strokeStyle: 'dashed',
            fillColor: '#CFE7FF',
            fillOpacity: 0.5
        });

        circle.setMap(map);
        map.setCenter(position); 
        map.setLevel(7);
    }

    function searchLocation() {
        if (!$sido.value || !$sigungu.value) {
            alert('시/도와 시/군/구를 선택해주세요.');
            return;
        }

        const address = buildRegionText();
        
        document.getElementById('address1').value = address;

        geocoder.addressSearch(address, (result, status) => {
            if (status === kakao.maps.services.Status.OK) {
                const coords = new kakao.maps.LatLng(result[0].y, result[0].x);
                addCenterMarkerAndCircle(coords);

                document.getElementById('latitude').value = coords.getLat();
                document.getElementById('longitude').value = coords.getLng();
            } else {
                alert('주소 검색에 실패했습니다.');
            }
        });
    }

</script>
	</div>
</body>
</html>