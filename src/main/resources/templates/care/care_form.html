<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{shared/layout}">

<head>
<meta charset="UTF-8">
<title>ëŒë´„ì„œë¹„ìŠ¤ êµ¬ì¸ë“±ë¡</title>
<style>

.form-label {
   
    margin-bottom: 0;
}

/* â­ï¸ ìƒˆë¡œ ì¶”ê°€: ê°€ê²© ì…ë ¥ í•„ë“œì˜ ë„ˆë¹„ë¥¼ ì œí•œ */
.price-input-width {
    width: 700px; /* ì›í•˜ëŠ” ë„ˆë¹„ë¡œ ì¡°ì • ê°€ëŠ¥ */
}
#controls {
	 /* ê¸°ì¡´: justify-content: space-between; (ì–‘ ëìœ¼ë¡œ ë²Œë¦¼) */
    /* â­ï¸ ë³€ê²½: justify-content: flex-start; (ì™¼ìª½ìœ¼ë¡œ ëª¨ì´ê²Œ í•¨) */
	background: rgba(255, 255, 255, 0.96);
	border: 1px solid #ddd;
	border-radius: 14px;
	padding: 15px 20px;
	/* ë“œë¡­ë‹¤ìš´ ê·¸ë£¹ê³¼ ê²€ìƒ‰ ë²„íŠ¼ ì‚¬ì´ì˜ ê°„ê²© */
	gap: 15px; 
	align-items: center;
	margin: 2px auto; 
	display: flex;

	justify-content: flex-start;
}

.controls-item {
	display: flex;
	gap: 8px; /* ë“œë¡­ë‹¤ìš´ ê°„ ê°„ê²© ì¡°ì ˆ */
	align-items: center;
}

#controls select {
	height: 36px;
	font-size: 14px;
	border-radius: 8px;
	border: 1px solid #ccc;
	padding: 0 10px;
}

#controls select {
	width: 120px; /* ë“œë¡­ë‹¤ìš´ ë„ˆë¹„ ê³ ì • */
}

/* #controls button {
	cursor: pointer;
	border: none;
	background: #CD853F;
	color: #fff;
	font-weight: 600;
	padding: 10px 12px;
} */

#map {
	height: 100%;
	border: 1px solid #e5e5e5;
	border-radius: 24px;
	position: relative;
}
/* 
.fixed-element button {
	display: block !important;
} */

/* í¼ ì»¨í…Œì´ë„ˆì™€ ì§€ë„ ì»¨í…Œì´ë„ˆì˜ ê°„ê²© ì¡°ì ˆ */
.row {
	margin-right: -15px;
	margin-left: -15px;
}

.col-md-6 {
	padding-right: 15px;
	padding-left: 15px;
}
</style>
</head>
<body>
	<div layout:fragment="content" class="container mt-5">
		<script
			src="//dapi.kakao.com/v2/maps/sdk.js?appkey=4c15890a040537b9e018efed80761b21&libraries=services"></script>

		<div class="row">
			<div class="col-md-6">
				<h2 class="my-3 border-bottom pb-2 text-center">ëŒë´„ì„œë¹„ìŠ¤ êµ¬ì¸ë“±ë¡</h2>

				<form method="post" id="careServiceForm" th:object="${careServiceBoardDto}"
					th:action="@{${careSeq != null} ? '/care/modify/' + ${careSeq} : '/care/create'}">
					
					<div th:replace="~{shared/form_errors :: formErrorsFragment}"></div>

					<input type="hidden"	th:field="*{userSeq}" />

					<div class="mb-2">
						<label for="careTitle" class="form-label" style="font-size:25px;">ì œëª©</label> <input
							type="text" id="careTitle" th:field="*{careTitle}"
							class="form-control" style="font-size:20px;" required />
						<div class="invalid-feedback" style="font-size:20px;">ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.</div>
					</div>
					
					<div class="mb-2">
					<label class="form-label" style="font-size:25px;">ëŒë´„ í¬ë§ ê¸°ê°„</label>
					    <div class="d-flex gap-3">
					        <div class="d-flex flex-column flex-grow-1">
					            <label for="startDate" class="form-label" style="font-size:20px;">ì‹œì‘ì¼:</label>
					            <input type="date" id="startDate" class="form-control" style="font-size:20px; width: 100%;" required />
					        </div>
					        <div class="d-flex flex-column flex-grow-1">
					            <label for="endDate" class="form-label" style="font-size:20px;">ì¢…ë£Œì¼:</label>
					            <input type="date" id="endDate" class="form-control" style="font-size:20px; width: 100%;" required />
					        </div>
					    </div>
					    </div>
				

					<div class="mb-2">
						<label for="careContent" class="form-label" style="font-size:25px;">ë‚´ìš©</label>
						<textarea id="careContent" th:field="*{careContent}" rows="8"
							class="form-control" style="font-size:20px;" required></textarea>
						<div class="invalid-feedback" style="font-size:20px;">ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.</div>
					</div>

					<div class="mb-2">
						<label for="price" class="form-label" style="font-size: 25px;">ê°€ê²©</label>
						<div
							style="font-size: 20px; display: flex; align-items: center; gap: 5px;">
							<input type="number" id="price" th:field="*{price}"
								class="form-control price-input-width" style="font-size:20px;" required /> ì›
						</div>
						<div class="invalid-feedback">ê°€ê²©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.</div>
					</div>

					<div class="mb-2">
						<label class="form-label" style="font-size:25px;">ì£¼ì†Œ ê²€ìƒ‰</label>
						<div id="controls" class="d-flex">
							<div class="controls-item" style="font-size : 20px;">
								<label >ì‹œ/ë„ <select id="sido" style="font-size:18px;" ></select></label> <label
									>ì‹œ/êµ°/êµ¬ <select id="sigungu" style="font-size:18px;"></select></label> <label
									>ë™ <select id="dong" style="font-size:18px;"></select></label>
							</div>
							<button id="searchBtn" type="button" class="btn btn-fatcat" style="font-size:20px;">ê²€ìƒ‰</button>
						</div>
					</div>

					<div class="mb-2">
						<input type="hidden" id="address1" th:field="*{address1}" style="font-size:25px;"
							class="form-control" required readonly />
						<div class="invalid-feedback" style="font-size : 20px;">ì£¼ì†Œë¥¼ ê²€ìƒ‰í•´ì£¼ì„¸ìš”.</div>
					</div>

					<div class="mb-2">
						<label for="address2" class="form-label" style="font-size:25px;">ìƒì„¸ì£¼ì†Œ</label> <input
							type="text" id="address2" th:field="*{address2}"
							class="form-control" style="font-size:20px;" required />
						<div class="invalid-feedback" style="font-size : 20px;">ìƒì„¸ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</div>
					</div>

					<input type="hidden" id="latitude" th:field="*{latitude}" /> <input
						type="hidden" id="longitude" th:field="*{longitude}" />

					<div class="d-grid gap-2 mb-2">
						<button type="submit" class="btn btn-fatcat" style="font-size : 25px;">ì €ì¥í•˜ê¸°</button>
					</div>
				</form>
			</div>

			<div class="col-md-6">
				<div id="map"></div>
			</div>
		</div>
		<script>
    let REGION_DATA={}, circle = null;

    const markers = [];
    const $sido = document.getElementById('sido');
    const $sigungu = document.getElementById('sigungu');
    const $dong = document.getElementById('dong');
    const $searchBtn = document.getElementById('searchBtn');
    
    // ğŸš¨ ëˆ„ë½ë˜ì—ˆë˜ í•„ìˆ˜ ë³€ìˆ˜ë“¤ì„ ì—¬ê¸°ì— ì •ì˜í•©ë‹ˆë‹¤.
    const $form = document.getElementById('careServiceForm'); 
    const $startDate = document.getElementById('startDate');
    const $endDate = document.getElementById('endDate');
    const $careContent = document.getElementById('careContent');
    // $careContentê°€ nullì¼ ê²½ìš°ë¥¼ ëŒ€ë¹„í•˜ì—¬ ì²´í¬
    const originalContent = $careContent ? $careContent.value : ''; 
    // ----------------------------------------------------

    const map = new kakao.maps.Map(document.getElementById('map'), {
        center: new kakao.maps.LatLng(37.566826, 126.9786567),
        level: 5
    });
    const geocoder = new kakao.maps.services.Geocoder();
    
    

    window.addEventListener('DOMContentLoaded', () => {
        // CSV íŒŒì¼ ë¡œë“œ ë° ë°ì´í„° íŒŒì‹±ì„ ë¨¼ì € ì™„ë£Œ
        fetch('/data/korea_map_info.txt')
            .then(res => res.text())
            .then(text => {
                parseCSV(text);
                fillSido();
                
                // ğŸš¨ ìˆ˜ì • ì‹œ careContentì—ì„œ ë‚ ì§œ ì¶”ì¶œí•˜ì—¬ DatePicker ì±„ìš°ê¸°
                // $careContentê°€ ìˆì„ ë•Œë§Œ ì‹¤í–‰í•˜ë„ë¡ ë³€ê²½ (ë¶ˆí•„ìš”í•œ ì—ëŸ¬ ë°©ì§€)
                if ($careContent && originalContent.includes('ì‹œì‘ì¼:') && originalContent.includes('ì¢…ë£Œì¼:')) {
                    const lines = originalContent.split('\n');
                    const startDateLine = lines.find(line => line.startsWith('ì‹œì‘ì¼:'));
                    const endDateLine = lines.find(line => line.startsWith('ì¢…ë£Œì¼:'));

                    if (startDateLine) {
                        $startDate.value = startDateLine.split(':')[1].trim();
                    }
                    if (endDateLine) {
                        $endDate.value = endDateLine.split(':')[1].trim();
                    }
                    // ë‚´ìš© í•„ë“œì—ì„œ ë‚ ì§œ ì •ë³´ ì œê±° (ì œì¶œ ì‹œ ë‹¤ì‹œ í•©ì¹  ì˜ˆì •)
                    $careContent.value = lines.filter(line => !line.startsWith('ì‹œì‘ì¼:') && !line.startsWith('ì¢…ë£Œì¼:')).join('\n').trim();
                }

                // CSV ë°ì´í„° ë¡œë“œ ì™„ë£Œ í›„ ìœ„ì¹˜ ì •ë³´ ê°€ì ¸ì˜¤ê¸° ì‹œì‘
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(pos => {
                        const lat = pos.coords.latitude;
                        const lng = pos.coords.longitude;
                        const loc = new kakao.maps.LatLng(lat, lng);
                        
                        // ê¸°ì¡´ ì½”ë“œ ëŒ€ì‹  ìƒˆë¡œìš´ reverseGeocode í•¨ìˆ˜ í˜¸ì¶œ
                        reverseGeocode(lat, lng, loc);

                    }, err => {
                        console.warn("ìœ„ì¹˜ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨", err);
                        // ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ ì§€ë„ë¡œ ì„¤ì •
                        addCenterMarkerAndCircle(new kakao.maps.LatLng(37.566826, 126.9786567));
                    });
                } else {
                    console.warn("Geolocation APIë¥¼ ì§€ì›í•˜ì§€ ì•ŠëŠ” ë¸Œë¼ìš°ì €ì…ë‹ˆë‹¤.");
                }
                
                // ğŸš¨ searchBtn ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¥¼ Geolocation ê²°ê³¼ì™€ ìƒê´€ì—†ì´ ì—¬ê¸°ì„œ í•œ ë²ˆë§Œ ë“±ë¡
                $searchBtn.addEventListener('click', searchLocation);

            })
            .catch(err => console.error('CSV ì½ê¸° ì‹¤íŒ¨', err));
    });
    
 // ğŸš¨ í¼ ì œì¶œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (ë³€ìˆ˜ ì •ì˜ê°€ ìƒë‹¨ìœ¼ë¡œ ì´ë™í–ˆìœ¼ë¯€ë¡œ ì •ìƒ ì‘ë™)
    $form.addEventListener('submit', function(e) {
        const startDate = $startDate.value;
        const endDate = $endDate.value;
        const rawContent = $careContent.value.trim();

        // 1. ë‚ ì§œ ìœ íš¨ì„± ê²€ì‚¬ (HTML required ì†ì„±ì´ ìˆì§€ë§Œ, JSë¡œ í•œ ë²ˆ ë” ì²´í¬)
        if (!startDate || !endDate) {
            e.preventDefault();
            alert("ëŒë´„ í¬ë§ ê¸°ê°„ (ì‹œì‘ì¼/ì¢…ë£Œì¼)ì„ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”.");
            return;
        }

        if (new Date(startDate) > new Date(endDate)) {
            e.preventDefault();
            alert("ì‹œì‘ì¼ì€ ì¢…ë£Œì¼ë³´ë‹¤ ì´ì „ì´ê±°ë‚˜ ê°™ì•„ì•¼ í•©ë‹ˆë‹¤.");
            return;
        }
        
        if (rawContent.length < 5) {
             e.preventDefault();
             alert("ë‚´ìš©ì„ 5ì ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”.");
             return;
        }

        // 2. ë‚´ìš©ì— ì‹œì‘ì¼/ì¢…ë£Œì¼ ì •ë³´ í†µí•©
        const combinedContent = `ì‹œì‘ì¼: ${startDate}\nì¢…ë£Œì¼: ${endDate}\n${rawContent}`;
        $careContent.value = combinedContent;
        
    });


    function parseCSV(csvText) {
        REGION_DATA = {};
        csvText.split('\n').slice(1).forEach(line => {
            const [sido, sigungu, dong] = line.split(',').map(s => s.trim());
            if (!sido || !sigungu || !dong) return;
            REGION_DATA[sido] = REGION_DATA[sido] || {};
            REGION_DATA[sido][sigungu] = REGION_DATA[sido][sigungu] || [];
            REGION_DATA[sido][sigungu].push(dong);
        });
    }

    function fillSido() {
        $sido.innerHTML = '<option value="">ì‹œ/ë„ ì„ íƒ</option>';
        Object.keys(REGION_DATA).forEach(sd => $sido.innerHTML += `<option value="${sd}">${sd}</option>`);
        $sigungu.innerHTML = '<option value="">ì‹œ/êµ°/êµ¬ ì„ íƒ</option>';
        $dong.innerHTML = '<option value="">ë™ ì„ íƒ</option>';
    }

    function fillSigungu() {
        const sd = $sido.value;
        $sigungu.innerHTML = '<option value="">ì‹œ/êµ°/êµ¬ ì„ íƒ</option>';
        $dong.innerHTML = '<option value="">ë™ ì„ íƒ</option>';
        if (!sd) return;
        Object.keys(REGION_DATA[sd]).forEach(gu => $sigungu.innerHTML += `<option value="${gu}">${gu}</option>`);
    }

    function fillDong() {
        const sd = $sido.value;
        const gu = $sigungu.value;
        $dong.innerHTML = '<option value="">ë™ ì„ íƒ</option>';
        if (!sd || !gu) return;
        REGION_DATA[sd][gu].forEach(d => $dong.innerHTML += `<option value="${d}">${d}</option>`);
    }

    $sido.addEventListener('change', fillSigungu);
    $sigungu.addEventListener('change', fillDong);

    function buildRegionText() {
        return [$sido.value, $sigungu.value, $dong.value].filter(Boolean).join(' ');
    }
    
 // â­ï¸ ìƒˆë¡œ ì¶”ê°€ëœ í•¨ìˆ˜: ì¢Œí‘œë¥¼ ì£¼ì†Œë¡œ ë³€í™˜í•˜ê³  ë“œë¡­ë‹¤ìš´ì„ ì„¤ì •í•©ë‹ˆë‹¤.
    function reverseGeocode(lat, lon, loc) {
        geocoder.coord2RegionCode(lon, lat, (result, status) => {
            if (status === kakao.maps.services.Status.OK) {
                const regionInfo = result.find(item => item.region_type === 'H');
                
                if (regionInfo) {
                    const { region_1depth_name, region_2depth_name, region_3depth_name } = regionInfo;
                    
                    // ë“œë¡­ë‹¤ìš´ì— ì‹œ/ë„ì™€ ì‹œ/êµ°/êµ¬ ì„¤ì •
                    $sido.value = region_1depth_name;
                    fillSigungu();
                    $sigungu.value = region_2depth_name;
                    fillDong();
                    
                    // Geocoder ê²°ê³¼ì™€ ë¹„ìŠ·í•œ ë™(dong) ì°¾ê¸°
                    const dongList = REGION_DATA[region_1depth_name] ? REGION_DATA[region_1depth_name][region_2depth_name] : null;
                    const matchedDong = dongList ? dongList.find(d => region_3depth_name.includes(d) || d.includes(region_3depth_name)) : null;

                    if (matchedDong) {
                        $dong.value = matchedDong;
                    }
                    
                    // ì£¼ì†Œì™€ ìœ„ê²½ë„ í•„ë“œ ìë™ ì±„ì›€
                    const fullAddress = `${region_1depth_name} ${region_2depth_name} ${matchedDong || region_3depth_name}`;
                    document.getElementById('address1').value = fullAddress;
                    document.getElementById('latitude').value = lat;
                    document.getElementById('longitude').value = lon;
                    
                    addCenterMarkerAndCircle(loc);
                }
            } else {
                console.error("ì£¼ì†Œ ë³€í™˜ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                addCenterMarkerAndCircle(loc);
            }
        });
    }

    function addCenterMarkerAndCircle(position) {
        markers.forEach(m => m.setMap(null));
        markers.length = 0;
        if (circle) {
            circle.setMap(null);
        }

        const centerMarker = new kakao.maps.Marker({
            map: map,
            position: position,
            image: new kakao.maps.MarkerImage("/images/map_marker.png", new kakao.maps.Size(50, 50))
        });
        markers.push(centerMarker);

        circle = new kakao.maps.Circle({
            center: position,
            radius: 3000,
            strokeWeight: 5,
            strokeColor: '#75B8FA',
            strokeOpacity: 0.8,
            strokeStyle: 'dashed',
            fillColor: '#CFE7FF',
            fillOpacity: 0.5
        });

        circle.setMap(map);
        map.setCenter(position); 
        map.setLevel(7);
    }

    function searchLocation() {
        if (!$sido.value || !$sigungu.value) {
            alert('ì‹œ/ë„ì™€ ì‹œ/êµ°/êµ¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
            return;
        }

        const address = buildRegionText();
        
        document.getElementById('address1').value = address;

        geocoder.addressSearch(address, (result, status) => {
            if (status === kakao.maps.services.Status.OK) {
                const coords = new kakao.maps.LatLng(result[0].y, result[0].x);
                addCenterMarkerAndCircle(coords);

                document.getElementById('latitude').value = coords.getLat();
                document.getElementById('longitude').value = coords.getLng();
            } else {
                alert('ì£¼ì†Œ ê²€ìƒ‰ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        });
    }

</script>
	</div>
</body>
</html>