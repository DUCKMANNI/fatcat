<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{shared/layout}">
<head>
<meta charset="utf-8">
<title>돌봄서비스</title>
<style>

#controls {
	background: rgba(255, 255, 255, 0.96);
	border: 1px solid #ddd;
	border-radius: 14px;
	padding: 10px 14px;
	display: flex;
	gap: 8px;
	align-items: center;
	margin: 20px auto;
	width: fit-content;
}

#controls select {
	height: 36px;
	font-size: 20px;
	border-radius: 8px;
	border: 1px solid #ccc;
	padding: 0 10px;
}

/* #controls button {
	cursor: pointer;
	border: none;
	background: #CD853F;
	color: #fff;
	font-weight: 600;
} */

#mapListContainer {
	display: flex;
	width: calc(100% - 20px);
	height: 80vh;
	margin: 20px 15px 0;
	gap: 16px;
	box-sizing: border-box;
}

#map, #menu_wrap, #detailPanel {
	transition: all 0.3s ease;
}

#map {
	flex: 0.9;
	height: 100%;
	border: 1px solid #e5e5e5;
	border-radius: 24px;
	position: relative;
}

#menu_wrap {
	flex: 0.5;
	background: rgba(255, 255, 255, 0.96);
	border-radius: 24px;
	padding: 8px;
	font-size: 14px;
	overflow-y: auto;
	box-shadow: 0 2px 8px rgba(0, 0, 0, 0.12);
}

#menu_wrap h3 {
	margin: 6px 8px 10px;
	font-size: 16px;
}

#placesList {
	margin: 0;
	padding: 0 6px 8px;
}

#placesList li {
	list-style: none;
}

#placesList .item {
	display: flex;
	align-items: flex-start;
	padding: 10px;
	border-bottom: 1px solid #ddd;
	cursor: pointer;
}

#placesList .marker-number {
	width: 23px;
	height: 23px;
	display: flex;
	align-items: center;
	justify-content: center;
	background: #D2B48C;
	color: white;
	border-radius: 20px;
	font-size: 13px;
	font-weight: bold;
	margin-right: 10px;
	flex-shrink: 0;
}

#placesList .info {
	flex: 1;
}

#placesList .info h5 {
	margin: 0 0 4px;
	font-size: 20px;
	font-weight: bold;
}

#placesList .info p {
	margin: 2px 0;
	font-size: 18px;
	color: #555;
}

#pagination {
	text-align: center;
	padding: 6px 0 10px;
}

#pagination a {
	display: inline-block;
	margin: 0 6px;
	text-decoration: none;
	color: #666;
}

#pagination .on {
	font-weight: 700;
	color: #6C3C30;
	pointer-events: none;
}


/* .fixed-element button {
	display: block !important;
} */
/* 상세창 */
#detailPanel {
	flex: 0;
	width: 0;
	padding: 0;
	overflow: hidden;
	background: #fff;
	border-radius: 24px;
	box-shadow: -4px 0 8px rgba(0, 0, 0, 0.1);
}

#detailPanel.show {
	flex: 0.8;
	width: 300px;
	padding: 10px;
}

#detailPanel #closeDetail {
	float: right;
	cursor: pointer;
	border-radius: 60px;
	background: white;
	border-color: white;
	color: #CD853F;
}

/* .btn-group .btn {
    border-radius: 5px;
    padding: 8px 12px;
} */

.btn-warning {
    background-color: #ffc107;
    color: #212529;
    border: 1px solid #ffc107;
}

.btn-danger {
    background-color: #dc3545;
    color: #fff;
    border: 1px solid #dc3545;
}
</style>

</head>
<body>
	<div layout:fragment="content">
		<script
			src="//dapi.kakao.com/v2/maps/sdk.js?appkey=4c15890a040537b9e018efed80761b21&libraries=services"></script>

		<label class="container my-3 d-flex flex-column align-items-center"
			style="font-family: 'BagelFat', sans-serif; font-size: 50px; /* (80-&gt;50px) */ color: #CD853F;">돌봄서비스 찾기</label>
		
		<div id="controls" style="font-size: 20px;">
			<label>시/도<select id="sido" class="m-1" style="font-size: 18px;"></select></label> 
			<label>시/군/구<select id="sigungu" class="m-1" style="font-size: 18px;"></select></label>
			<label>동<select id="dong" class="m-1" style="font-size: 18px;"></select></label>
			<button id="searchBtn" class="btn btn-fatcat" style="font-size: 20px;">검색</button>
			<button id="btn" class="btn btn-fatcat"  style="font-size: 20px;" onclick='toggleListView()'>리스트만보기</button>
			<a th:href="@{/care/create}"><button id="btn" class="btn btn-fatcat" style="font-size: 20px;">돌봄글 등록</button></a>
		</div>

		<div id="mapListContainer">
			<div id="map"></div>
			<div id="menu_wrap">
				<h3 style="font-size: 25px">돌봄서비스 구인 목록</h3>
				<ul id="placesList"></ul>
				<div id="pagination"></div>
			</div>
			<div id="detailPanel">
				<button id="closeDetail">X</button>
				<div id="detailContent"></div>
			</div>
		</div>

		<script>
			let REGION_DATA = {}, allPlaces = [], currentPage = 1, pageSize = 7;
			let openedPlaceId = null, originalCenter = null;
			let userLocationMarker = null;

			const markers = [];
			const $sido = document.getElementById('sido');
			const $sigungu = document.getElementById('sigungu');
			const $dong = document.getElementById('dong');
			const $searchBtn = document.getElementById('searchBtn');
			const $placesList = document.getElementById('placesList');
			const $pagination = document.getElementById('pagination');
			
			const geocoder = new kakao.maps.services.Geocoder();

			const map = new kakao.maps.Map(document.getElementById('map'), {
				center : new kakao.maps.LatLng(37.566826, 126.9786567),
				level : 5
			});
			
			const infowindow = new kakao.maps.InfoWindow({zIndex:1});
			
			

			window.addEventListener('DOMContentLoaded', () => {
				fetch('/data/korea_map_info.txt')
				    .then(res => res.text())
				    .then(text => {
					    parseCSV(text);
					    fillSido();
					    if (navigator.geolocation) {
					    	navigator.geolocation.getCurrentPosition(
					    		(position) => {
					    			const lat = position.coords.latitude;
					    			const lon = position.coords.longitude;
					    			
					    			displayUserLocation(lat, lon);
					    			reverseGeocode(lat, lon);
					    		},
					    		(error) => {
					    			console.error("위치 정보를 가져오는 데 실패했습니다.", error);
					    			fetchCareList();
					    		}
					    	);
					    } else {
					    	console.error("이 브라우저에서는 Geolocation이 지원되지 않습니다.");
					    	fetchCareList();
					    }
				    })
				    .catch(err => console.error('CSV 읽기 실패', err));
			});
			
			// ✨ 현재 위치 마커 표시 함수: 인포윈도우 자동 표시 제거 및 마우스 이벤트 연결 ✨
			function displayUserLocation(lat, lon) {
				const pos = new kakao.maps.LatLng(lat, lon);
				
				// 기존 마커가 있다면 제거
				if (userLocationMarker) {
					userLocationMarker.setMap(null);
				}

				// 카카오맵 기본 마커 생성
				userLocationMarker = new kakao.maps.Marker({
					position: pos,
					map: map,
				});

				// 지도 중심 이동
				map.setCenter(pos);
				
				// 마커에 마우스 이벤트 연결 (마우스 오버시에만 인포윈도우가 열리도록)
				kakao.maps.event.addListener(userLocationMarker, 'mouseover', function() {
					infowindow.setContent('<div style="padding:5px;font-size:13px;">현재 내 위치</div>');
					infowindow.open(map, userLocationMarker);
				});

				kakao.maps.event.addListener(userLocationMarker, 'mouseout', function() {
					infowindow.close();
				});
			}

			function parseCSV(csvText) {
				REGION_DATA = {};
				csvText.split('\n').slice(1).forEach(line => {
					const [ sido, sigungu, dong ] = line.split(',').map(s => s.trim());
					if (!sido || !sigungu || !dong)
						return;
					REGION_DATA[sido] = REGION_DATA[sido] || {};
					REGION_DATA[sido][sigungu] = REGION_DATA[sido][sigungu] || [];
					REGION_DATA[sido][sigungu].push(dong);
				});
			}

			function fillSido() {
				$sido.innerHTML = '<option value="">시/도 선택</option>';
				Object.keys(REGION_DATA).forEach(sd => $sido.innerHTML += `<option value="${sd}">${sd}</option>`);
				$sigungu.innerHTML = '<option value="">시/군/구 선택</option>';
				$dong.innerHTML = '<option value="">동 선택</option>';
			}
			function fillSigungu() {
				const sd = $sido.value;
				$sigungu.innerHTML = '<option value="">시/군/구 선택</option>';
				$dong.innerHTML = '<option value="">동 선택</option>';
				if (!sd)
					return;
				Object.keys(REGION_DATA[sd]).forEach(gu => $sigungu.innerHTML += `<option value="${gu}">${gu}</option>`);
			}
			function fillDong() {
				const sd = $sido.value, gu = $sigungu.value;
				$dong.innerHTML = '<option value="">동 선택</option>';
				if (!sd || !gu)
					return;
				REGION_DATA[sd][gu].forEach(d => $dong.innerHTML += `<option value="${d}">${d}</option>`);
			}
			$sido.addEventListener('change', fillSigungu);
			$sigungu.addEventListener('change', fillDong);

			function clearMarkers() {
				// CustomOverlay 객체의 경우 setMap(null) 호출
				markers.forEach(m => m.overlay.setMap(null));
				markers.length = 0;
			}
			function clearList() {
				$placesList.innerHTML = '';
			}
			function buildRegionText() {
				return [ $sido.value, $sigungu.value, $dong.value ].filter(Boolean).join(' ');
			}
			
			// ✨ reverseGeocode 함수 수정: geocoder 유효성 검사 추가 ✨
			function reverseGeocode(lat, lon) {
				const coord = new kakao.maps.LatLng(lat, lon);
				
				// Geocoder 객체가 유효한지 먼저 확인하여 b.v is not a function 에러 방지
				if (!geocoder) { 
					console.error("Geocoder 객체가 초기화되지 않았습니다.");
					fetchCareList(); // 지오코딩 없이 목록을 불러옵니다.
					return;
				}

				geocoder.coord2RegionCode(coord.getLng(), coord.getLat(), (result, status) => {
					if (status === kakao.maps.services.Status.OK) {
						const regionInfo = result.find(item => item.region_type === 'H');
						
						if (regionInfo) {
							const { region_1depth_name, region_2depth_name, region_3depth_name } = regionInfo;
							
							$sido.value = region_1depth_name;
							fillSigungu();
							$sigungu.value = region_2depth_name;
							fillDong(); 
							
							const dongList = REGION_DATA[region_1depth_name] ? REGION_DATA[region_1depth_name][region_2depth_name] : null;
							const matchedDong = dongList ? dongList.find(d => region_3depth_name.includes(d) || d.includes(region_3depth_name)) : null;

							if (matchedDong) {
								$dong.value = matchedDong;
							} else {
								console.warn(`"${region_3depth_name}"에 해당하는 동이 데이터에 없거나 일치하지 않습니다.`);
							}
							
							fetchCareList();
						} else {
							console.warn("행정동 정보를 찾을 수 없습니다. 전체 목록을 불러옵니다.");
							fetchCareList();
						}
					} else {
						console.error("주소 변환에 실패했습니다. Status:", status);
						fetchCareList();
					}
				});
			}

			function fetchCareList() {
				const region = buildRegionText();
				const url = `/care/list?region=${encodeURIComponent(region)}`;
				
				fetch(url)
					.then(response => {
						if (!response.ok) {
							throw new Error('네트워크 응답이 올바르지 않습니다.');
						}
						return response.json();
					})
					.then(data => {
						allPlaces = data;
						currentPage = 1;
						renderList();
					})
					.catch(error => console.error('게시글 목록을 가져오는 데 실패했습니다:', error));
			}
			$searchBtn.addEventListener('click', fetchCareList);

			// 수정된 addMarker 함수 (투명 마커를 추가했습니다)
			function addMarker(pos, idx) {
			    // 1. CustomOverlay (보이는 핀) 생성 (기존과 동일)
			    const content = `
			        <div class="custom-marker-wrap" style="position: relative; width: 50px; height: 50px; cursor: pointer;">
			            <img src="/images/map_marker.png" style="width: 50px; height: 50px; display: block;">
			            <div style="
			                position: absolute;
			                top: 50%;
			                left: 50%;
			                transform: translate(-66%, 0%);
			                font-size: 20px;
			                font-weight: bold;
			                color: #422701;
			                width: 25px;
			                text-align: center;
			            ">${idx + 1}</div>
			        </div>
			    `;

			    const overlay = new kakao.maps.CustomOverlay({
			        position: pos,
			        content: content,
			        yAnchor: 1.0,
			        xAnchor: 0.5
			    });
			    overlay.setMap(map);


			    // 2. 인포윈도우 처리를 위한 투명 마커 생성 (추가)
			    const marker = new kakao.maps.Marker({
			        position: pos,
			        map: map,
			        opacity: 0.0 // 인포윈도우용으로 사용하고 눈에 보이지 않도록 투명하게 처리
			    });

			    // 3. 마커 배열에 CustomOverlay와 투명 마커 모두 저장
			    markers.push({ overlay, pos, marker });

			    // Custom Overlay에 이벤트 연결 (마우스 오버 시 투명 마커를 인포윈도우에 전달)
			    const overlayElement = overlay.getContent();
			    overlayElement.onmouseover = function() {
			        const place = allPlaces[idx];
			        // showInfo에 투명 마커 객체를 전달
			        showInfo(marker, place.careTitle); 
			    };
			    overlayElement.onmouseout = function() {
			        infowindow.close();
			    };

			    return { overlay, pos, marker };
			}


			function renderList() {
				clearMarkers();
				clearList();
				
				const start = (currentPage - 1) * pageSize, end = start + pageSize;
				const pagePlaces = allPlaces.slice(start, end);

				if(pagePlaces.length === 0){
					$placesList.innerHTML = `<li style="text-align:center; padding: 20px; font-size : 20px;">검색 결과가 없습니다.</li>`;
					$pagination.innerHTML = '';
					return;
				}

				pagePlaces.forEach((place, i) => {
					const pos = new kakao.maps.LatLng(place.latitude, place.longitude);
				    // marker 객체를 반환값에 추가
				    const { overlay, marker } = addMarker(pos, i + start);


					// ⭐ 목록 리스트 항목 생성
					 
					const li = document.createElement('li');
					li.className = 'item';
					li.innerHTML = `
						<div class="marker-number">${i + start + 1}</div>
						<div class="info">
							<h5>${place.careTitle}</h5>
							<p class="addr">${place.address1} ${place.address2}</p>
							<p class="price">${place.price}원</p>
						</div>
					`;
					
					li.addEventListener('mouseover', () => {
        				// LatLng(pos) 대신 마커 객체(marker)를 전달
       				 showInfo(marker, place.careTitle); 
        				map.panTo(pos);
    					});
					
					li.addEventListener('mouseout', () => infowindow.close());

					li.addEventListener('click', () => {
						const detailPanel = document.getElementById('detailPanel');
						const detailContent = document.getElementById('detailContent');
						
						detailContent.innerHTML = `
						<button id="closeDetail" class="btn-close" aria-label="Close"></button>
						<strong style="font-size : 25px">${place.careTitle}</strong>
						<p style="font-size : 20px"><strong>작성자:</strong> ${place.authorNickname}</p>
						<p style="font-size : 20px"><strong>주소:</strong> ${place.address1} ${place.address2}</p>
						<p style="font-size : 20px"><strong>가격:</strong> ${place.price}원</p>
						<p style="font-size : 20px"><strong>내용:</strong> ${place.careContent}</p>
						
						<div style="margin-top: 20px; text-align: right;">
							<a href="/care/modify/${place.careSeq}" class="btn btn-fatcat" style="font-size : 20px">수정</a>
							<form action="/care/delete/${place.careSeq}" method="post" style="display:inline;">
								<button type="submit" class="btn btn-fatcat" style="font-size : 20px" onclick="return confirm('정말로 삭제하시겠습니까?');">삭제</button>
							</form>
							<button class="btn btn-fatcat" style="font-size : 20px" onclick="openChatPopup(${place.authorUserSeq})">채팅하기</button>
						</div>
						`;
					
						
						
						detailPanel.classList.add('show');

						if (!originalCenter) originalCenter = map.getCenter();
						map.panBy(-detailPanel.offsetWidth / 2, 0);

						document.getElementById('closeDetail').onclick = () => {
							detailPanel.classList.remove('show');
							map.panTo(originalCenter || map.getCenter());
							openedPlaceId = null;
						};
					});
					
					$placesList.appendChild(li);
				});

				renderPagination();

				if (document.getElementById('map').style.display !== 'none' && allPlaces.length > 0) {
					const bounds = new kakao.maps.LatLngBounds();
					allPlaces.forEach(p => bounds.extend(new kakao.maps.LatLng(p.latitude, p.longitude)));
					map.setBounds(bounds, 20);
				}
			}

			function renderPagination() {
				$pagination.innerHTML = '';
				const totalPages = Math.ceil(allPlaces.length / pageSize);
				for (let i = 1; i <= totalPages; i++) {
					const a = document.createElement('a');
					a.href = '#';
					a.textContent = i;
					if (i === currentPage)
						a.className = 'on';
					else
						a.addEventListener('click', e => {
							e.preventDefault();
							currentPage = i;
							renderList();
						});
					$pagination.appendChild(a);
				}
			}

			// 수정된 showInfo 함수 (첫 번째 인수로 마커 객체를 받음)
			function showInfo(marker, title) {
			    if (!map) return;
			    infowindow.setContent('<div style="padding:5px;font-size:13px;">' + title + '</div>');
			    // LatLng 대신 마커 객체를 전달합니다.
			    infowindow.open(map, marker); 
			}
			
			function toggleListView() {
				const mapDiv = document.getElementById('map');
				const btn = document.getElementById('btn');
				const menuWrap = document.getElementById('menu_wrap');

				if (mapDiv.style.display !== 'none') {
					mapDiv.style.display = 'none';
					btn.innerText = '지도랑 같이 보기';
					$placesList.style.display = 'grid';
					$placesList.style.gridTemplateColumns = 'repeat(3,1fr)';
					$placesList.style.gap = '10px';
					pageSize = 15;
					currentPage = 1;
					menuWrap.style.flex = '1';
					renderList();
				} else {
					mapDiv.style.display = 'block';
					btn.innerText = '리스트만 보기';
					kakao.maps.event.trigger(map, 'resize');
					$placesList.style.display = 'block';
					$placesList.style.gridTemplateColumns = 'none';
					$placesList.style.gap = '0';
					pageSize = 7;
					currentPage = 1;
					menuWrap.style.flex = '0.5';
					kakao.maps.event.trigger(map, 'resize');
					renderList();
				}
			}
			
		
			function openChatPopup(authorUserSeq) {
			    if (!authorUserSeq) {
			        alert("채팅 상대방 정보가 없습니다.");
			        return;
			    }
			    
			    const url = `/chat/start?receiverSeq=${authorUserSeq}`;
			    
			    const width = 600;
			    const height = 800;
			    const left = (window.innerWidth / 2) - (width / 2);
			    const top = (window.innerHeight / 2) - (height / 2);
			    const options = `width=${width},height=${height},left=${left},top=${top},scrollbars=yes,resizable=yes`;
			    
			    window.open(url, "chatPopup", options);
			}
		</script>
	</div>
</body>
</html>