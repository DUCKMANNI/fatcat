<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{shared/layout}">
<head>
<meta charset="utf-8">
<title>ëŒë´„ì„œë¹„ìŠ¤</title>
<style>
#controls {
	background: rgba(255, 255, 255, 0.96);
	border: 1px solid #ddd;
	border-radius: 14px;
	padding: 10px 14px;
	display: flex;
	gap: 8px;
	align-items: center;
	margin: 20px auto;
	width: fit-content;
	box-shadow: 0 2px 8px rgba(0, 0, 0, 0.12);
}

#controls select {
	height: 36px;
	font-size: 20px;
	border-radius: 8px;
	border: 1px solid #ccc;
	padding: 0 10px;
}

/* #controls button {
	cursor: pointer;
	border: none;
	background: #CD853F;
	color: #fff;
	font-weight: 600;
} */
#mapListContainer {
	display: flex;
	width: calc(100% - 20px);
	height: 80vh;
	margin: 20px 15px 0;
	gap: 16px;
	box-sizing: border-box;
}

#map, #menu_wrap, #detailPanel {
	transition: all 0.3s ease;
}

#map {
	flex: 0.9;
	height: 100%;
	border: 1px solid #e5e5e5;
	border-radius: 24px;
	position: relative;
	box-shadow: 0 2px 8px rgba(0, 0, 0, 0.12);
}

#menu_wrap {
	flex: 0.5;
	background: rgba(255, 255, 255, 0.96);
	border-radius: 24px;
	padding: 8px;
	font-size: 14px;
	overflow-y: auto;
	box-shadow: 0 2px 8px rgba(0, 0, 0, 0.12);
}

#menu_wrap h3 {
	margin: 6px 8px 10px;
	font-size: 16px;
}

#placesList {
	margin: 0;
	padding: 0 6px 8px;
}

#placesList li {
	list-style: none;
}

#placesList .item {
	display: flex;
	align-items: flex-start;
	padding: 10px;
	border-bottom: 1px solid #ddd;
	cursor: pointer;
}

#placesList .marker-number {
	width: 23px;
	height: 23px;
	display: flex;
	align-items: center;
	justify-content: center;
	background: #D2B48C;
	color: white;
	border-radius: 20px;
	font-size: 13px;
	font-weight: bold;
	margin-right: 10px;
	flex-shrink: 0;
}

#placesList .info {
	flex: 1;
}

#placesList .info h5 {
	margin: 0 0 4px;
	font-size: 20px;
	font-weight: bold;
}

#placesList .info p {
	margin: 2px 0;
	font-size: 18px;
	color: #555;
}

#pagination {
	text-align: center;
	padding: 6px 0 10px;
}

#pagination a {
	display: inline-block;
	margin: 0 6px;
	text-decoration: none;
	color: #666;
}

#pagination .on {
	font-weight: 700;
	color: #6C3C30;
	pointer-events: none;
}

.fixed-element button {
	display: block !important;
}

/* ìƒì„¸ì°½ */
#detailPanel {
	flex: 0;
	width: 0;
	padding: 0;
	overflow: hidden;
	background: #fff;
	border-radius: 24px;
	box-shadow: -4px 0 8px rgba(0, 0, 0, 0.1);
}

#detailPanel.show {
	flex: 0.8;
	width: 300px;
	padding: 10px;
}

#detailPanel #closeDetail {
	float: right;
	background: white;
	border: none;
	cursor: pointer;
	color: black;
}

.btn-group .btn {
	border-radius: 5px;
	padding: 8px 12px;
}

/* .btn-warning {
    background-color: #ffc107;
    color: #212529;
    border: 1px solid #ffc107;
}*/
.btn-outline-danger {
	font-size: 16px;
	border-radius: 999px;
	background-color: transparent;
	color: #dc3545;
	border: 2px solid #dc3545;
	transition: all 0.3s ease;
}

.btn-outline-danger:hover {
	color: white;
	background-color: #dc3545;
	border-color: #dc3545;
}

.btn-outline-brown {
	font-size: 16px;
	border: 2px solid #8B4513;
	border-radius: 999px;
	color: #8B4513; /* ê¸€ììƒ‰: ìƒˆë“¤ ë¸Œë¼ìš´ */
	border-color: #8B4513; /* í…Œë‘ë¦¬ìƒ‰ */
	background-color: transparent; /* ë°°ê²½ íˆ¬ëª… */
	transition: all 0.3s ease; /* ë¶€ë“œëŸ¬ìš´ ì „í™˜ íš¨ê³¼ */
}

.btn-outline-brown:hover {
	color: white;
	background-color: #8B4513;
}

.btn-darkbrown {
	font-size: 16px;
	border-radius: 999px;
	padding: 6px 16px;
	border: none;
	color: white;
	background-color: #9a7f5a;
	transition: all 0.3s ease;
}

.btn-darkbrown:hover {
	background-color: #524538;
	color: #fff;
	border: none;
}
</style>

</head>
<body th:data-logged-in-user-seq="${loggedInUserSeq}">
	<div layout:fragment="content">
		<script
			src="//dapi.kakao.com/v2/maps/sdk.js?appkey=4c15890a040537b9e018efed80761b21&libraries=services"></script>

		<div id="controls" style="font-size: 20px;">
			<label>ì‹œ/ë„<select id="sido" class="m-1"
				style="font-size: 18px;"></select></label> <label>ì‹œ/êµ°/êµ¬<select
				id="sigungu" class="m-1" style="font-size: 18px;"></select></label> <label>ë™<select
				id="dong" class="m-1" style="font-size: 18px;"></select></label>
			<button id="searchBtn" class="btn btn-fatcat"
				style="font-size: 20px;">ê²€ìƒ‰</button>
			<button id="btn" class="btn btn-fatcat" style="font-size: 20px;"
				onclick='toggleListView()'>ë¦¬ìŠ¤íŠ¸ë§Œë³´ê¸°</button>

			<button id="createBtn"
				th:data-auth="${#authorization.expression('isAuthenticated()')}"
				class="btn btn-darkbrown" style="font-size: 20px;">ëŒë´„ê¸€ ë“±ë¡</button>


		</div>

		<div id="mapListContainer">
			<div id="map"></div>
			<div id="menu_wrap">
				<h3 style="font-size: 25px">ëŒë´„ì„œë¹„ìŠ¤ êµ¬ì¸ ëª©ë¡</h3>
				<ul id="placesList"></ul>
				<div id="pagination"></div>
			</div>
			<div id="detailPanel">
				<button id="closeDetail">x</button>
				<div id="detailContent"></div>
			</div>
		</div>

<script>
    let REGION_DATA = {}, allPlaces = [], currentPage = 1, pageSize = 7;
    let openedPlaceId = null, originalCenter = null;
    let userLocationMarker = null;

    const markers = [];
    const $sido = document.getElementById('sido');
    const $sigungu = document.getElementById('sigungu');
    const $dong = document.getElementById('dong');
    const $searchBtn = document.getElementById('searchBtn');
    const $placesList = document.getElementById('placesList');
    const $pagination = document.getElementById('pagination');
    
    const geocoder = new kakao.maps.services.Geocoder();

    const map = new kakao.maps.Map(document.getElementById('map'), {
        center : new kakao.maps.LatLng(37.566826, 126.9786567),
        level : 5
    });
    
    const infowindow = new kakao.maps.InfoWindow({zIndex:1});
    
    // ğŸ’¡ HTML body íƒœê·¸ì˜ data ì†ì„±ì—ì„œ ë¡œê·¸ì¸ UserSeqë¥¼ ì½ì–´ì™€ ì „ì—­ ë³€ìˆ˜ë¡œ ì €ì¥ (null ë˜ëŠ” ìˆ«ì)
    const $body = document.querySelector('body');
    const LOGGED_IN_USER_SEQ = parseInt($body.dataset.loggedInUserSeq) || null; 
    
    document.getElementById('createBtn').addEventListener('click', function() {
        const isAuthenticated = this.dataset.auth === 'true';

        if (!isAuthenticated) {
            alert("ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.");
            window.location.href = "/users/login";
            return;
        }

        window.location.href = "/care/create";
    });
    
    

    window.addEventListener('DOMContentLoaded', () => {
        fetch('/data/korea_map_info.txt')
            .then(res => res.text())
            .then(text => {
                parseCSV(text);
                fillSido();
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            const lat = position.coords.latitude;
                            const lon = position.coords.longitude;
                            
                            displayUserLocation(lat, lon);
                            reverseGeocode(lat, lon);
                        },
                        (error) => {
                            console.error("ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.", error);
                            fetchCareList();
                        }
                    );
                } else {
                    console.error("ì´ ë¸Œë¼ìš°ì €ì—ì„œëŠ” Geolocationì´ ì§€ì›ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
                    fetchCareList();
                }
            })
            .catch(err => console.error('CSV ì½ê¸° ì‹¤íŒ¨', err));
    });
    
    // í˜„ì¬ ìœ„ì¹˜ ë§ˆì»¤ í‘œì‹œ í•¨ìˆ˜
    function displayUserLocation(lat, lon) {
        const pos = new kakao.maps.LatLng(lat, lon);
        
        if (userLocationMarker) {
            userLocationMarker.setMap(null);
        }

        userLocationMarker = new kakao.maps.Marker({
            position: pos,
            map: map,
        });

        map.setCenter(pos);
        
        
    }

    function parseCSV(csvText) {
        REGION_DATA = {};
        csvText.split('\n').slice(1).forEach(line => {
            const [ sido, sigungu, dong ] = line.split(',').map(s => s.trim());
            if (!sido || !sigungu || !dong)
                return;
            REGION_DATA[sido] = REGION_DATA[sido] || {};
            REGION_DATA[sido][sigungu] = REGION_DATA[sido][sigungu] || [];
            REGION_DATA[sido][sigungu].push(dong);
        });
    }

    function fillSido() {
        $sido.innerHTML = '<option value="">ì‹œ/ë„ ì„ íƒ</option>';
        Object.keys(REGION_DATA).forEach(sd => $sido.innerHTML += `<option value="${sd}">${sd}</option>`);
        $sigungu.innerHTML = '<option value="">ì‹œ/êµ°/êµ¬ ì„ íƒ</option>';
        $dong.innerHTML = '<option value="">ë™ ì„ íƒ</option>';
    }
    function fillSigungu() {
        const sd = $sido.value;
        $sigungu.innerHTML = '<option value="">ì‹œ/êµ°/êµ¬ ì„ íƒ</option>';
        $dong.innerHTML = '<option value="">ë™ ì„ íƒ</option>';
        if (!sd)
            return;
        Object.keys(REGION_DATA[sd]).forEach(gu => $sigungu.innerHTML += `<option value="${gu}">${gu}</option>`);
    }
    function fillDong() {
        const sd = $sido.value, gu = $sigungu.value;
        $dong.innerHTML = '<option value="">ë™ ì„ íƒ</option>';
        if (!sd || !gu)
            return;
        REGION_DATA[sd][gu].forEach(d => $dong.innerHTML += `<option value="${d}">${d}</option>`);
    }
    $sido.addEventListener('change', fillSigungu);
    $sigungu.addEventListener('change', fillDong);

    function clearMarkers() {
        // CustomOverlayì™€ ë§ˆì»¤ ëª¨ë‘ ì œê±°
        markers.forEach(m => {
            m.overlay.setMap(null); // CustomOverlay (í•€ ì´ë¯¸ì§€+ë²ˆí˜¸) ì œê±°
            m.marker.setMap(null);  // íˆ¬ëª… ë§ˆì»¤ ì œê±°
        });
        markers.length = 0;
    }
    function clearList() {
        $placesList.innerHTML = '';
    }
    function buildRegionText() {
        return [ $sido.value, $sigungu.value, $dong.value ].filter(Boolean).join(' ');
    }
    
    // reverseGeocode í•¨ìˆ˜
    function reverseGeocode(lat, lon) {
        const coord = new kakao.maps.LatLng(lat, lon);
        
        if (!geocoder) { 
            console.error("Geocoder ê°ì²´ê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
            fetchCareList();
            return;
        }

        geocoder.coord2RegionCode(coord.getLng(), coord.getLat(), (result, status) => {
            if (status === kakao.maps.services.Status.OK) {
                const regionInfo = result.find(item => item.region_type === 'H');
                
                if (regionInfo) {
                    const { region_1depth_name, region_2depth_name, region_3depth_name } = regionInfo;
                    
                    $sido.value = region_1depth_name;
                    fillSigungu();
                    $sigungu.value = region_2depth_name;
                    fillDong(); 
                    
                    const dongList = REGION_DATA[region_1depth_name] ? REGION_DATA[region_1depth_name][region_2depth_name] : null;
                    const matchedDong = dongList ? dongList.find(d => region_3depth_name.includes(d) || d.includes(region_3depth_name)) : null;

                    if (matchedDong) {
                        $dong.value = matchedDong;
                    } else {
                        console.warn(`"${region_3depth_name}"ì— í•´ë‹¹í•˜ëŠ” ë™ì´ ë°ì´í„°ì— ì—†ê±°ë‚˜ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.`);
                    }
                    
                    fetchCareList();
                } else {
                    console.warn("í–‰ì •ë™ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì „ì²´ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.");
                    fetchCareList();
                }
            } else {
                console.error("ì£¼ì†Œ ë³€í™˜ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. Status:", status);
                fetchCareList();
            }
        });
    }

    function fetchCareList() {
        const region = buildRegionText();
        const url = `/care/list?region=${encodeURIComponent(region)}`;

        fetch(url)
            .then(response => {
                if (!response.ok) {
                    throw new Error('ë„¤íŠ¸ì›Œí¬ ì‘ë‹µì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                }
                return response.json();
            })
            .then(data => {
                allPlaces = data;
                currentPage = 1;

                if (allPlaces.length === 0) {
                    // ê²½ê³ ì°½ ë„ìš°ê¸°
                    alert(`${region} ì— í•´ë‹¹í•˜ëŠ” ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.`);

                    // ì§€ë„ ìœ„ì¹˜ ì´ë™
                    const geocoder = new kakao.maps.services.Geocoder();
                    geocoder.addressSearch(region, (result, status) => {
                        if (status === kakao.maps.services.Status.OK) {
                            const coords = new kakao.maps.LatLng(result[0].y, result[0].x);
                            map.setCenter(coords); // ì§€ë„ ì´ë™
                        }
                    });
                }

                renderList();
            })
            .catch(error => console.error('ê²Œì‹œê¸€ ëª©ë¡ì„ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤:', error));
    }

    $searchBtn.addEventListener('click', fetchCareList);

    function addMarker(pos, idx) {
        
        // 1. ì‹œê°ì ìœ¼ë¡œ ë³´ì´ëŠ” Custom Overlay (í•€ ì´ë¯¸ì§€ + ë²ˆí˜¸)
        const visualContent = `
            <div class="custom-marker-wrap" style="position: relative; width: 50px; height: 50px; cursor: pointer;">
                <img src="/images/map_marker.png" style="width: 50px; height: 50px; display: block;">
                <div style="
                    position: absolute;
                    top: 50%;
                    left: 50%;
                    transform: translate(-66%, 0%);
                    font-size: 20px;
                    font-weight: bold;
                    color: #422701;
                    width: 25px;
                    text-align: center;
                ">${idx + 1}</div>
            </div>
        `;

        const overlay = new kakao.maps.CustomOverlay({
       	 	position: pos,
            content: visualContent,
            yAnchor: -0.1, // 1ë³´ë‹¤ í¬ê²Œ í•˜ë©´ ìœ„ë¡œ ì˜¬ë¼ê°
            xAnchor: 0.4,
            zIndex: 3
        });
        overlay.setMap(map);
        
        


        // 2. ì¸í¬ìœˆë„ìš° ì•µì»¤ ì—­í• ì„ ìœ„í•œ íˆ¬ëª… ë§ˆì»¤ ìƒì„± (size 1x1, opacity 0.0, zIndex 1ë¡œ ìˆ¨ê¹€)
        const transparentImage = new kakao.maps.MarkerImage(
            'data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==', // 1x1 íˆ¬ëª… GIF
            new kakao.maps.Size(50, 50), // ì‚¬ì´ì¦ˆ ìµœì†Œí™”
            { offset: new kakao.maps.Point(25, -7) }
        );
        
        const infowindowPos = new kakao.maps.LatLng(pos.getLat() + 0.00025, pos.getLng()-0.00003); 

        
        const marker = new kakao.maps.Marker({
            position: pos,
            map: map,
            image: transparentImage, // 1x1 íˆ¬ëª… ì´ë¯¸ì§€ ì ìš©
            opacity: 0.0, // ì™„ì „íˆ íˆ¬ëª…í•˜ê²Œ ì„¤ì • (ì•ˆì „ì„± í™•ë³´)
            zIndex: 3 // Custom Overlay ë’¤ë¡œ ìˆ¨ê¹€
        });
        
        kakao.maps.event.addListener(marker, 'mouseover', function() {
            infowindow.setContent('<div style="padding:5px;font-size:13px;">' + allPlaces[idx].careTitle + '</div>');
            infowindow.open(map, marker);
        });

        // íˆ¬ëª… ë§ˆì»¤ì— ë§ˆìš°ìŠ¤ ì•„ì›ƒ ì´ë²¤íŠ¸ë¥¼ ë“±ë¡í•©ë‹ˆë‹¤.
        kakao.maps.event.addListener(marker, 'mouseout', function() {
            infowindow.close();
        });
        
        // 4. markers ë°°ì—´ì— ì €ì¥ (ì œê±° ì‹œ CustomOverlayì™€ íˆ¬ëª… ë§ˆì»¤ ëª¨ë‘ ì œê±°)
        markers.push({ overlay, marker, pos });

        return { overlay, pos, marker };
    }


    function renderList() {
    	
    	 // ğŸ”¹ ê²€ìƒ‰ ì‹œ ì´ì „ ìƒì„¸ì°½ ë‹«ê¸°
        const detailPanel = document.getElementById('detailPanel');
        detailPanel.classList.remove('show');
        openedPlaceId = null;
        
        
        clearMarkers();
        clearList();
        
        const start = (currentPage - 1) * pageSize, end = start + pageSize;
        const pagePlaces = allPlaces.slice(start, end);

        if(pagePlaces.length === 0){
            $placesList.innerHTML = `<li style="text-align:center; padding: 20px; font-size : 20px;">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</li>`;
            $pagination.innerHTML = '';
            return;
        }

        pagePlaces.forEach((place, i) => {
            const pos = new kakao.maps.LatLng(place.latitude, place.longitude);
            const { marker } = addMarker(pos, i + start);


            // â­ ëª©ë¡ ë¦¬ìŠ¤íŠ¸ í•­ëª© ìƒì„±
            
            const formattedPrice = place.price.toLocaleString('ko-KR');
             
            const li = document.createElement('li');
            li.className = 'item';
            li.innerHTML = `
                <div class="marker-number">${i + start + 1}</div>
                <div class="info">
                    <h5>${place.careTitle}</h5>
                    <p class="addr">${place.authorNickname}</p>
                    
                    <p class="price"> ${formattedPrice} ì›</p>
                    
                    <p class="date">${place.createDate}</p>
                </div>
            `;
            
            // ë§ˆìš°ìŠ¤ ì˜¤ë²„ ì‹œ ì§€ë„ì—ì„œ ì •ë³´ ì°½ì„ í‘œì‹œ
            li.addEventListener('mouseover', () => {
                showInfo(marker, place.careTitle); 
                map.panTo(pos);
            });
            
            li.addEventListener('mouseout', () => infowindow.close());

            li.addEventListener('click', () => {
                const detailPanel = document.getElementById('detailPanel');
                const detailContent = document.getElementById('detailContent');
                
                if (openedPlaceId === place.careSeq) {
                    detailPanel.classList.remove('show');
                    openedPlaceId = null;
                } else {
                    
                    const isAuthor = LOGGED_IN_USER_SEQ && LOGGED_IN_USER_SEQ == place.userSeq;
                    
                    let actionButtons = '';
                    let chatButton = '';
                    
                    // ğŸ’¡ ë¬¸ì œ 1 í•´ê²°: ì‘ì„±ì ë³¸ì¸ì¼ ê²½ìš° ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ í‘œì‹œ
                    if (isAuthor) {
                        actionButtons = `
                            <a href="/care/modify/${place.careSeq}" class=" btn btn-outline-brown" style="font-size : 16px">ìˆ˜ì •</a>
                            <form action="/care/delete/${place.careSeq}" method="post" style="display:inline;">
                                <button type="submit" class="btn btn-outline-danger" style="font-size : 16px" onclick="return confirm('ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">ì‚­ì œ</button>
                            </form>
                        `;
                    }
                    
                    // ğŸ’¡ ë¬¸ì œ 2 í•´ê²°: ë¡œê·¸ì¸ ìƒíƒœ ì—¬ë¶€ì— ë”°ë¼ ì±„íŒ… ë²„íŠ¼ì„ ë¶„ë¦¬
                    if (LOGGED_IN_USER_SEQ && !isAuthor) {
                        // ë¡œê·¸ì¸í–ˆê³ , ì‘ì„±ì ë³¸ì¸ì´ ì•„ë‹ ê²½ìš°: ìƒëŒ€ë°© userSeqë¥¼ ë„˜ê²¨ ì±„íŒ… í™œì„±í™”
                        chatButton = `<button class="btn btn-darkbrown" style="font-size : 20px" onclick="openChatPopup(${place.userSeq})">ì±„íŒ…í•˜ê¸°</button>`;
                    } else if (!LOGGED_IN_USER_SEQ) {
                        // ë¹„ë¡œê·¸ì¸ ìƒíƒœ: userSeq ì—†ì´ openChatPopup() í˜¸ì¶œ (í•¨ìˆ˜ ë‚´ì—ì„œ ë¡œê·¸ì¸ ìœ ë„)
                        chatButton = `<button class="btn btn-darkbrown" style="font-size : 20px" onclick="openChatPopup()">ì±„íŒ…í•˜ê¸°</button>`;
                    }

                    const formattedPrice = place.price.toLocaleString('ko-KR');
                    
                    // ğŸš¨ [ìˆ˜ì •ëœ í•µì‹¬ ë¡œì§]: careContentì—ì„œ ë‚ ì§œì™€ ë‚´ìš©ì„ ë¶„ë¦¬
                    let careContentText = place.careContent || '';
                    let startDateDisplay = '';
                    let endDateDisplay = '';
                    
                    const lines = careContentText.split('\n').map(line => line.trim()).filter(line => line !== '');
                    
                    // ì‹œì‘ì¼, ì¢…ë£Œì¼ íŒ¨í„´ í™•ì¸ ë° ì¶”ì¶œ (ì²« ë‘ ì¤„ì´ ë‚ ì§œ ì •ë³´ì—¬ì•¼ í•¨)
                    if (lines.length >= 2 && lines[0].startsWith('ì‹œì‘ì¼:') && lines[1].startsWith('ì¢…ë£Œì¼:')) {
                        // **ë‚ ì§œ ì •ë³´ì—ì„œ "ì‹œì‘ì¼:" ë˜ëŠ” "ì¢…ë£Œì¼:" ë ˆì´ë¸” ì œê±°** (ì•„ë˜ HTMLì—ì„œ ë‹¤ì‹œ ë¶™ì¼ ì˜ˆì •)
                        startDateDisplay = lines[0].replace('ì‹œì‘ì¼:', '').trim(); 
                        endDateDisplay = lines[1].replace('ì¢…ë£Œì¼:', '').trim(); 
                        careContentText = lines.slice(2).join('\n'); // ë‚˜ë¨¸ì§€ ì¤„ì´ ì‹¤ì œ ë‚´ìš©
                    }
                    
                    
                 // ìƒì„¸ ë‚´ìš© êµ¬ì„±
                     detailContent.innerHTML = `
                        <button id="closeDetail" class="btn-close" aria-label="Close"></button>
                        <strong style="font-size: 25px;">${place.careTitle}</strong>
                        <p style="font-size: 20px;"><strong>ì‘ì„±ì:</strong> ${place.authorNickname}</p>
                        
                        <div class="mb-2">
                            <label class="form-label" style="font-size: 20px; font-weight: bold; color: #343a40;">ì£¼ì†Œ:</label>
                            <div style="font-size: 20px; padding: 8px 12px; border: 1px solid #ced4da; border-radius: 0.25rem; background-color: #f9f9f9;">
                                ${place.address1} ${place.address2}
                            </div>
                        </div>

                        <div class="mb-2">
                            <label class="form-label" style="font-size: 20px; font-weight: bold; color: #343a40;">ê°€ê²©:</label>
                            <div style="font-size: 20px; padding: 8px 12px; border: 1px solid #ced4da; border-radius: 0.25rem; background-color: #f9f9f9;">
                                ${formattedPrice} ì›
                            </div>
                        </div>
                        
                        <div class="mb-2">
                            <label class="form-label" style="font-size: 20px; font-weight: bold; color: #343a40;">ì‹œì‘ì¼:</label>
                            <div style="font-size: 20px; padding: 8px 12px; border: 1px solid #ced4da; border-radius: 0.25rem; background-color: #f9f9f9;">
                                ${startDateDisplay}
                            </div>
                        </div>
                        
                        <div class="mb-2">
                            <label class="form-label" style="font-size: 20px; font-weight: bold; color: #343a40;">ì¢…ë£Œì¼:</label>
                            <div style="font-size: 20px; padding: 8px 12px; border: 1px solid #ced4da; border-radius: 0.25rem; background-color: #f9f9f9;">
                                ${endDateDisplay}
                            </div>
                        </div>
                        
                        <div class="mb-2">
                            <label class="form-label" style="font-size: 20px; font-weight: bold; color: #343a40;">ë‚´ìš©:</label>
                            <div style="font-size: 20px; padding: 8px 12px; border: 1px solid #ced4da; border-radius: 0.25rem; background-color: #f9f9f9;">
                                ${careContentText}
                            </div>
                        </div>

                        <p style="font-size: 16px; margin-top: 15px; color: #6c757d; text-align: right;">
                            ì‘ì„±ì¼ì: ${place.createDate}
                        </p>
                        
                        <div style="margin-top: 20px; text-align: right;">
                            ${actionButtons}
                            ${chatButton}
                        </div>
                    `;
                    
                    
                    detailPanel.classList.add('show');
                    openedPlaceId = place.careSeq; // ğŸ’¡ í˜„ì¬ ì—´ë¦° ID ì—…ë°ì´íŠ¸

                    // 'X' ë²„íŠ¼ í´ë¦­ ì‹œ ë‹«ê¸°
                    document.getElementById('closeDetail').onclick = () => {
                        detailPanel.classList.remove('show');
                        openedPlaceId = null;
                    };
                }
            });
            
            $placesList.appendChild(li);
        });

        renderPagination();

        if (document.getElementById('map').style.display !== 'none' && allPlaces.length > 0) {
            const bounds = new kakao.maps.LatLngBounds();
            allPlaces.forEach(p => bounds.extend(new kakao.maps.LatLng(p.latitude, p.longitude)));
            map.setBounds(bounds, 50);
        }
    }

    function renderPagination() {
        $pagination.innerHTML = '';
        const totalPages = Math.ceil(allPlaces.length / pageSize);
        for (let i = 1; i <= totalPages; i++) {
            const a = document.createElement('a');
            a.href = '#';
            a.textContent = i;
            if (i === currentPage)
                a.className = 'on';
            else
                a.addEventListener('click', e => {
                    e.preventDefault();
                    currentPage = i;
                    renderList();
                });
            $pagination.appendChild(a);
        }
    }

    // showInfo í•¨ìˆ˜ (ì²« ë²ˆì§¸ ì¸ìˆ˜ë¡œ ë§ˆì»¤ ê°ì²´ë¥¼ ë°›ìŒ)
    function showInfo(marker, title) {
        if (!map) return;
        infowindow.setContent('<div style="padding:5px;font-size:13px;">' + title + '</div>');
        // ë§ˆì»¤ ê°ì²´ë¥¼ ì „ë‹¬í•˜ì—¬ b.v is not a function ì˜¤ë¥˜ í•´ê²°
        infowindow.open(map, marker); 
    }
    
    function toggleListView() {
        const mapDiv = document.getElementById('map');
        const btn = document.getElementById('btn');
        const menuWrap = document.getElementById('menu_wrap');

        if (mapDiv.style.display !== 'none') {
            mapDiv.style.display = 'none';
            btn.innerText = 'ì§€ë„ë‘ ê°™ì´ ë³´ê¸°';
            $placesList.style.display = 'grid';
            $placesList.style.gridTemplateColumns = 'repeat(3,1fr)';
            $placesList.style.gap = '10px';
            pageSize = 15;
            currentPage = 1;
            menuWrap.style.flex = '1';
            renderList();
        } else {
            mapDiv.style.display = 'block';
            btn.innerText = 'ë¦¬ìŠ¤íŠ¸ë§Œ ë³´ê¸°';
            kakao.maps.event.trigger(map, 'resize');
            $placesList.style.display = 'block';
            $placesList.style.gridTemplateColumns = 'none';
            $placesList.style.gap = '0';
            pageSize = 7;
            currentPage = 1;
            menuWrap.style.flex = '0.5';
            kakao.maps.event.trigger(map, 'resize');
            renderList();
        }
    }
    
    
    function openChatPopup(userSeq) {
        // ğŸ’¡ 1. ë¹„ë¡œê·¸ì¸ ìƒíƒœ ì²´í¬: LOGGED_IN_USER_SEQê°€ nullì´ë©´ ë¬´ì¡°ê±´ ë¡œê·¸ì¸ ìœ ë„
        if (!LOGGED_IN_USER_SEQ) {
            alert('ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.');
            window.location.href='/users/login';
            return; // ë¹„ë¡œê·¸ì¸ ì‹œ ì—¬ê¸°ì„œ ì¢…ë£Œ
        }
        
        // 2. ì±„íŒ… ìƒëŒ€ë°© ì •ë³´ ì²´í¬ (ë¡œê·¸ì¸ ìƒíƒœì´ë¯€ë¡œ proceed)
        if (!userSeq) {
            alert("ì±„íŒ… ìƒëŒ€ë°© ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.");
            return;
        }
        
        // 3. ì‘ì„±ì ë³¸ì¸ì—ê²Œ ì±„íŒ…ì„ ì‹œë„í•˜ëŠ” ê²½ìš° ì°¨ë‹¨ (ì„ íƒ ì‚¬í•­)
        if (LOGGED_IN_USER_SEQ === userSeq) {
            alert("ìì‹ ì˜ ê¸€ì—ëŠ” ì±„íŒ…ì„ ìš”ì²­í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            return;
        }

        const url = `/chat/start?senderSeq=${LOGGED_IN_USER_SEQ}&receiverSeq=${userSeq}`;
        
        const width = 700;
        const height = 900;
        const left = (window.innerWidth / 2) - (width / 2);
        const top = (window.innerHeight / 2) - (height / 2);
        const options = `width=${width},height=${height},left=${left},top=${top},scrollbars=yes,resizable=yes`;
        
        // 4. ë¡œê·¸ì¸ ìƒíƒœì´ê³  ìƒëŒ€ë°© ì •ë³´ê°€ ìˆë‹¤ë©´ íŒì—…ì°½ ì˜¤í”ˆ (ì •ìƒ ì‘ë™)
        window.open(url, "chatPopup", options);
        
    }
</script>
	</div>
</body>
</html>