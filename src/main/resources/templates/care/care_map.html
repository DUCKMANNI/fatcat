<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{shared/layout}">
<head>
<meta charset="utf-8">
<title>돌봄서비스</title>
<style>
#controls {
	background: rgba(255, 255, 255, 0.96);
	border: 1px solid #ddd;
	border-radius: 14px;
	padding: 10px 14px;
	display: flex;
	gap: 8px;
	align-items: center;
	margin: 20px auto;
	width: fit-content;
	box-shadow: 0 2px 8px rgba(0, 0, 0, 0.12);
}

#controls select {
	height: 36px;
	font-size: 20px;
	border-radius: 8px;
	border: 1px solid #ccc;
	padding: 0 10px;
}

/* #controls button {
	cursor: pointer;
	border: none;
	background: #CD853F;
	color: #fff;
	font-weight: 600;
} */
#mapListContainer {
	display: flex;
	width: calc(100% - 20px);
	height: 80vh;
	margin: 20px 15px 0;
	gap: 16px;
	box-sizing: border-box;
}

#map, #menu_wrap, #detailPanel {
	transition: all 0.3s ease;
}

#map {
	flex: 0.9;
	height: 100%;
	border: 1px solid #e5e5e5;
	border-radius: 24px;
	position: relative;
	box-shadow: 0 2px 8px rgba(0, 0, 0, 0.12);
}

#menu_wrap {
	flex: 0.5;
	background: rgba(255, 255, 255, 0.96);
	border-radius: 24px;
	padding: 8px;
	font-size: 14px;
	overflow-y: auto;
	box-shadow: 0 2px 8px rgba(0, 0, 0, 0.12);
}

#menu_wrap h3 {
	margin: 6px 8px 10px;
	font-size: 16px;
}

#placesList {
	margin: 0;
	padding: 0 6px 8px;
}

#placesList li {
	list-style: none;
}

#placesList .item {
	display: flex;
	align-items: flex-start;
	padding: 10px;
	border-bottom: 1px solid #ddd;
	cursor: pointer;
}

#placesList .marker-number {
	width: 23px;
	height: 23px;
	display: flex;
	align-items: center;
	justify-content: center;
	background: #D2B48C;
	color: white;
	border-radius: 20px;
	font-size: 13px;
	font-weight: bold;
	margin-right: 10px;
	flex-shrink: 0;
}

#placesList .info {
	flex: 1;
}

#placesList .info h5 {
	margin: 0 0 4px;
	font-size: 20px;
	font-weight: bold;
}

#placesList .info p {
	margin: 2px 0;
	font-size: 18px;
	color: #555;
}

#pagination {
	text-align: center;
	padding: 6px 0 10px;
}

#pagination a {
	display: inline-block;
	margin: 0 6px;
	text-decoration: none;
	color: #666;
}

#pagination .on {
	font-weight: 700;
	color: #6C3C30;
	pointer-events: none;
}

.fixed-element button {
	display: block !important;
}

/* 상세창 */
#detailPanel {
	flex: 0;
	width: 0;
	padding: 0;
	overflow: hidden;
	background: #fff;
	border-radius: 24px;
	box-shadow: -4px 0 8px rgba(0, 0, 0, 0.1);
}

#detailPanel.show {
	flex: 0.8;
	width: 300px;
	padding: 10px;
}

#detailPanel #closeDetail {
	float: right;
	background: white;
	border: none;
	cursor: pointer;
	color: black;
}

.btn-group .btn {
	border-radius: 5px;
	padding: 8px 12px;
}

/* .btn-warning {
    background-color: #ffc107;
    color: #212529;
    border: 1px solid #ffc107;
}*/
.btn-outline-danger {
	font-size: 16px;
	border-radius: 999px;
	background-color: transparent;
	color: #dc3545;
	border: 2px solid #dc3545;
	transition: all 0.3s ease;
}

.btn-outline-danger:hover {
	color: white;
	background-color: #dc3545;
	border-color: #dc3545;
}

.btn-outline-brown {
	font-size: 16px;
	border: 2px solid #8B4513;
	border-radius: 999px;
	color: #8B4513; /* 글자색: 새들 브라운 */
	border-color: #8B4513; /* 테두리색 */
	background-color: transparent; /* 배경 투명 */
	transition: all 0.3s ease; /* 부드러운 전환 효과 */
}

.btn-outline-brown:hover {
	color: white;
	background-color: #8B4513;
}

.btn-darkbrown {
	font-size: 16px;
	border-radius: 999px;
	padding: 6px 16px;
	border: none;
	color: white;
	background-color: #9a7f5a;
	transition: all 0.3s ease;
}

.btn-darkbrown:hover {
	background-color: #524538;
	color: #fff;
	border: none;
}
</style>

</head>
<body th:data-logged-in-user-seq="${loggedInUserSeq}">
	<div layout:fragment="content">
		<script
			src="//dapi.kakao.com/v2/maps/sdk.js?appkey=4c15890a040537b9e018efed80761b21&libraries=services"></script>

		<div id="controls" style="font-size: 20px;">
			<label>시/도<select id="sido" class="m-1"
				style="font-size: 18px;"></select></label> <label>시/군/구<select
				id="sigungu" class="m-1" style="font-size: 18px;"></select></label> <label>동<select
				id="dong" class="m-1" style="font-size: 18px;"></select></label>
			<button id="searchBtn" class="btn btn-fatcat"
				style="font-size: 20px;">검색</button>
			<button id="btn" class="btn btn-fatcat" style="font-size: 20px;"
				onclick='toggleListView()'>리스트만보기</button>

			<button id="createBtn"
				th:data-auth="${#authorization.expression('isAuthenticated()')}"
				class="btn btn-darkbrown" style="font-size: 20px;">돌봄글 등록</button>


		</div>

		<div id="mapListContainer">
			<div id="map"></div>
			<div id="menu_wrap">
				<h3 style="font-size: 25px">돌봄서비스 구인 목록</h3>
				<ul id="placesList"></ul>
				<div id="pagination"></div>
			</div>
			<div id="detailPanel">
				<button id="closeDetail">x</button>
				<div id="detailContent"></div>
			</div>
		</div>

<script>
    let REGION_DATA = {}, allPlaces = [], currentPage = 1, pageSize = 7;
    let openedPlaceId = null, originalCenter = null;
    let userLocationMarker = null;

    const markers = [];
    const $sido = document.getElementById('sido');
    const $sigungu = document.getElementById('sigungu');
    const $dong = document.getElementById('dong');
    const $searchBtn = document.getElementById('searchBtn');
    const $placesList = document.getElementById('placesList');
    const $pagination = document.getElementById('pagination');
    
    const geocoder = new kakao.maps.services.Geocoder();

    const map = new kakao.maps.Map(document.getElementById('map'), {
        center : new kakao.maps.LatLng(37.566826, 126.9786567),
        level : 5
    });
    
    const infowindow = new kakao.maps.InfoWindow({zIndex:1});
    
    // 💡 HTML body 태그의 data 속성에서 로그인 UserSeq를 읽어와 전역 변수로 저장 (null 또는 숫자)
    const $body = document.querySelector('body');
    const LOGGED_IN_USER_SEQ = parseInt($body.dataset.loggedInUserSeq) || null; 
    
    document.getElementById('createBtn').addEventListener('click', function() {
        const isAuthenticated = this.dataset.auth === 'true';

        if (!isAuthenticated) {
            alert("로그인 후 이용 가능합니다.");
            window.location.href = "/users/login";
            return;
        }

        window.location.href = "/care/create";
    });
    
    

    window.addEventListener('DOMContentLoaded', () => {
        fetch('/data/korea_map_info.txt')
            .then(res => res.text())
            .then(text => {
                parseCSV(text);
                fillSido();
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            const lat = position.coords.latitude;
                            const lon = position.coords.longitude;
                            
                            displayUserLocation(lat, lon);
                            reverseGeocode(lat, lon);
                        },
                        (error) => {
                            console.error("위치 정보를 가져오는 데 실패했습니다.", error);
                            fetchCareList();
                        }
                    );
                } else {
                    console.error("이 브라우저에서는 Geolocation이 지원되지 않습니다.");
                    fetchCareList();
                }
            })
            .catch(err => console.error('CSV 읽기 실패', err));
    });
    
    // 현재 위치 마커 표시 함수
    function displayUserLocation(lat, lon) {
        const pos = new kakao.maps.LatLng(lat, lon);
        
        if (userLocationMarker) {
            userLocationMarker.setMap(null);
        }

        userLocationMarker = new kakao.maps.Marker({
            position: pos,
            map: map,
        });

        map.setCenter(pos);
        
        
    }

    function parseCSV(csvText) {
        REGION_DATA = {};
        csvText.split('\n').slice(1).forEach(line => {
            const [ sido, sigungu, dong ] = line.split(',').map(s => s.trim());
            if (!sido || !sigungu || !dong)
                return;
            REGION_DATA[sido] = REGION_DATA[sido] || {};
            REGION_DATA[sido][sigungu] = REGION_DATA[sido][sigungu] || [];
            REGION_DATA[sido][sigungu].push(dong);
        });
    }

    function fillSido() {
        $sido.innerHTML = '<option value="">시/도 선택</option>';
        Object.keys(REGION_DATA).forEach(sd => $sido.innerHTML += `<option value="${sd}">${sd}</option>`);
        $sigungu.innerHTML = '<option value="">시/군/구 선택</option>';
        $dong.innerHTML = '<option value="">동 선택</option>';
    }
    function fillSigungu() {
        const sd = $sido.value;
        $sigungu.innerHTML = '<option value="">시/군/구 선택</option>';
        $dong.innerHTML = '<option value="">동 선택</option>';
        if (!sd)
            return;
        Object.keys(REGION_DATA[sd]).forEach(gu => $sigungu.innerHTML += `<option value="${gu}">${gu}</option>`);
    }
    function fillDong() {
        const sd = $sido.value, gu = $sigungu.value;
        $dong.innerHTML = '<option value="">동 선택</option>';
        if (!sd || !gu)
            return;
        REGION_DATA[sd][gu].forEach(d => $dong.innerHTML += `<option value="${d}">${d}</option>`);
    }
    $sido.addEventListener('change', fillSigungu);
    $sigungu.addEventListener('change', fillDong);

    function clearMarkers() {
        // CustomOverlay와 마커 모두 제거
        markers.forEach(m => {
            m.overlay.setMap(null); // CustomOverlay (핀 이미지+번호) 제거
            m.marker.setMap(null);  // 투명 마커 제거
        });
        markers.length = 0;
    }
    function clearList() {
        $placesList.innerHTML = '';
    }
    function buildRegionText() {
        return [ $sido.value, $sigungu.value, $dong.value ].filter(Boolean).join(' ');
    }
    
    // reverseGeocode 함수
    function reverseGeocode(lat, lon) {
        const coord = new kakao.maps.LatLng(lat, lon);
        
        if (!geocoder) { 
            console.error("Geocoder 객체가 초기화되지 않았습니다.");
            fetchCareList();
            return;
        }

        geocoder.coord2RegionCode(coord.getLng(), coord.getLat(), (result, status) => {
            if (status === kakao.maps.services.Status.OK) {
                const regionInfo = result.find(item => item.region_type === 'H');
                
                if (regionInfo) {
                    const { region_1depth_name, region_2depth_name, region_3depth_name } = regionInfo;
                    
                    $sido.value = region_1depth_name;
                    fillSigungu();
                    $sigungu.value = region_2depth_name;
                    fillDong(); 
                    
                    const dongList = REGION_DATA[region_1depth_name] ? REGION_DATA[region_1depth_name][region_2depth_name] : null;
                    const matchedDong = dongList ? dongList.find(d => region_3depth_name.includes(d) || d.includes(region_3depth_name)) : null;

                    if (matchedDong) {
                        $dong.value = matchedDong;
                    } else {
                        console.warn(`"${region_3depth_name}"에 해당하는 동이 데이터에 없거나 일치하지 않습니다.`);
                    }
                    
                    fetchCareList();
                } else {
                    console.warn("행정동 정보를 찾을 수 없습니다. 전체 목록을 불러옵니다.");
                    fetchCareList();
                }
            } else {
                console.error("주소 변환에 실패했습니다. Status:", status);
                fetchCareList();
            }
        });
    }

    function fetchCareList() {
        const region = buildRegionText();
        const url = `/care/list?region=${encodeURIComponent(region)}`;

        fetch(url)
            .then(response => {
                if (!response.ok) {
                    throw new Error('네트워크 응답이 올바르지 않습니다.');
                }
                return response.json();
            })
            .then(data => {
                allPlaces = data;
                currentPage = 1;

                if (allPlaces.length === 0) {
                    // 경고창 띄우기
                    alert(`${region} 에 해당하는 검색 결과가 없습니다.`);

                    // 지도 위치 이동
                    const geocoder = new kakao.maps.services.Geocoder();
                    geocoder.addressSearch(region, (result, status) => {
                        if (status === kakao.maps.services.Status.OK) {
                            const coords = new kakao.maps.LatLng(result[0].y, result[0].x);
                            map.setCenter(coords); // 지도 이동
                        }
                    });
                }

                renderList();
            })
            .catch(error => console.error('게시글 목록을 가져오는 데 실패했습니다:', error));
    }

    $searchBtn.addEventListener('click', fetchCareList);

    function addMarker(pos, idx) {
        
        // 1. 시각적으로 보이는 Custom Overlay (핀 이미지 + 번호)
        const visualContent = `
            <div class="custom-marker-wrap" style="position: relative; width: 50px; height: 50px; cursor: pointer;">
                <img src="/images/map_marker.png" style="width: 50px; height: 50px; display: block;">
                <div style="
                    position: absolute;
                    top: 50%;
                    left: 50%;
                    transform: translate(-66%, 0%);
                    font-size: 20px;
                    font-weight: bold;
                    color: #422701;
                    width: 25px;
                    text-align: center;
                ">${idx + 1}</div>
            </div>
        `;

        const overlay = new kakao.maps.CustomOverlay({
       	 	position: pos,
            content: visualContent,
            yAnchor: -0.1, // 1보다 크게 하면 위로 올라감
            xAnchor: 0.4,
            zIndex: 3
        });
        overlay.setMap(map);
        
        


        // 2. 인포윈도우 앵커 역할을 위한 투명 마커 생성 (size 1x1, opacity 0.0, zIndex 1로 숨김)
        const transparentImage = new kakao.maps.MarkerImage(
            'data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==', // 1x1 투명 GIF
            new kakao.maps.Size(50, 50), // 사이즈 최소화
            { offset: new kakao.maps.Point(25, -7) }
        );
        
        const infowindowPos = new kakao.maps.LatLng(pos.getLat() + 0.00025, pos.getLng()-0.00003); 

        
        const marker = new kakao.maps.Marker({
            position: pos,
            map: map,
            image: transparentImage, // 1x1 투명 이미지 적용
            opacity: 0.0, // 완전히 투명하게 설정 (안전성 확보)
            zIndex: 3 // Custom Overlay 뒤로 숨김
        });
        
        kakao.maps.event.addListener(marker, 'mouseover', function() {
            infowindow.setContent('<div style="padding:5px;font-size:13px;">' + allPlaces[idx].careTitle + '</div>');
            infowindow.open(map, marker);
        });

        // 투명 마커에 마우스 아웃 이벤트를 등록합니다.
        kakao.maps.event.addListener(marker, 'mouseout', function() {
            infowindow.close();
        });
        
        // 4. markers 배열에 저장 (제거 시 CustomOverlay와 투명 마커 모두 제거)
        markers.push({ overlay, marker, pos });

        return { overlay, pos, marker };
    }


    function renderList() {
    	
    	 // 🔹 검색 시 이전 상세창 닫기
        const detailPanel = document.getElementById('detailPanel');
        detailPanel.classList.remove('show');
        openedPlaceId = null;
        
        
        clearMarkers();
        clearList();
        
        const start = (currentPage - 1) * pageSize, end = start + pageSize;
        const pagePlaces = allPlaces.slice(start, end);

        if(pagePlaces.length === 0){
            $placesList.innerHTML = `<li style="text-align:center; padding: 20px; font-size : 20px;">검색 결과가 없습니다.</li>`;
            $pagination.innerHTML = '';
            return;
        }

        pagePlaces.forEach((place, i) => {
            const pos = new kakao.maps.LatLng(place.latitude, place.longitude);
            const { marker } = addMarker(pos, i + start);


            // ⭐ 목록 리스트 항목 생성
            
            const formattedPrice = place.price.toLocaleString('ko-KR');
             
            const li = document.createElement('li');
            li.className = 'item';
            li.innerHTML = `
                <div class="marker-number">${i + start + 1}</div>
                <div class="info">
                    <h5>${place.careTitle}</h5>
                    <p class="addr">${place.authorNickname}</p>
                    
                    <p class="price"> ${formattedPrice} 원</p>
                    
                    <p class="date">${place.createDate}</p>
                </div>
            `;
            
            // 마우스 오버 시 지도에서 정보 창을 표시
            li.addEventListener('mouseover', () => {
                showInfo(marker, place.careTitle); 
                map.panTo(pos);
            });
            
            li.addEventListener('mouseout', () => infowindow.close());

            li.addEventListener('click', () => {
                const detailPanel = document.getElementById('detailPanel');
                const detailContent = document.getElementById('detailContent');
                
                if (openedPlaceId === place.careSeq) {
                    detailPanel.classList.remove('show');
                    openedPlaceId = null;
                } else {
                    
                    const isAuthor = LOGGED_IN_USER_SEQ && LOGGED_IN_USER_SEQ == place.userSeq;
                    
                    let actionButtons = '';
                    let chatButton = '';
                    
                    // 💡 문제 1 해결: 작성자 본인일 경우 수정/삭제 버튼 표시
                    if (isAuthor) {
                        actionButtons = `
                            <a href="/care/modify/${place.careSeq}" class=" btn btn-outline-brown" style="font-size : 16px">수정</a>
                            <form action="/care/delete/${place.careSeq}" method="post" style="display:inline;">
                                <button type="submit" class="btn btn-outline-danger" style="font-size : 16px" onclick="return confirm('정말로 삭제하시겠습니까?');">삭제</button>
                            </form>
                        `;
                    }
                    
                    // 💡 문제 2 해결: 로그인 상태 여부에 따라 채팅 버튼을 분리
                    if (LOGGED_IN_USER_SEQ && !isAuthor) {
                        // 로그인했고, 작성자 본인이 아닐 경우: 상대방 userSeq를 넘겨 채팅 활성화
                        chatButton = `<button class="btn btn-darkbrown" style="font-size : 20px" onclick="openChatPopup(${place.userSeq})">채팅하기</button>`;
                    } else if (!LOGGED_IN_USER_SEQ) {
                        // 비로그인 상태: userSeq 없이 openChatPopup() 호출 (함수 내에서 로그인 유도)
                        chatButton = `<button class="btn btn-darkbrown" style="font-size : 20px" onclick="openChatPopup()">채팅하기</button>`;
                    }

                    const formattedPrice = place.price.toLocaleString('ko-KR');
                    
                    // 🚨 [수정된 핵심 로직]: careContent에서 날짜와 내용을 분리
                    let careContentText = place.careContent || '';
                    let startDateDisplay = '';
                    let endDateDisplay = '';
                    
                    const lines = careContentText.split('\n').map(line => line.trim()).filter(line => line !== '');
                    
                    // 시작일, 종료일 패턴 확인 및 추출 (첫 두 줄이 날짜 정보여야 함)
                    if (lines.length >= 2 && lines[0].startsWith('시작일:') && lines[1].startsWith('종료일:')) {
                        // **날짜 정보에서 "시작일:" 또는 "종료일:" 레이블 제거** (아래 HTML에서 다시 붙일 예정)
                        startDateDisplay = lines[0].replace('시작일:', '').trim(); 
                        endDateDisplay = lines[1].replace('종료일:', '').trim(); 
                        careContentText = lines.slice(2).join('\n'); // 나머지 줄이 실제 내용
                    }
                    
                    
                 // 상세 내용 구성
                     detailContent.innerHTML = `
                        <button id="closeDetail" class="btn-close" aria-label="Close"></button>
                        <strong style="font-size: 25px;">${place.careTitle}</strong>
                        <p style="font-size: 20px;"><strong>작성자:</strong> ${place.authorNickname}</p>
                        
                        <div class="mb-2">
                            <label class="form-label" style="font-size: 20px; font-weight: bold; color: #343a40;">주소:</label>
                            <div style="font-size: 20px; padding: 8px 12px; border: 1px solid #ced4da; border-radius: 0.25rem; background-color: #f9f9f9;">
                                ${place.address1} ${place.address2}
                            </div>
                        </div>

                        <div class="mb-2">
                            <label class="form-label" style="font-size: 20px; font-weight: bold; color: #343a40;">가격:</label>
                            <div style="font-size: 20px; padding: 8px 12px; border: 1px solid #ced4da; border-radius: 0.25rem; background-color: #f9f9f9;">
                                ${formattedPrice} 원
                            </div>
                        </div>
                        
                        <div class="mb-2">
                            <label class="form-label" style="font-size: 20px; font-weight: bold; color: #343a40;">시작일:</label>
                            <div style="font-size: 20px; padding: 8px 12px; border: 1px solid #ced4da; border-radius: 0.25rem; background-color: #f9f9f9;">
                                ${startDateDisplay}
                            </div>
                        </div>
                        
                        <div class="mb-2">
                            <label class="form-label" style="font-size: 20px; font-weight: bold; color: #343a40;">종료일:</label>
                            <div style="font-size: 20px; padding: 8px 12px; border: 1px solid #ced4da; border-radius: 0.25rem; background-color: #f9f9f9;">
                                ${endDateDisplay}
                            </div>
                        </div>
                        
                        <div class="mb-2">
                            <label class="form-label" style="font-size: 20px; font-weight: bold; color: #343a40;">내용:</label>
                            <div style="font-size: 20px; padding: 8px 12px; border: 1px solid #ced4da; border-radius: 0.25rem; background-color: #f9f9f9;">
                                ${careContentText}
                            </div>
                        </div>

                        <p style="font-size: 16px; margin-top: 15px; color: #6c757d; text-align: right;">
                            작성일자: ${place.createDate}
                        </p>
                        
                        <div style="margin-top: 20px; text-align: right;">
                            ${actionButtons}
                            ${chatButton}
                        </div>
                    `;
                    
                    
                    detailPanel.classList.add('show');
                    openedPlaceId = place.careSeq; // 💡 현재 열린 ID 업데이트

                    // 'X' 버튼 클릭 시 닫기
                    document.getElementById('closeDetail').onclick = () => {
                        detailPanel.classList.remove('show');
                        openedPlaceId = null;
                    };
                }
            });
            
            $placesList.appendChild(li);
        });

        renderPagination();

        if (document.getElementById('map').style.display !== 'none' && allPlaces.length > 0) {
            const bounds = new kakao.maps.LatLngBounds();
            allPlaces.forEach(p => bounds.extend(new kakao.maps.LatLng(p.latitude, p.longitude)));
            map.setBounds(bounds, 50);
        }
    }

    function renderPagination() {
        $pagination.innerHTML = '';
        const totalPages = Math.ceil(allPlaces.length / pageSize);
        for (let i = 1; i <= totalPages; i++) {
            const a = document.createElement('a');
            a.href = '#';
            a.textContent = i;
            if (i === currentPage)
                a.className = 'on';
            else
                a.addEventListener('click', e => {
                    e.preventDefault();
                    currentPage = i;
                    renderList();
                });
            $pagination.appendChild(a);
        }
    }

    // showInfo 함수 (첫 번째 인수로 마커 객체를 받음)
    function showInfo(marker, title) {
        if (!map) return;
        infowindow.setContent('<div style="padding:5px;font-size:13px;">' + title + '</div>');
        // 마커 객체를 전달하여 b.v is not a function 오류 해결
        infowindow.open(map, marker); 
    }
    
    function toggleListView() {
        const mapDiv = document.getElementById('map');
        const btn = document.getElementById('btn');
        const menuWrap = document.getElementById('menu_wrap');

        if (mapDiv.style.display !== 'none') {
            mapDiv.style.display = 'none';
            btn.innerText = '지도랑 같이 보기';
            $placesList.style.display = 'grid';
            $placesList.style.gridTemplateColumns = 'repeat(3,1fr)';
            $placesList.style.gap = '10px';
            pageSize = 15;
            currentPage = 1;
            menuWrap.style.flex = '1';
            renderList();
        } else {
            mapDiv.style.display = 'block';
            btn.innerText = '리스트만 보기';
            kakao.maps.event.trigger(map, 'resize');
            $placesList.style.display = 'block';
            $placesList.style.gridTemplateColumns = 'none';
            $placesList.style.gap = '0';
            pageSize = 7;
            currentPage = 1;
            menuWrap.style.flex = '0.5';
            kakao.maps.event.trigger(map, 'resize');
            renderList();
        }
    }
    
    
    function openChatPopup(userSeq) {
        // 💡 1. 비로그인 상태 체크: LOGGED_IN_USER_SEQ가 null이면 무조건 로그인 유도
        if (!LOGGED_IN_USER_SEQ) {
            alert('로그인 후 이용 가능합니다.');
            window.location.href='/users/login';
            return; // 비로그인 시 여기서 종료
        }
        
        // 2. 채팅 상대방 정보 체크 (로그인 상태이므로 proceed)
        if (!userSeq) {
            alert("채팅 상대방 정보가 없습니다.");
            return;
        }
        
        // 3. 작성자 본인에게 채팅을 시도하는 경우 차단 (선택 사항)
        if (LOGGED_IN_USER_SEQ === userSeq) {
            alert("자신의 글에는 채팅을 요청할 수 없습니다.");
            return;
        }

        const url = `/chat/start?senderSeq=${LOGGED_IN_USER_SEQ}&receiverSeq=${userSeq}`;
        
        const width = 700;
        const height = 900;
        const left = (window.innerWidth / 2) - (width / 2);
        const top = (window.innerHeight / 2) - (height / 2);
        const options = `width=${width},height=${height},left=${left},top=${top},scrollbars=yes,resizable=yes`;
        
        // 4. 로그인 상태이고 상대방 정보가 있다면 팝업창 오픈 (정상 작동)
        window.open(url, "chatPopup", options);
        
    }
</script>
	</div>
</body>
</html>