<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{shared/layout}">
<head>
<meta charset="utf-8">
<title>ë™ë¬¼ë³‘ì› ê²€ìƒ‰</title>
<style>
/* CSS ìŠ¤íƒ€ì¼ */
#controls {
	background: rgba(255, 255, 255, 0.96);
	border: 1px solid #ddd;
	border-radius: 14px;
	padding: 10px 14px;
	display: flex;
	gap: 8px;
	align-items: center;
	margin: 20px auto;
	width: fit-content;
	box-shadow: 0 2px 8px rgba(0, 0, 0, 0.12);
	
}

#controls select {
	height: 36px;
	font-size: 20px;
	border-radius: 8px;
	border: 1px solid #ccc;
	margin: 5px auto;
	padding: 0 10px;
}
/* #controls button {
            cursor: pointer;
            border: none;
            background: #CD853F;
            color: #fff;
            font-weight: 600;
        } */
#mapListContainer {
	display: flex;
	width: calc(100% - 20px);
	height: 80vh;
	margin: 20px 15px 0;
	gap: 16px;
	box-sizing: border-box;
}

#map, #menu_wrap, #detailPanel {
	transition: all 0.3s ease;
}

#map {
	flex: 0.9;
	height: 100%;
	border: 1px solid #e5e5e5;
	border-radius: 24px;
	position: relative;
	box-shadow: 0 0 8px rgba(0, 0, 0, 0.12);
}

#menu_wrap {
	flex: 0.5;
	background: rgba(255, 255, 255, 0.96);
	border-radius: 24px;
	padding: 8px;
	font-size: 14px;
	overflow-y: auto;
	box-shadow: 0 2px 8px rgba(0, 0, 0, 0.12);
}

#menu_wrap h3 {
	margin: 6px 8px 10px;
	font-size: 16px;
}

#placesList {
	margin: 0;
	padding: 0 6px 8px;
}

#placesList li {
	list-style: none;
}

#placesList .item {
	display: flex;
	align-items: flex-start;
	padding: 10px;
	border-bottom: 1px solid #ddd;
	cursor: pointer;
}

#placesList .marker-number {
	width: 23px;
	height: 23px;
	display: flex;
	align-items: center;
	justify-content: center;
	background: #D2B48C;
	color: white;
	border-radius: 20px;
	font-size: 13px;
	font-weight: bold;
	margin-right: 10px;
	flex-shrink: 0;
}

#placesList .info {
	flex: 1;
}

#placesList .info h5 {
	margin: 0 0 4px;
	font-size: 20px;
	font-weight: bold;
}

#placesList .info p {
	margin: 2px 0;
	font-size: 18px;
	color: #555;
}

#pagination {
	text-align: center;
	padding: 6px 0 10px;
}

#pagination a {
	display: inline-block;
	margin: 0 6px;
	text-decoration: none;
	color: #666;
}

#pagination .on {
	font-weight: 700;
	color: #6C3C30;
	pointer-events: none;
}
/* .fixed-element button {
            display: block !important;
        } */
#detailPanel {
	flex: 0;
	width: 0;
	padding: 0;
	overflow-y: auto;
	background: #fff;
	border-radius: 24px;
	box-shadow: -4px 0 8px rgba(0, 0, 0, 0.1);
	transition: all 0.3s ease;
}

#detailPanel.show {
	flex: 0.7;
	width: 300px;
	padding: 10px;
}

#detailPanel #closeDetail {
	float: right;
	background: white;
	border: none;
	cursor: pointer;
	color: black;
}

#reviewForm {
	display: flex;
	flex-direction: column;
	gap: 10px;
	padding: 15px;
	border: 1px solid #eee;
	border-radius: 10px;
	background: #f9f9f9;
}

#reviewForm label {
	/* font-weight: bold; */
	font-size: 15px;
}

#reviewForm textarea {
	width: 100%;
	border-radius: 10px;
	box-sizing: border-box;
	resize: vertical;
}
/* #reviewForm textarea, */
/* #reviewForm button {
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #ccc;
            font-size: 14px;
        }
        #reviewForm button {
            background-color: #CD853F;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
        }
        #reviewForm button:hover {
            background-color: #b87a37;
        } */
.star-rating {
	display: inline-block;
}

.star-rating .star {
	cursor: pointer;
	color: #ccc;
	font-size: 24px;
}

.star-rating .star.selected, .star-rating .star.hovered {
	color: #FFD700;
}

.review-actions {
	margin-top: 5px;
	text-align: right;
}
/* .review-actions button {
            background: #eee;
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 2px 6px;
            font-size: 12px;
            cursor: pointer;
        } */
.update-form {
	display: flex;
	flex-direction: column;
	gap: 8px;
	padding: 10px;
	border: 1px solid #ddd;
	border-radius: 8px;
	margin-top: 10px;
    /* ìˆ˜ì • ëª¨ë“œì—ì„œëŠ” flexë¡œ ë³´ì—¬ì§€ê³ , í‰ìƒì‹œì—ëŠ” JSì—ì„œ display: none ì²˜ë¦¬ */
}

.update-form textarea {
	border: 1px solid #ccc;
	padding: 5px;
	border-radius: 4px;
	width: 100%;
	box-sizing: border-box;
	resize: vertical;
}

/* ğŸ’¡ ì¶”ê°€: ì €ì¥/ì·¨ì†Œ ë²„íŠ¼ ìŠ¤íƒ€ì¼ì„ ê¸°ì¡´ ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ ìŠ¤íƒ€ì¼ê³¼ ë§ì¶¤ */
.save-btn, .cancel-btn {
	font-size: 16px;
	border-radius: 999px;
	padding: 5px 8px;
	transition: all 0.3s ease;
	cursor: pointer;
   
}

/* ì €ì¥ ë²„íŠ¼ ìŠ¤íƒ€ì¼ (ê¸°ì¡´ .edit-btn ê¸°ë°˜) */
.save-btn {
	border: 2px solid #8B4513; /* ë…¹ìƒ‰ ê³„ì—´ */
	color: #8B4513;
	background-color: transparent;
}
.save-btn:hover {
	color: white;
	background-color: #8B4513;
}

/* ì·¨ì†Œ ë²„íŠ¼ ìŠ¤íƒ€ì¼ (ê¸°ì¡´ .delete-btn ê¸°ë°˜) */
.cancel-btn {
	border: 2px solid #dc3545; /* ë¹¨ê°„ìƒ‰ ê³„ì—´ */
	color: #dc3545;
	background-color: transparent;
}
.cancel-btn:hover {
	color: white;
	background-color: #dc3545;
}


/* ê¸°ì¡´ .btn-fatcat ìŠ¤íƒ€ì¼ì„ .edit-btn ë° .delete-btnì— ì ìš© */
.delete-btn {
	font-size: 16px;
	border-radius: 999px;
	padding: 5px 8px;
	background-color: transparent;
	color: #dc3545;
	border: 2px solid #dc3545;
	transition: all 0.3s ease;
	cursor: pointer;
}
/* í˜¸ë²„ íš¨ê³¼ ì ìš© */
.delete-btn:hover {
	color: white;
	background-color: #dc3545;
	border-color: #dc3545;
}

.edit-btn {
	font-size: 16px;
	border: 2px solid #8B4513;
	padding: 5px 8px;
	border-radius: 999px;
	color: #8B4513; /* ê¸€ììƒ‰: ìƒˆë“¤ ë¸Œë¼ìš´ */
	background-color: transparent; /* ë°°ê²½ íˆ¬ëª… */
	transition: all 0.3s ease; /* ë¶€ë“œëŸ¬ìš´ ì „í™˜ íš¨ê³¼ */
	cursor: pointer;
}

/* í˜¸ë²„ íš¨ê³¼ ì ìš© */
.edit-btn:hover {
	color: white;
	background-color: #8B4513;
}

/* ë²„íŠ¼ì´ ë“¤ì–´ìˆëŠ” ë¶€ëª¨ ì˜ì—­ì˜ font-size: 20px ë•Œë¬¸ì— ë²„íŠ¼ì´ ì»¤ì§€ëŠ” ê²ƒì„ ë°©ì§€ */
.review-actions button {
	font-size: 0.75em; /* ë¶€ëª¨ í¬ê¸°ì˜ 75%ë¡œ ì„¤ì • (ì•½ 15px) */
}
</style>
</head>
<body th:data-logged-in-user-seq="${loggedInUserSeq}">
	<div layout:fragment="content">
		<script
			src="//dapi.kakao.com/v2/maps/sdk.js?appkey=4c15890a040537b9e018efed80761b21&libraries=services"></script>

		<div id="controls" style="font-size: 20px;">
			<label>ì‹œ/ë„<select id="sido" class="m-1"
				style="font-size: 18px;"></select></label> <label>ì‹œ/êµ°/êµ¬<select
				id="sigungu" class="m-1" style="font-size: 18px;"></select></label> <label>ë™<select
				id="dong" class="m-1" style="font-size: 18px;"></select></label>
			<button id="searchBtn" class="btn btn-fatcat"
				style="font-size: 20px;">ê²€ìƒ‰</button>
			<button id="btn" class="btn btn-fatcat " style="font-size: 20px;"
				onclick='toggleListView()'>ë¦¬ìŠ¤íŠ¸ë§Œë³´ê¸°</button>
		</div>

		<div id="mapListContainer">
			<div id="map"></div>
			<div id="menu_wrap">
				<h3 style="font-size: 25px">ë™ë¬¼ë³‘ì› ê²€ìƒ‰ ê²°ê³¼</h3>
				<ul id="placesList"></ul>
				<div id="pagination"></div>
			</div>
			<div id="detailPanel">
				<button id="closeDetail">x</button>
				<div id="detailContent"></div>
			</div>
		</div>

		<script>
let REGION_DATA = {}, allPlaces = [], currentPage = 1, pageSize = 7, maxItems = 45;
let openedPlaceId = null, originalCenter = null;
let userLocationMarker = null; // ì‚¬ìš©ì ìœ„ì¹˜ ë§ˆì»¤ ë³€ìˆ˜ ì¶”ê°€

const markers = [];
const geocoder = new kakao.maps.services.Geocoder();

const $sido = document.getElementById('sido');
const $sigungu = document.getElementById('sigungu');
const $dong = document.getElementById('dong');
const $searchBtn = document.getElementById('searchBtn');
const $placesList = document.getElementById('placesList');
const $pagination = document.getElementById('pagination');

//ğŸ”¹ ë¡œê·¸ì¸ ì‚¬ìš©ì SEQ ì•ˆì „í•˜ê²Œ ê°€ì ¸ì˜¤ê¸°
const $body = document.querySelector('body');

let LOGGED_IN_USER_SEQ = null;

if ($body.dataset.loggedInUserSeq) {
    const seq = parseInt($body.dataset.loggedInUserSeq, 10);
    if (!isNaN(seq) && seq > 0) {
        LOGGED_IN_USER_SEQ = seq;
    }
}
const map = new kakao.maps.Map(document.getElementById('map'), {
    center: new kakao.maps.LatLng(37.566826, 126.9786567),
    level: 5
});
    const ps = new kakao.maps.services.Places();
    const infowindow = new kakao.maps.InfoWindow({zIndex: 1});

    window.addEventListener('DOMContentLoaded', () => {
        fetch('/data/korea_map_info.txt')
            .then(res => res.text())
            .then(text => { 
                parseCSV(text); 
                fillSido(); 
                
                // ğŸ’¡ Geolocation ì‚¬ìš© ë¡œì§ì„ DOMContentLoaded ì‹œì ì— ì‹¤í–‰
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        pos => {
                            const lat = pos.coords.latitude;
                            const lon = pos.coords.longitude;
                            const loc = new kakao.maps.LatLng(lat, lon);

                            displayUserLocation(lat, lon); // ì‚¬ìš©ì ìœ„ì¹˜ ë§ˆì»¤ í‘œì‹œ

                            // ğŸ“Œ ë“œë¡­ë‹¤ìš´ ìë™ ì±„ìš°ê¸°
                            reverseGeocode(lat, lon);

                            // ğŸ“Œ í˜„ì¬ ìœ„ì¹˜ ê¸°ì¤€ ë³‘ì› ê²€ìƒ‰ ì‹¤í–‰
                            searchNearbyHospitals(loc);
                        },
                        err => console.warn("ìœ„ì¹˜ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨", err)
                    );
                }
            })
            .catch(err => console.error('CSV ì½ê¸° ì‹¤íŒ¨', err));
    });

    function parseCSV(csvText) {
        REGION_DATA = {};
        csvText.split('\n').slice(1).forEach(line => {
            const [sido, sigungu, dong] = line.split(',').map(s => s.trim());
            if (!sido || !sigungu || !dong) return;
            REGION_DATA[sido] = REGION_DATA[sido] || {};
            REGION_DATA[sido][sigungu] = REGION_DATA[sido][sigungu] || [];
            REGION_DATA[sido][sigungu].push(dong);
        });
    }

    function fillSido() {
        $sido.innerHTML = '<option value="">ì‹œ/ë„ ì„ íƒ</option>';
        Object.keys(REGION_DATA).forEach(sd => $sido.innerHTML += `<option value="${sd}">${sd}</option>`);
        $sigungu.innerHTML = '<option value="">ì‹œ/êµ°/êµ¬ ì„ íƒ</option>';
        $dong.innerHTML = '<option value="">ë™ ì„ íƒ</option>';
    }

    function fillSigungu() {
        const sd = $sido.value;
        $sigungu.innerHTML = '<option value="">ì‹œ/êµ°/êµ¬ ì„ íƒ</option>';
        $dong.innerHTML = '<option value="">ë™ ì„ íƒ</option>';
        if (!sd) return;
        Object.keys(REGION_DATA[sd]).forEach(gu => $sigungu.innerHTML += `<option value="${gu}">${gu}</option>`);
    }

    function fillDong() {
        const sd = $sido.value, gu = $sigungu.value;
        $dong.innerHTML = '<option value="">ë™ ì„ íƒ</option>';
        if (!sd || !gu) return;
        REGION_DATA[sd][gu].forEach(d => $dong.innerHTML += `<option value="${d}">${d}</option>`);
    }

    $sido.addEventListener('change', fillSigungu);
    $sigungu.addEventListener('change', fillDong);

    function clearMarkers() {
        markers.forEach(m => {
            m.marker.setMap(null);
            m.overlay.setMap(null);
        });
        markers.length = 0;
    }
    
    // í˜„ì¬ ìœ„ì¹˜ ë§ˆì»¤ í‘œì‹œ í•¨ìˆ˜
    function displayUserLocation(lat, lon) {
        const pos = new kakao.maps.LatLng(lat, lon);
        
        if (userLocationMarker) {
            userLocationMarker.setMap(null);
        }

        userLocationMarker = new kakao.maps.Marker({
            position: pos,
            map: map,
        });

        map.setCenter(pos);
    }

    function clearList() {
        $placesList.innerHTML = '';
    }

    function buildRegionText() {
        return [$sido.value, $sigungu.value, $dong.value].filter(Boolean).join(' ');
    }

    function reverseGeocode(lat, lon) {
        geocoder.coord2RegionCode(lon, lat, (result, status) => {
            if (status === kakao.maps.services.Status.OK) {
                const region = result.find(r => r.region_type === "H"); // í–‰ì •ë™ ë‹¨ìœ„

                if (region) {
                    const sido = region.region_1depth_name;
                    const sigungu = region.region_2depth_name;
                    const dong = region.region_3depth_name;

                    // 1) ì‹œ/ë„ ì„ íƒ
                    $sido.value = sido;
                    fillSigungu();

                    // 2) ì‹œ/êµ°/êµ¬ ì„ íƒ
                    $sigungu.value = sigungu;
                    fillDong();

                    // 3) ë™ ì„ íƒ
                    if ([...$dong.options].some(opt => opt.value === dong)) {
                        $dong.value = dong;
                    }
                }
            }
        });
    }


    function searchHospitals() {
    	
    	// â­ [ì¶”ê°€ ì‹œì‘] ê²€ìƒ‰ ë²„íŠ¼ í´ë¦­ ì‹œ ìƒì„¸ íŒ¨ë„ì„ ë‹«ëŠ” ë¡œì§
        const detailPanel = document.getElementById('detailPanel');
        if (detailPanel.classList.contains('show')) {
            detailPanel.classList.remove('show');
            // íŒ¨ë„ì´ ë‹«íˆë©´ì„œ ì—´ë ¤ìˆë˜ ì¥ì†Œ IDë¥¼ ì´ˆê¸°í™”í•©ë‹ˆë‹¤.
            openedPlaceId = null; 
        }
        // â­ [ì¶”ê°€ ë]
        
        if (!$sido.value || !$sigungu.value) {
            alert('ì‹œ/ë„ì™€ ì‹œ/êµ°/êµ¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
            return;
        }
        const keyword = buildRegionText() + ' ë™ë¬¼ë³‘ì›';
        allPlaces = [];
        currentPage = 1;
        const getPlaces = (page = 1) => {
            ps.keywordSearch(keyword, (data, status, pagination) => {
                if (status === kakao.maps.services.Status.OK) {
                    allPlaces = allPlaces.concat(data);
                    if (page < 3 && pagination.hasNextPage) {
                        pagination.nextPage();
                    } else {
                        renderList();
                    }
                } else if (status === kakao.maps.services.Status.ZERO_RESULT) {
                    clearMarkers();
                    clearList();
                    $pagination.innerHTML = '';
                    alert('ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.');
                } else {
                    alert('ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            }, {
                size: 15,
                page
            });
        }
        getPlaces();
    }
    $searchBtn.addEventListener('click', searchHospitals);

    function searchNearbyHospitals(loc) {
        allPlaces = [];
        currentPage = 1;
        ps.keywordSearch("ë™ë¬¼ë³‘ì›", (data, status) => {
            if (status === kakao.maps.services.Status.OK) {
                allPlaces = data;
                renderList();
            } else if (status === kakao.maps.services.Status.ZERO_RESULT) {
                clearMarkers();
                clearList();
                $pagination.innerHTML = '';
                alert('ë‚´ ìœ„ì¹˜ ì£¼ë³€ì— ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.');
            }
        }, {
            location: loc,
            radius: 500,
            size: 15
        });
    }

    function addMarker(pos, idx,  title = "ì´ë¦„ ì—†ìŒ") {
        const marker = new kakao.maps.Marker({
            position: pos,
            map: map,
            image: new kakao.maps.MarkerImage("/images/map_marker.png", new kakao.maps.Size(50, 50))
        });
        const overlay = new kakao.maps.CustomOverlay({
            position: pos,
            content: `<div style="
		                position: absolute;
		                top: 50%;
		                left: 50%;
		                transform: translate(-64%, -80%);
		                font-size: 20px;
		                font-weight: bold;
		                color: #422701;
		                width: 25px;
		                text-align: center;
		            ">${idx + 1}</div>`,
      
        });
        overlay.setMap(map);
        
        // ğŸ“Œ ë§ˆì»¤ì— ë§ˆìš°ìŠ¤ ì˜¬ë ¸ì„ ë•Œ infoWindow ë³´ì´ê²Œ
        kakao.maps.event.addListener(marker, "mouseover", () => {
            showInfo(marker, title);
        });
        kakao.maps.event.addListener(marker, "mouseout", () => {
            infowindow.close();
        });
        
        markers.push({
            marker,
            overlay
        });
        return {
            marker,
            overlay
        };
    }

    function renderList() {
        clearMarkers();
        clearList();
        const start = (currentPage - 1) * pageSize,
            end = start + pageSize;
        const pagePlaces = allPlaces.slice(start, end);

        pagePlaces.forEach((place, i) => {
            const pos = new kakao.maps.LatLng(place.y, place.x);
            const {
                marker
            } = addMarker(pos, i + start, place.place_name);

            const li = document.createElement('li');
            li.className = 'item';
            li.innerHTML = `
                <div class="marker-number">${i + start + 1}</div>
                <div class="info">
                    <h5>${place.place_name}</h5>
                    <p class="addr">${place.road_address_name || place.address_name || ''}</p>
                    <p class="tel">${place.phone || ''}</p>
                </div>
            `;

            li.addEventListener('mouseover', () => {
                showInfo(marker, place.place_name);
                map.panTo(pos);
            });
            li.addEventListener('mouseout', () => infowindow.close());

            li.addEventListener('click', () => {
                const detailPanel = document.getElementById('detailPanel');
                if (openedPlaceId === place.id) {
                    detailPanel.classList.remove('show');
                    map.panTo(originalCenter || map.getCenter());
                    openedPlaceId = null;
                    return;
                }
                
                const detailContent = document.getElementById('detailContent');
                detailContent.innerHTML = `
                    <button id="closeDetail" class="btn-close" aria-label="Close"></button>
                    <div id="clinicInfo" style="font-size : 20px">
                			<strong style="font-size : 25px">${place.place_name}</strong>
                        <p>ì£¼ì†Œ:${place.road_address_name || place.address_name}</p>
                        <p>ì „í™”:${place.phone || 'ì •ë³´ ì—†ìŒ'}</p>
                    </div>
                    <hr>
                    <div id="reviewSection">
                        <div id="ratingInfo">
                            <h5 ><strong>í‰ì </strong>: <span id="avgRating">...</span></h5>
                        </div>
                        <hr>
                        <strong style="font-size : 25px;">ë¦¬ë·° ì‘ì„±í•˜ê¸°</strong>
                        <form id="reviewForm">
                            <input type="hidden" id="placeNameInput" name="placeName" value="${place.place_name}">
                            <input type="hidden" id="addressInput" name="address" value="${place.address_name || place.road_address_name}">
                            
                            <div class="form-group" >
                                <label style="font-size : 20px;" >ë³„ì :</label>
                                <div id="ratingStars" class="star-rating">
                                    <span class="star" data-rating="1">â˜…</span>
                                    <span class="star" data-rating="2">â˜…</span>
                                    <span class="star" data-rating="3">â˜…</span>
                                    <span class="star" data-rating="4">â˜…</span>
                                    <span class="star" data-rating="5">â˜…</span>
                                </div>
                                <input type="hidden" id="ratingInput" name="rating" required>
                            </div>
                            
                            <div class="form-group">
                                <label style="font-size : 20px;">ë¦¬ë·°:</label>
                                <textarea id="reviewContentInput" name="reviewContent" rows="3" class="form-control" required></textarea>
                            </div>
                            
                            <button type="submit" class="btn btn-fatcat" style="font-size : 20px;">ë¦¬ë·° ë“±ë¡</button>
                        </form>
                        <hr>
                        <div id="reviewList">
                            <strong style="font-size : 25px;">ë“±ë¡ëœ ë¦¬ë·°</strong>
                            <p  style="font-size : 20px;">... ë¦¬ë·° ë¡œë”© ì¤‘ ...</p>
                        </div>
                    </div>
                `;
                
                // 'X' ë²„íŠ¼ í´ë¦­ ì‹œ ë‹«ê¸°
                document.getElementById('closeDetail').onclick = () => {
                    detailPanel.classList.remove('show');
                    map.panTo(originalCenter || map.getCenter());
                    openedPlaceId = null;
                };

                fetchReviews(place.place_name, place.address_name || place.road_address_name);
                setupStarRating();
                document.getElementById('reviewForm').addEventListener('submit', function(e) {
                    e.preventDefault();
                    const formData = new FormData(this);
                    const reviewData = {
                        placeName: formData.get('placeName'),
                        address: formData.get('address'),
                        reviewContent: formData.get('reviewContent'),
                        rating: parseInt(formData.get('rating'))
                    };
                    submitReview(reviewData);
                });

                detailPanel.classList.add('show');
                if (!originalCenter) originalCenter = map.getCenter();
                map.panBy(-detailPanel.offsetWidth / 2, 0);
                openedPlaceId = place.id;
            });
            $placesList.appendChild(li);
        });


        renderPagination();

        // â­ [ìˆ˜ì •] ì§€ë„ ê²½ê³„ ì„¤ì • ë¡œì§: í˜„ì¬ í˜ì´ì§€ì˜ ë§ˆì»¤ë“¤ì„ ê¸°ì¤€ìœ¼ë¡œ ì§€ë„ ê²½ê³„ë¥¼ ì„¤ì •
        if (document.getElementById('map').style.display !== 'none' && pagePlaces.length > 0) { 
            const bounds = new kakao.maps.LatLngBounds();
            pagePlaces.forEach(p => bounds.extend(new kakao.maps.LatLng(p.y, p.x)));
            map.setBounds(bounds, 20); // 20ì€ íŒ¨ë”© ê°’
        }
    }

    function renderPagination() {
        $pagination.innerHTML = '';
        const totalPages = Math.ceil(allPlaces.length / pageSize);
        for (let i = 1; i <= totalPages; i++) {
            const a = document.createElement('a');
            a.href = '#';
            a.textContent = i;
            if (i === currentPage) a.className = 'on';
            else a.addEventListener('click', e => {
                e.preventDefault();
                currentPage = i;
                renderList();
            });
            $pagination.appendChild(a);
        }
    }

    function showInfo(marker, title) {
        infowindow.setContent('<div style="padding:5px;font-size:13px;">' + title + '</div>');
        infowindow.open(map, marker);
    }

    function toggleListView() {
        const mapDiv = document.getElementById('map');
        const btn = document.getElementById('btn');
        const menuWrap = document.getElementById('menu_wrap');
        if (mapDiv.style.display !== 'none') {
            mapDiv.style.display = 'none';
            btn.innerText = 'ì§€ë„ë‘ ê°™ì´ ë³´ê¸°';
            $placesList.style.display = 'grid';
            $placesList.style.gridTemplateColumns = 'repeat(3,1fr)';
            $placesList.style.gap = '10px';
            pageSize = 15;
            currentPage = 1;
            menuWrap.style.flex = '1';
            renderList();
        } else {
            mapDiv.style.display = 'block';
            btn.innerText = 'ë¦¬ìŠ¤íŠ¸ë§Œ ë³´ê¸°';
            kakao.maps.event.trigger(map, 'resize');
            $placesList.style.display = 'block';
            $placesList.style.gridTemplateColumns = 'none';
            $placesList.style.gap = '0';
            pageSize = 7;
            currentPage = 1;
            menuWrap.style.flex = '0.5';
            kakao.maps.event.trigger(map, 'resize');
            renderList();
        }
    }

    function setupStarRating() {
        const starsDiv = document.getElementById('ratingStars');
        starsDiv.innerHTML = 'â˜…â˜…â˜…â˜…â˜…'.split('').map((star, i) => `<span class="star" data-rating="${i+1}">${star}</span>`).join('');
        const stars = starsDiv.querySelectorAll('.star');
        const ratingInput = document.getElementById('ratingInput');
        stars.forEach(star => {
            star.addEventListener('click', function() {
                const rating = this.dataset.rating;
                ratingInput.value = rating;
                stars.forEach(s => s.classList.toggle('selected', s.dataset.rating <= rating));
            });
        });
    }
    
    async function updateReview(vetReviewSeq, newContent, newRating) {
        try {
            const response = await fetch(`/api/vet-clinics/reviews/${vetReviewSeq}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ reviewContent: newContent, rating: parseInt(newRating) })
            });
            if (response.ok) {
                // ğŸ’¡ ì„±ê³µ ì‹œ alert ëŒ€ì‹  ì»¤ìŠ¤í…€ ë©”ì‹œì§€ ì‚¬ìš© ê¶Œì¥ (í˜„ì¬ëŠ” alert ìœ ì§€)
                alert('ë¦¬ë·°ê°€ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
                // ìˆ˜ì • ì™„ë£Œ í›„, ë¦¬ìŠ¤íŠ¸ë¥¼ ë‹¤ì‹œ ë¶ˆëŸ¬ì™€ 'ì €ì¥/ì·¨ì†Œ' ë²„íŠ¼ì„ 'ìˆ˜ì •/ì‚­ì œ'ë¡œ ë³µêµ¬
                fetchReviews(document.getElementById('placeNameInput').value, document.getElementById('addressInput').value);
            } else { 
                const errorText = await response.text();
                alert(`ë¦¬ë·° ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${errorText} (ìƒíƒœì½”ë“œ: ${response.status})`); 
            }
        } catch (error) { alert('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ë¡œ ë¦¬ë·° ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'); }
    }

    async function deleteReview(vetReviewSeq) {

        if (!confirm('ì •ë§ë¡œ ì´ ë¦¬ë·°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        try {
            const response = await fetch(`/api/vet-clinics/reviews/${vetReviewSeq}`, { method: 'DELETE' });
            if (response.ok) {
                alert('ë¦¬ë·°ê°€ ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                fetchReviews(document.getElementById('placeNameInput').value, document.getElementById('addressInput').value);
            } else { 
                 const errorText = await response.text();
                 // ğŸ’¡ HTTP ìƒíƒœ ì½”ë“œ ì¶”ê°€
                 alert(`ë¦¬ë·° ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${errorText} (ìƒíƒœì½”ë“œ: ${response.status})`); 
            }
        } catch (error) { alert('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ë¡œ ë¦¬ë·° ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'); }
    }
    
    async function fetchReviews(placeName, address) {
        try {
            const params = new URLSearchParams({ placeName, address });
            const response = await fetch(`/api/vet-clinics/reviews?${params.toString()}`);
            const data = await response.json();

            // â­ [ì¶”ê°€] ìµœì‹  ë‚ ì§œ(createDate) ê¸°ì¤€ìœ¼ë¡œ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬
            if (data.reviews && data.reviews.length > 0) {
                data.reviews.sort((a, b) => new Date(b.createDate) - new Date(a.createDate));
            }
            
            const avgRatingEl = document.getElementById('avgRating');
            const reviewListEl = document.getElementById('reviewList');
            
            // ğŸ’¡ í‰ê·  í‰ì  ë³„í‘œ í‘œì‹œ ë¡œì§
            if (data.ratingAvg !== null) {
                const avgRating = parseFloat(data.ratingAvg).toFixed(1); 
                const starCount = Math.round(data.ratingAvg); 
                
                const filledStars = '<span style="color:#FFD700;">' + 'â˜…'.repeat(starCount) + '</span>';
                const emptyStars = '<span style="color:#CCCCCC;">' + 'â˜…'.repeat(5 - starCount) + '</span>';
                const starDisplay = filledStars + emptyStars;
                
                avgRatingEl.innerHTML = `${avgRating}ì  ${starDisplay} (${data.ratingCount}ëª… ì°¸ì—¬)`;
            } else {
                avgRatingEl.textContent = "ì•„ì§ í‰ì ì´ ì—†ìŠµë‹ˆë‹¤.";
            }

            reviewListEl.innerHTML = `<strong style="font-size : 25px;">ë“±ë¡ëœ ë¦¬ë·°</strong>`;

            if (data.reviews && data.reviews.length > 0) {
                data.reviews.forEach(review => {
                    // ğŸ’¡ í˜„ì¬ ë¡œê·¸ì¸ ì‚¬ìš©ìê°€ ì´ ë¦¬ë·°ì˜ ì‘ì„±ìì¸ì§€ í™•ì¸
                    const isAuthor = LOGGED_IN_USER_SEQ && LOGGED_IN_USER_SEQ === review.userSeq;

                    // ğŸ’¡ DTOì˜ 'userName' í•„ë“œë¥¼ ì‚¬ìš©í•˜ì—¬ ì‘ì„±ì ì´ë¦„ì„ í‘œì‹œ (ìµëª… ë¬¸ì œ í•´ê²°)
                    const authorName = review.userName || 'ìµëª…';
                    
                    // â­ ë²„íŠ¼ì— data-action="edit" / "delete" ì†ì„± ì¶”ê°€
                    const actionButtons = isAuthor ? `
                        <div class="review-actions d-flex justify-content-end" style="font-size : 20px; display: flex; gap: 5px;">
                            <button class="btn btn-outline-brown btn-sm edit-btn" data-action="edit" style="font-size: 16px;">ìˆ˜ì •</button>
                            <button class="btn btn-outline-danger btn-sm delete-btn" data-action="delete" style="font-size: 16px;">ì‚­ì œ</button>
                        </div>
                    ` : '';
                    
                    const reviewItem = document.createElement('div');
                    reviewItem.id = `review-${review.vetReviewSeq}`;
                    reviewItem.innerHTML = `
                        <p class="review-meta" style="font-size : 20px; color:#555555;">ì‘ì„±ì: ${authorName} | ë³„ì : ${'â˜…'.repeat(review.vetRating)}</strong> | ì‘ì„±ì¼ì: ${review.createDate}</p>
                        <p class="review-text" style="font-size : 20px;">${review.vetReview}</p>
                        
                        ${actionButtons}
                        <hr>
                    `;
                    reviewListEl.appendChild(reviewItem);

                    // ğŸ’¡ ë²„íŠ¼ì´ ìƒì„±ëœ ê²½ìš°ì—ë§Œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì—°ê²°
                    if (isAuthor) {
                        const editBtn = reviewItem.querySelector('.edit-btn');
                        const deleteBtn = reviewItem.querySelector('.delete-btn');
                        
                        // ì´ ë¦¬ìŠ¤ë„ˆëŠ” ìˆ˜ì • ëª¨ë“œ ì§„ì… ê¸°ëŠ¥ì„ ë‹´ë‹¹í•©ë‹ˆë‹¤.
                        editBtn.addEventListener('click', () => {
                             // data-actionì„ í™•ì¸í•˜ì—¬ 'ìˆ˜ì •' ëª¨ë“œì¼ ë•Œë§Œ ì§„ì…
                            if (editBtn.dataset.action === 'edit') {
                                handleUpdateReview(review.vetReviewSeq, review.vetReview, review.vetRating);
                            }
                        });
                        // ì‚­ì œ ë²„íŠ¼ ë¦¬ìŠ¤ë„ˆ
                        deleteBtn.addEventListener('click', () => {
                             // data-actionì„ í™•ì¸í•˜ì—¬ 'ì‚­ì œ' ëª¨ë“œì¼ ë•Œë§Œ ì‹¤í–‰
                             if (deleteBtn.dataset.action === 'delete') {
                                deleteReview(review.vetReviewSeq);
                             }
                        });
                    }
                });
            } else {
                reviewListEl.innerHTML += `<p  style="font-size : 20px;">ë“±ë¡ëœ ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>`;
            }
        } catch (error) {
            console.error('ë¦¬ë·° ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', error);
            document.getElementById('reviewList').innerHTML = `<p>ë¦¬ë·° ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>`;
        }
    }
    
    // â­ ë³„ì  ì„¤ì • HTMLì„ ìƒì„±í•˜ëŠ” í—¬í¼ í•¨ìˆ˜
    function createUpdateFormContent(content, rating) {
        return `
            <div class="form-group" style="font-size : 20px;">
                <label >ë³„ì :</label>
                <div class="star-rating update-stars">
                    ${'â˜…'.repeat(5).split('').map((star, i) => 
                        `<span class="star" data-rating="${i+1}" style="color:${i+1 <= rating ? '#FFD700' : '#ccc'};">${star}</span>`
                    ).join('')}
                </div>
                <input type="hidden" class="update-rating-input" value="${rating}">
            </div>
            <div class="form-group">
                <label style="font-size : 20px;">ë‚´ìš©:</label>
                <textarea class="update-content-input form-control" style="font-size : 20px;" rows="3">${content}</textarea>
            </div>
        `;
    }

    // â­ ìˆ˜ì • í¼ì˜ ë³„ì  ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì • í•¨ìˆ˜
    function setupUpdateStarRating(formElement, initialRating) {
        const updateStars = formElement.querySelectorAll('.star-rating .star');
        const updateRatingInput = formElement.querySelector('.update-rating-input');

        // ë³„ì  í´ë¦­ ì´ë²¤íŠ¸ ì„¤ì •
        updateStars.forEach(star => {
            star.addEventListener('click', function() {
                const newRating = parseInt(this.dataset.rating);
                updateRatingInput.value = newRating;
                updateStars.forEach(s => {
                    s.style.color = parseInt(s.dataset.rating) <= newRating ? '#FFD700' : '#ccc';
                });
            });
        });
    }

    // â­ ìˆ˜ì • ëª¨ë“œë¥¼ ì¢…ë£Œí•˜ê³  ë²„íŠ¼ê³¼ ë‚´ìš©ì„ ì›ìƒ ë³µêµ¬í•˜ëŠ” í—¬í¼ í•¨ìˆ˜
    function exitUpdateMode(vetReviewSeq, originalEditHandler, originalDeleteHandler) {
        const reviewItem = document.getElementById(`review-${vetReviewSeq}`);
        const updateForm = reviewItem.querySelector('.update-form-container');
        
        // â­ [ì¶”ê°€] ìˆ¨ê²¼ë˜ ë¦¬ë·° ë‚´ìš© ë‹¤ì‹œ í‘œì‹œ
        const reviewMeta = reviewItem.querySelector('.review-meta');
        const reviewText = reviewItem.querySelector('.review-text');
        const hr = reviewItem.querySelector('hr:last-of-type');

        if (reviewMeta) reviewMeta.style.display = 'block'; 
        if (reviewText) reviewText.style.display = 'block'; 
        if (hr) hr.style.display = 'block'; 
        // â­ [ì¶”ê°€ ë]
        
        const saveBtn = reviewItem.querySelector('.review-actions button[data-action="save"]');
        const cancelBtn = reviewItem.querySelector('.review-actions button[data-action="cancel"]');
        
        // 1. í¼ ì œê±°
        if (updateForm) updateForm.remove();

    
        // 3. ë²„íŠ¼ í…ìŠ¤íŠ¸ì™€ ê¸°ëŠ¥ ë³µêµ¬ (ì €ì¥ -> ìˆ˜ì •, ì·¨ì†Œ -> ì‚­ì œ)
        
        // 'ì €ì¥' ë²„íŠ¼ì„ 'ìˆ˜ì •'ìœ¼ë¡œ ë³µêµ¬
        saveBtn.textContent = 'ìˆ˜ì •';
        saveBtn.classList.remove('save-btn');
        saveBtn.classList.add('edit-btn');
        saveBtn.dataset.action = 'edit';
        saveBtn.onclick = originalEditHandler; // ì›ë˜ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë³µêµ¬
        
        // 'ì·¨ì†Œ' ë²„íŠ¼ì„ 'ì‚­ì œ'ë¡œ ë³µêµ¬
        cancelBtn.textContent = 'ì‚­ì œ';
        cancelBtn.classList.remove('cancel-btn');
        cancelBtn.classList.add('delete-btn');
        cancelBtn.dataset.action = 'delete';
        cancelBtn.onclick = originalDeleteHandler; // ì›ë˜ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë³µêµ¬
    }


    // â­ ìˆ˜ì •ëœ handleUpdateReview í•¨ìˆ˜ (ìˆ˜ì • ëª¨ë“œ ì§„ì… ë¡œì§)
    function handleUpdateReview(vetReviewSeq, reviewContent, rating) {
        const reviewItem = document.getElementById(`review-${vetReviewSeq}`);
        const reviewText = reviewItem.querySelector('.review-text');

        // ê¸°ì¡´ì— ì—´ë ¤ìˆëŠ” í¼ì´ ìˆë‹¤ë©´ ë‹«ê¸°
        const existingForm = reviewItem.querySelector('.update-form-container');
        if(existingForm) existingForm.remove();

        // â­ [ì¶”ê°€ ì‹œì‘] ê¸°ì¡´ ë¦¬ë·° ë‚´ìš© ìˆ¨ê¸°ê¸°
        const reviewMeta = reviewItem.querySelector('.review-meta');
        const hr = reviewItem.querySelector('hr:last-of-type'); 
        
        if (reviewMeta) reviewMeta.style.display = 'none';
        if (reviewText) reviewText.style.display = 'none';
        if (hr) hr.style.display = 'none';
        // â­ [ì¶”ê°€ ë]

        const editBtn = reviewItem.querySelector('.edit-btn');
        const deleteBtn = reviewItem.querySelector('.delete-btn');
        
        // ê¸°ì¡´ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ë¥¼ ì €ì¥í•©ë‹ˆë‹¤. (exitUpdateModeì—ì„œ ë³µêµ¬í•˜ê¸° ìœ„í•¨)
        const originalEditHandler = editBtn.onclick;
        const originalDeleteHandler = deleteBtn.onclick;

      
        
        // 2. ìˆ˜ì • í¼ ìƒì„± ë° ì‚½ì…
        const updateFormContainer = document.createElement('div');
        updateFormContainer.className = 'update-form-container update-form';
        updateFormContainer.innerHTML = createUpdateFormContent(reviewContent, rating);
        
        // ğŸ’¡ ë¦¬ë·° í…ìŠ¤íŠ¸ ë°”ë¡œ ë’¤ì— í¼ ì‚½ì…
        reviewText.insertAdjacentElement('afterend', updateFormContainer);
        
        // 3. ë²„íŠ¼ í…ìŠ¤íŠ¸ì™€ ê¸°ëŠ¥ ë³€ê²½ (ìˆ˜ì • -> ì €ì¥, ì‚­ì œ -> ì·¨ì†Œ)
        
        // 3-1. 'ìˆ˜ì •' -> 'ì €ì¥' ë²„íŠ¼ìœ¼ë¡œ ë³€ê²½
        editBtn.textContent = 'ì €ì¥';
        editBtn.classList.add('save-btn');
        editBtn.classList.remove('edit-btn');
        editBtn.dataset.action = 'save'; // ì•¡ì…˜ ë³€ê²½
        
        editBtn.onclick = async () => {
            const newContent = updateFormContainer.querySelector('.update-content-input').value;
            const newRating = updateFormContainer.querySelector('.update-rating-input').value;
            
            // ì €ì¥ ë¡œì§ í˜¸ì¶œ
            try {
                // updateReviewëŠ” ì„±ê³µ ì‹œ fetchReviewsë¥¼ í˜¸ì¶œí•˜ì—¬ ë¦¬ìŠ¤íŠ¸ ì „ì²´ë¥¼ ê°±ì‹ í•©ë‹ˆë‹¤.
                // ê°±ì‹  ê³¼ì •ì—ì„œ ë²„íŠ¼ì˜ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆê°€ fetchReviewsì—ì„œ ë‹¤ì‹œ ì„¤ì •ë˜ì–´ ë³µêµ¬ë©ë‹ˆë‹¤.
                await updateReview(vetReviewSeq, newContent, newRating);
            } catch (error) {
                // ì‹¤íŒ¨ ì‹œ ëª¨ë“œ ìœ ì§€ (ì‚¬ìš©ìê°€ ìˆ˜ì •í•  ìˆ˜ ìˆë„ë¡)
                console.error("ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:", error);
            }
        };

        // 3-2. 'ì‚­ì œ' -> 'ì·¨ì†Œ' ë²„íŠ¼ìœ¼ë¡œ ë³€ê²½
        deleteBtn.textContent = 'ì·¨ì†Œ';
        deleteBtn.classList.add('cancel-btn');
        deleteBtn.classList.remove('delete-btn');
        deleteBtn.dataset.action = 'cancel'; // ì•¡ì…˜ ë³€ê²½
        
        deleteBtn.onclick = () => {
            // ì·¨ì†Œ ë¡œì§ í˜¸ì¶œ: ì›ë³¸ í•¸ë“¤ëŸ¬ë¥¼ ì „ë‹¬í•˜ì—¬ ë³µêµ¬
            exitUpdateMode(vetReviewSeq, originalEditHandler, originalDeleteHandler);
        };

        // 4. ë³„ì  ì„¤ì • ë° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì—°ê²°
        setupUpdateStarRating(updateFormContainer, rating);
    }
    
    async function submitReview(reviewData) {
        if (LOGGED_IN_USER_SEQ === null) {
            alert('ë¦¬ë·° ì‘ì„±ì€ ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.');
            return;
        }
        try {
            const response = await fetch('/api/vet-clinics/reviews', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(reviewData)
            });
            if (response.ok) {
                alert('ë¦¬ë·°ê°€ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
                document.getElementById('reviewContentInput').value = '';
                document.getElementById('ratingInput').value = '';
                document.querySelectorAll('#ratingStars .star').forEach(s => s.classList.remove('selected'));
                fetchReviews(reviewData.placeName, reviewData.address);
            } else { 
                const errorText = await response.text();
                alert(`ë¦¬ë·° ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (ìƒíƒœì½”ë“œ: ${response.status}): ${errorText}`); 
            }
        } catch (error) { 
            console.error(error);
            alert('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ë¡œ ë¦¬ë·° ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'); 
        }
    }
</script>
	</div>
</body>
</html>